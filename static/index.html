<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Conformidade ANAC - Aeroportos</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ANAC Color Palette - Professional ERP Design */
        :root {
            --anac-primary: #003366;        /* Azul escuro ANAC */
            --anac-primary-dark: #002244;    /* Azul mais escuro */
            --anac-primary-light: #0066CC;   /* Azul m√©dio */
            --anac-accent: #004488;          /* Azul accent */
            --anac-bg-light: #E6F2FF;        /* Background azul claro */
            --anac-gray-50: #F8F9FA;         /* Cinza muito claro */
            --anac-gray-100: #F1F3F5;        /* Cinza claro */
            --anac-gray-200: #E4E7EB;        /* Cinza m√©dio claro */
            --anac-gray-300: #CBD5E1;         /* Cinza m√©dio */
            --anac-gray-600: #64748B;        /* Cinza escuro */
            --anac-gray-700: #475569;        /* Cinza mais escuro */
            --anac-gray-900: #1E293B;        /* Cinza quase preto */
            --anac-success: #059669;         /* Verde sucesso */
            --anac-warning: #D97706;         /* Laranja aviso */
            --anac-error: #DC2626;           /* Vermelho erro */
            --anac-info: #0284C7;            /* Azul informa√ß√£o */
            --white: #FFFFFF;
            --shadow-sm: 0 1px 2px 0 rgba(0, 51, 102, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 51, 102, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 51, 102, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--anac-gray-50);
            min-height: 100vh;
            color: var(--anac-gray-900);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 0;
        }
        
        /* Professional Header with ANAC Branding */
        header {
            background: var(--white);
            border-bottom: 4px solid var(--anac-primary);
            padding: 24px 32px;
            box-shadow: var(--shadow-md);
            margin-bottom: 0;
        }
        
        header h1 {
            color: var(--anac-primary);
            margin-bottom: 6px;
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        .subtitle {
            color: var(--anac-gray-600);
            font-size: 14px;
            font-weight: 400;
        }
        
        /* Breadcrumbs */
        .breadcrumbs {
            background: var(--white);
            border-bottom: 1px solid var(--anac-gray-200);
        }
        
        .breadcrumbs ol {
            list-style: none;
            display: flex;
            gap: 8px;
            padding: 12px 32px;
            margin: 0;
        }
        
        .breadcrumbs a {
            color: var(--anac-primary);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s ease;
        }
        
        .breadcrumbs a:hover {
            color: var(--anac-primary-light);
            text-decoration: underline;
        }
        
        /* Professional Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 24px;
            background: var(--white);
            padding: 8px;
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--anac-gray-200);
        }
        
        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            color: var(--anac-gray-600);
            transition: all 0.2s ease;
            position: relative;
        }
        
        .tab:hover {
            background: var(--anac-gray-50);
            color: var(--anac-primary);
        }
        
        .tab.active {
            background: var(--anac-primary);
            color: var(--white);
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Main Content Area */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 24px;
            padding: 24px 32px;
        }
        
        /* Professional Cards */
        .card {
            background: var(--white);
            border-radius: 8px;
            padding: 28px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--anac-gray-200);
            transition: box-shadow 0.2s ease;
        }
        
        .card:hover {
            box-shadow: var(--shadow-lg);
        }
        
        .card h2 {
            color: var(--anac-primary);
            margin-bottom: 24px;
            font-size: 20px;
            font-weight: 600;
            border-bottom: 2px solid var(--anac-primary);
            padding-bottom: 12px;
            letter-spacing: -0.3px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        /* Form Elements - Professional Style */
        label {
            display: block;
            margin-bottom: 8px;
            color: var(--anac-gray-700);
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .help-text {
            font-size: 12px;
            color: var(--anac-gray-600);
            margin-top: 4px;
            font-style: normal;
            font-weight: 400;
            text-transform: none;
        }
        
        select, input[type="text"], input[type="number"], input[type="date"], .form-input {
            width: 100%;
            padding: 11px 14px;
            border: 1px solid var(--anac-gray-300);
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s ease;
            background: var(--white);
            color: var(--anac-gray-900);
            font-family: inherit;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: var(--anac-primary);
            box-shadow: 0 0 0 3px rgba(0, 51, 102, 0.1);
        }
        
        select:hover, input:hover {
            border-color: var(--anac-gray-600);
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        input[type="checkbox"], input[type="radio"] {
            width: auto;
            cursor: pointer;
        }
        
        textarea {
            font-family: inherit;
            resize: vertical;
            width: 100%;
            padding: 11px 14px;
            border: 1px solid var(--anac-gray-300);
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s ease;
            background: var(--white);
            color: var(--anac-gray-900);
        }
        
        textarea:focus {
            outline: none;
            border-color: var(--anac-primary);
            box-shadow: 0 0 0 3px rgba(0, 51, 102, 0.1);
        }
        
        /* Professional Buttons */
        button {
            background: var(--anac-primary);
            color: var(--white);
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            letter-spacing: 0.3px;
            text-transform: uppercase;
            font-size: 13px;
        }
        
        button:hover {
            background: var(--anac-primary-dark);
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }
        
        button:active {
            transform: translateY(0);
            box-shadow: var(--shadow-sm);
        }
        
        button:disabled {
            background: var(--anac-gray-300);
            color: var(--anac-gray-600);
            cursor: not-allowed;
            transform: none;
        }
        
        button.secondary {
            background: var(--anac-gray-600);
        }
        
        button.secondary:hover {
            background: var(--anac-gray-700);
        }
        
        button.danger {
            background: var(--anac-error);
        }
        
        button.danger:hover {
            background: #B91C1C;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
        }
        
        .button-group button {
            flex: 1;
        }
        
        /* Professional Status Badges */
        .status-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            margin-right: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-compliant {
            background: var(--anac-success);
            color: var(--white);
        }
        
        .status-non-compliant {
            background: var(--anac-error);
            color: var(--white);
        }
        
        .status-partial {
            background: var(--anac-warning);
            color: var(--white);
        }
        
        .status-pending {
            background: var(--anac-gray-600);
            color: var(--white);
        }
        
        /* Compliance Items - Professional Style */
        .compliance-item {
            border-left: 4px solid var(--anac-gray-300);
            padding: 20px;
            margin-bottom: 16px;
            background: var(--white);
            border-radius: 6px;
            border: 1px solid var(--anac-gray-200);
            transition: all 0.2s ease;
        }
        
        .compliance-item:hover {
            border-left-color: var(--anac-primary);
            box-shadow: var(--shadow-sm);
        }
        
        .compliance-item h3 {
            color: var(--anac-gray-900);
            margin-bottom: 10px;
            font-size: 16px;
            font-weight: 600;
        }
        
        .compliance-item p {
            color: var(--anac-gray-600);
            font-size: 14px;
            margin-bottom: 12px;
            line-height: 1.5;
        }
        
        /* Summary Cards - Professional Dashboard Style */
        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 28px;
        }
        
        .summary-item {
            text-align: center;
            padding: 24px 20px;
            background: var(--white);
            border-radius: 8px;
            border: 1px solid var(--anac-gray-200);
            box-shadow: var(--shadow-sm);
            transition: all 0.2s ease;
        }
        
        .summary-item:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }
        
        .summary-item .number {
            font-size: 36px;
            font-weight: 700;
            color: var(--anac-primary);
            line-height: 1;
        }
        
        .summary-item .label {
            font-size: 12px;
            color: var(--anac-gray-600);
            margin-top: 8px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Alert Boxes - Professional Style */
        .recommendations {
            background: #FEF3C7;
            border-left: 4px solid var(--anac-warning);
            padding: 20px;
            margin-top: 24px;
            border-radius: 6px;
            border: 1px solid #FCD34D;
        }
        
        .recommendations h3 {
            color: #92400E;
            margin-bottom: 12px;
            font-weight: 600;
            font-size: 16px;
        }
        
        .recommendations ul {
            list-style: none;
            padding-left: 0;
        }
        
        .recommendations li {
            padding: 10px 0;
            color: #78350F;
            border-bottom: 1px solid #FDE68A;
            font-size: 14px;
        }
        
        .recommendations li:last-child {
            border-bottom: none;
        }
        
        .loading {
            text-align: center;
            padding: 60px;
            color: var(--anac-gray-600);
            font-size: 16px;
        }
        
        .error {
            background: #FEE2E2;
            border-left: 4px solid var(--anac-error);
            padding: 16px 20px;
            margin: 24px 0;
            border-radius: 6px;
            color: #991B1B;
            border: 1px solid #FECACA;
            font-size: 14px;
        }
        
        .success {
            background: #D1FAE5;
            border-left: 4px solid var(--anac-success);
            padding: 16px 20px;
            margin: 24px 0;
            border-radius: 6px;
            color: #065F46;
            border: 1px solid #A7F3D0;
            font-size: 14px;
        }
        
        .action-items {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e0e0e0;
        }
        
        .action-items ul {
            list-style: disc;
            padding-left: 20px;
            color: #666;
            font-size: 13px;
        }
        
        .airport-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        /* Airport List Items */
        .airport-item {
            padding: 16px 20px;
            border: 1px solid var(--anac-gray-200);
            border-radius: 6px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--white);
        }
        
        .airport-item:hover {
            background: var(--anac-bg-light);
            border-color: var(--anac-primary);
            box-shadow: var(--shadow-sm);
        }
        
        .airport-item.selected {
            background: var(--anac-bg-light);
            border-color: var(--anac-primary);
            border-width: 2px;
            box-shadow: var(--shadow-md);
        }
        
        /* Info Boxes */
        .info-box {
            background: var(--anac-bg-light);
            border-left: 4px solid var(--anac-primary);
            padding: 20px;
            margin: 24px 0;
            border-radius: 6px;
            border: 1px solid #B3D9FF;
        }
        
        .info-box h4 {
            color: var(--anac-primary);
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 15px;
        }
        
        .info-box p {
            color: var(--anac-gray-700);
            font-size: 14px;
            line-height: 1.6;
        }
        
        /* Toast Notification System - Professional Style */
        .toast-container {
            position: fixed;
            top: 24px;
            right: 24px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 420px;
        }
        
        .toast {
            background: var(--white);
            border-radius: 8px;
            padding: 16px 20px;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 14px;
            animation: slideIn 0.3s ease-out;
            min-width: 320px;
            border: 1px solid var(--anac-gray-200);
        }
        
        .toast.success {
            border-left: 4px solid var(--anac-success);
        }
        
        .toast.error {
            border-left: 4px solid var(--anac-error);
        }
        
        .toast.warning {
            border-left: 4px solid var(--anac-warning);
        }
        
        .toast.info {
            border-left: 4px solid var(--anac-info);
        }
        
        .toast-icon {
            font-size: 22px;
            flex-shrink: 0;
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-message {
            font-weight: 600;
            color: var(--anac-gray-900);
            margin-bottom: 4px;
            font-size: 14px;
        }
        
        .toast-close {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: var(--anac-gray-600);
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: color 0.2s ease;
        }
        
        .toast-close:hover {
            color: var(--anac-gray-900);
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Filter and Search Styles - Professional */
        .filters-container {
            background: var(--white);
            padding: 24px;
            border-radius: 8px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--anac-gray-200);
        }
        
        .filters-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 16px;
            align-items: end;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-group label {
            font-size: 11px;
            font-weight: 700;
            color: var(--anac-gray-700);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .search-input {
            padding: 10px 14px;
            border: 1px solid var(--anac-gray-300);
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s ease;
            background: var(--white);
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--anac-primary);
            box-shadow: 0 0 0 3px rgba(0, 51, 102, 0.1);
            border-color: #667eea;
        }
        
        .filter-select {
            padding: 10px 14px;
            border: 1px solid var(--anac-gray-300);
            border-radius: 6px;
            font-size: 14px;
            background: var(--white);
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--anac-gray-900);
        }
        
        .filter-select:focus {
            outline: none;
            border-color: var(--anac-primary);
            box-shadow: 0 0 0 3px rgba(0, 51, 102, 0.1);
        }
        
        .filter-select:hover {
            border-color: var(--anac-gray-600);
        }
        
        .clear-filters-btn {
            padding: 10px 20px;
            background: var(--anac-gray-100);
            border: 1px solid var(--anac-gray-300);
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: var(--anac-gray-700);
            white-space: nowrap;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .clear-filters-btn:hover {
            background: var(--anac-gray-200);
            border-color: var(--anac-gray-600);
            color: var(--anac-gray-900);
        }
        
        /* Form Validation Styles */
        .form-group.error input,
        .form-group.error select {
            border-color: var(--anac-error);
        }
        
        .form-group.error label {
            color: var(--anac-error);
        }
        
        .form-group.error .error-message {
            color: #ef4444;
            font-size: 12px;
            margin-top: 4px;
            display: block;
        }
        
        .form-group.success input,
        .form-group.success select {
            border-color: #10b981;
        }
        
        /* Loading States */
        .btn-loading {
            position: relative;
            color: transparent;
            pointer-events: none;
        }
        
        .btn-loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.6s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Accessibility improvements */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        
        /* Form Sections (Collapsible) - Professional */
        .form-section {
            border: 1px solid var(--anac-gray-200);
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
            background: var(--white);
            box-shadow: var(--shadow-sm);
        }
        
        .form-section-header {
            background: var(--anac-gray-50);
            padding: 18px 24px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
            border-bottom: 1px solid var(--anac-gray-200);
        }
        
        .form-section-header:hover {
            background: var(--anac-bg-light);
        }
        
        .form-section-header h3 {
            color: var(--anac-primary);
            font-size: 16px;
            font-weight: 600;
            margin: 0;
        }
        
        .form-section-header:hover {
            background: #f0f0f0;
        }
        
        .form-section-header h3 {
            margin: 0;
            font-size: 16px;
            color: #333;
            font-weight: 600;
        }
        
        .form-section-toggle {
            font-size: 18px;
            color: #666;
            transition: transform 0.3s;
        }
        
        .form-section.collapsed .form-section-toggle {
            transform: rotate(-90deg);
        }
        
        .form-section-content {
            padding: 20px;
            display: block;
        }
        
        .form-section.collapsed .form-section-content {
            display: none;
        }
        
        /* Progress Bar for Action Items */
        .action-items-progress {
            margin: 15px 0;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        /* Progress Bar - Professional Style */
        .progress-bar-container {
            width: 100%;
            height: 28px;
            background: var(--anac-gray-200);
            border-radius: 6px;
            overflow: hidden;
            margin-top: 10px;
            position: relative;
            border: 1px solid var(--anac-gray-300);
        }
        
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--anac-success) 0%, #047857 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .progress-bar-text {
            font-size: 13px;
            color: var(--anac-gray-700);
            margin-bottom: 6px;
            font-weight: 500;
        }
        
        /* Sort Controls - Professional */
        .sort-controls {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 20px;
            padding: 16px;
            background: var(--white);
            border-radius: 8px;
            border: 1px solid var(--anac-gray-200);
            box-shadow: var(--shadow-sm);
        }
        
        .sort-controls label {
            font-size: 13px;
            font-weight: 600;
            color: var(--anac-gray-700);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0;
        }
        
        .sort-select {
            padding: 9px 14px;
            border: 1px solid var(--anac-gray-300);
            border-radius: 6px;
            font-size: 14px;
            background: var(--white);
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--anac-gray-900);
        }
        
        .sort-select:focus {
            outline: none;
            border-color: var(--anac-primary);
            box-shadow: 0 0 0 3px rgba(0, 51, 102, 0.1);
        }
        
        /* Autocomplete */
        .autocomplete-container {
            position: relative;
        }
        
        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #667eea;
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: none;
        }
        
        .autocomplete-suggestions.show {
            display: block;
        }
        
        .autocomplete-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .autocomplete-item:hover,
        .autocomplete-item.selected {
            background: #f0f0ff;
        }
        
        .autocomplete-item:last-child {
            border-bottom: none;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .filters-row {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                width: 100%;
            }
            
            .summary {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .compliance-item {
                padding: 15px;
            }
            
            .toast-container {
                left: 10px;
                right: 10px;
                max-width: none;
            }
            
            .toast {
                min-width: auto;
            }
        }
        
        @media (max-width: 480px) {
            .summary {
                grid-template-columns: 1fr;
            }
            
            .sort-controls {
                flex-direction: column;
                align-items: stretch;
            }
        }
        
        /* Tour Guide Styles - ANAC Professional Design */
        .tour-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(30, 41, 59, 0.75);
            z-index: 9998;
            display: none;
            backdrop-filter: blur(2px);
        }
        
        .tour-overlay.active {
            display: block;
        }
        
        .tour-highlight {
            position: relative;
            z-index: 9999;
            box-shadow: 0 0 0 4px var(--anac-primary), 
                        0 0 0 8px rgba(0, 51, 102, 0.2),
                        0 0 30px rgba(0, 51, 102, 0.4);
            border-radius: 8px;
            transition: all 0.3s ease;
            background: var(--white);
        }
        
        .tour-popup {
            position: fixed;
            background: var(--white);
            border-radius: 8px;
            padding: 28px;
            box-shadow: var(--shadow-lg), 0 20px 60px rgba(0, 51, 102, 0.3);
            z-index: 10000;
            max-width: 420px;
            display: none;
            border: 1px solid var(--anac-gray-200);
            border-top: 4px solid var(--anac-primary);
        }
        
        .tour-popup.active {
            display: block;
            animation: tourFadeIn 0.3s ease-out;
        }
        
        @keyframes tourFadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .tour-popup h3 {
            margin: 0 0 14px 0;
            color: var(--anac-primary);
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.3px;
        }
        
        .tour-popup p {
            margin: 0 0 24px 0;
            color: var(--anac-gray-700);
            line-height: 1.6;
            font-size: 14px;
        }
        
        .tour-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        
        .tour-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .tour-btn-primary {
            background: var(--anac-primary);
            color: var(--white);
        }
        
        .tour-btn-primary:hover {
            background: var(--anac-primary-dark);
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }
        
        .tour-btn-secondary {
            background: var(--anac-gray-100);
            color: var(--anac-gray-700);
            border: 1px solid var(--anac-gray-300);
        }
        
        .tour-btn-secondary:hover {
            background: var(--anac-gray-200);
            border-color: var(--anac-gray-600);
            color: var(--anac-gray-900);
        }
        
        /* Batch Edit Mode - ANAC Professional */
        .batch-edit-mode {
            background: #FEF3C7;
            border-left: 4px solid var(--anac-warning);
            padding: 20px 24px;
            margin-bottom: 24px;
            border-radius: 8px;
            border: 1px solid #FCD34D;
            box-shadow: var(--shadow-sm);
        }
        
        .batch-edit-controls {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .batch-edit-controls strong {
            color: #92400E;
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-right: auto;
        }
        
        .batch-select-all {
            padding: 10px 20px;
            background: var(--anac-primary);
            color: var(--white);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s ease;
        }
        
        .batch-select-all:hover {
            background: var(--anac-primary-dark);
            box-shadow: var(--shadow-sm);
        }
        
        .batch-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .batch-action-btn {
            padding: 9px 18px;
            background: var(--white);
            border: 1px solid var(--anac-primary);
            color: var(--anac-primary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s ease;
        }
        
        .batch-action-btn:hover {
            background: var(--anac-primary);
            color: var(--white);
            box-shadow: var(--shadow-sm);
            transform: translateY(-1px);
        }
        
        .compliance-item.batch-selected {
            border: 2px solid var(--anac-primary);
            background: var(--anac-bg-light);
            box-shadow: var(--shadow-md);
        }
        
        .batch-checkbox {
            margin-right: 12px;
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--anac-primary);
        }
        
        /* Export Button */
        /* Export Button - ANAC Professional */
        .export-btn {
            padding: 10px 20px;
            background: var(--anac-success);
            color: var(--white);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s ease;
        }
        
        .export-btn:hover {
            background: #047857;
            box-shadow: var(--shadow-sm);
            transform: translateY(-1px);
        }
        
        /* History/Changes Log - ANAC Professional */
        .changes-log {
            background: var(--anac-gray-50);
            border-left: 4px solid var(--anac-primary);
            padding: 20px;
            margin-top: 20px;
            border-radius: 6px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--anac-gray-200);
            box-shadow: var(--shadow-sm);
        }
        
        .changes-log h4 {
            margin: 0 0 14px 0;
            color: var(--anac-primary);
            font-size: 15px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .change-item {
            padding: 12px 0;
            border-bottom: 1px solid var(--anac-gray-200);
            font-size: 13px;
            color: var(--anac-gray-700);
        }
        
        .change-item:last-child {
            border-bottom: none;
        }
        
        .change-item strong {
            color: var(--anac-gray-900);
            font-weight: 600;
        }
        
        .change-time {
            color: var(--anac-gray-600);
            font-size: 11px;
            margin-top: 6px;
            font-style: italic;
        }
        
        /* Auto-save indicator - ANAC Professional */
        .auto-save-indicator {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--anac-success);
            color: var(--white);
            padding: 12px 20px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            display: none;
            z-index: 9999;
            box-shadow: var(--shadow-lg);
            border: 1px solid #047857;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .auto-save-indicator.show {
            display: block;
            animation: fadeInOut 2s ease-in-out;
        }
        
        @keyframes fadeInOut {
            0%, 100% { 
                opacity: 0;
                transform: translateY(10px);
            }
            20%, 80% { 
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container" role="region" aria-live="polite" aria-atomic="true"></div>
    
    <!-- Tour Overlay -->
    <div id="tourOverlay" class="tour-overlay"></div>
    <div id="tourPopup" class="tour-popup">
        <h3 id="tourTitle">Bem-vindo!</h3>
        <p id="tourDescription">Vamos come√ßar o tour guiado do sistema.</p>
        <div class="tour-buttons">
            <button class="tour-btn tour-btn-secondary" onclick="skipTour()">Pular</button>
            <button class="tour-btn tour-btn-primary" onclick="nextTourStep()">Pr√≥ximo</button>
        </div>
    </div>
    
    <!-- Auto-save Indicator -->
    <div id="autoSaveIndicator" class="auto-save-indicator">üíæ Rascunho salvo</div>
    
    <div class="container">
        <header>
            <h1>‚úàÔ∏è Sistema de Conformidade ANAC</h1>
            <p class="subtitle">Sistema de gest√£o de conformidade para aeroportos brasileiros - Informe os dados do seu aeroporto para verificar a conformidade</p>
        </header>
        
        <!-- Breadcrumbs -->
        <nav id="breadcrumbs" class="breadcrumbs" aria-label="Breadcrumb">
            <ol style="list-style: none; display: flex; gap: 8px; padding: 12px 32px; background: var(--white); border-bottom: 1px solid var(--anac-gray-200); margin: 0;">
                <li><a href="#" onclick="switchTab('manage'); return false;" style="color: var(--anac-primary); text-decoration: none;">In√≠cio</a></li>
                <li id="breadcrumbSeparator" style="display: none;"><span style="color: var(--anac-gray-300);">/</span></li>
                <li id="breadcrumbCurrent" style="display: none;"><span style="color: var(--anac-gray-600);"></span></li>
            </ol>
        </nav>
        
        <script>
            // Define switchTab early so it's available for onclick handlers
            window.switchTab = function(tabName) {
                // This will be replaced by the full implementation below
                console.log('switchTab called with:', tabName);
            };
        </script>
        
        <nav class="tabs" role="tablist" aria-label="Navega√ß√£o principal">
            <button class="tab active" onclick="switchTab('manage')" role="tab" aria-selected="true" aria-controls="manageTab" id="manageTabBtn">
                <span style="display: inline-flex; align-items: center; gap: 6px;">
                    <span>‚úàÔ∏è</span> Gerenciar Aeroportos
                </span>
            </button>
            <button class="tab" onclick="switchTab('compliance')" role="tab" aria-selected="false" aria-controls="complianceTab" id="complianceTabBtn">
                <span style="display: inline-flex; align-items: center; gap: 6px;">
                    <span>‚úÖ</span> Verificar Conformidade
                </span>
            </button>
            <button class="tab" onclick="switchTab('areas')" role="tab" aria-selected="false" aria-controls="areasTab" id="areasTabBtn">
                <span style="display: inline-flex; align-items: center; gap: 6px;">
                    <span>üöí</span> √Åreas SESCINC
                </span>
            </button>
            <button class="tab" onclick="switchTab('deadlines')" role="tab" aria-selected="false" aria-controls="deadlinesTab" id="deadlinesTabBtn">
                <span style="display: inline-flex; align-items: center; gap: 6px;">
                    <span>üìÖ</span> Prazos
                </span>
            </button>
        </nav>
        
        <!-- Dashboard Tab -->
        <div id="dashboardTab" class="tab-content" style="display: none;">
            <div class="main-content" style="grid-template-columns: 1fr;">
                <div class="card">
                    <h2>üìä Vis√£o Geral</h2>
                    <div id="dashboardStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div class="stat-card" style="background: linear-gradient(135deg, var(--anac-primary) 0%, var(--anac-primary-light) 100%); color: white; padding: 20px; border-radius: 8px;">
                            <div style="font-size: 32px; font-weight: 700;" id="totalAirports">-</div>
                            <div style="font-size: 14px; opacity: 0.9; margin-top: 5px;">Aeroportos Cadastrados</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, var(--anac-success) 0%, #10b981 100%); color: white; padding: 20px; border-radius: 8px;">
                            <div style="font-size: 32px; font-weight: 700;" id="compliantAirports">-</div>
                            <div style="font-size: 14px; opacity: 0.9; margin-top: 5px;">Aeroportos Conformes</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, var(--anac-warning) 0%, #f59e0b 100%); color: white; padding: 20px; border-radius: 8px;">
                            <div style="font-size: 32px; font-weight: 700;" id="pendingAirports">-</div>
                            <div style="font-size: 14px; opacity: 0.9; margin-top: 5px;">Pendentes de Revis√£o</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, var(--anac-error) 0%, #dc2626 100%); color: white; padding: 20px; border-radius: 8px;">
                            <div style="font-size: 32px; font-weight: 700;" id="nonCompliantAirports">-</div>
                            <div style="font-size: 14px; opacity: 0.9; margin-top: 5px;">N√£o Conformes</div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0;">Aeroportos</h2>
                        <button onclick="switchTab('manage')" style="padding: 10px 20px; background: var(--anac-primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
                            + Novo Aeroporto
                        </button>
                    </div>
                    <div id="dashboardAirportList" class="airport-list">
                        <div class="loading">Carregando aeroportos...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Areas SESCINC Tab -->
        <div id="areasTab" class="tab-content">
            <div class="main-content" style="grid-template-columns: 1fr;">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                        <div>
                            <h2 style="margin: 0;">üöí Gest√£o por √Åreas Funcionais SESCINC</h2>
                            <p style="color: #666; margin: 5px 0 0 0;">
                                Visualize e gerencie as conformidades organizadas por √°rea funcional conforme a estrutura do SESCINC.
                            </p>
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <div class="form-group" style="margin: 0; min-width: 200px;">
                                <label for="areasAirportSelect" style="font-size: 12px; margin-bottom: 4px; display: block;">Aeroporto:</label>
                                <select id="areasAirportSelect" autocomplete="off" onchange="loadAreas()" style="padding: 8px 12px; border: 2px solid var(--anac-gray-300); border-radius: 6px; font-size: 14px; width: 100%;">
                                    <option value="">Selecione um aeroporto...</option>
                                </select>
                            </div>
                            <button onclick="switchTab('deadlines')" style="padding: 10px 20px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; align-self: flex-end;">
                                üìÖ Prazos e Vencimentos
                            </button>
                        </div>
                    </div>
                    <div id="areasContent">
                        <div class="loading">Carregando √°reas funcionais...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Deadlines Tab -->
        <div id="deadlinesTab" class="tab-content">
            <div class="main-content" style="grid-template-columns: 1fr;">
                <div class="card">
                    <h2>üìÖ Gest√£o de Prazos e Vencimentos</h2>
                    <p style="color: #666; margin-bottom: 20px;">
                        Acompanhe prazos de manuten√ß√£o, aferi√ß√µes, treinamentos e outras atividades por √°rea funcional.
                    </p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                        <div class="stat-card" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; padding: 20px; border-radius: 8px;">
                            <div style="font-size: 32px; font-weight: 700;" id="deadlinesUrgent">-</div>
                            <div style="font-size: 14px; opacity: 0.9; margin-top: 5px;">Vencidos</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 20px; border-radius: 8px;">
                            <div style="font-size: 32px; font-weight: 700;" id="deadlinesDueSoon">-</div>
                            <div style="font-size: 14px; opacity: 0.9; margin-top: 5px;">Vencendo em 30 dias</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 20px; border-radius: 8px;">
                            <div style="font-size: 32px; font-weight: 700;" id="deadlinesUpcoming">-</div>
                            <div style="font-size: 14px; opacity: 0.9; margin-top: 5px;">Pr√≥ximos 90 dias</div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button id="deadlines-view-list" onclick="switchDeadlinesView('list')" 
                                style="padding: 8px 16px; background: var(--anac-primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">
                            üìã Lista
                        </button>
                        <button id="deadlines-view-calendar" onclick="switchDeadlinesView('calendar')" 
                                style="padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">
                            üìÖ Calend√°rio
                        </button>
                    </div>
                    
                    <div id="deadlinesContent">
                        <div class="loading">Carregando prazos...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Manage Airports Tab -->
        <div id="manageTab" class="tab-content active">
        <div class="main-content">
            <div class="card">
                    <h2 id="formTitle">Cadastrar Novo Aeroporto</h2>
                <form id="airportForm">
                        <input type="hidden" id="airportId" value="">
                        
                        <div class="form-group">
                            <label for="code">C√≥digo ICAO <span aria-label="obrigat√≥rio">*</span></label>
                            <div style="display: flex; gap: 8px; align-items: flex-start;">
                                <input type="text" id="code" maxlength="4" required 
                                       autocomplete="off"
                                       inputmode="characters"
                                       placeholder="Ex: SBGR"
                                       style="text-transform: uppercase; flex: 1; min-width: 80px;"
                                       aria-required="true"
                                       aria-describedby="code-help"
                                       pattern="[A-Z]{4}"
                                       onblur="validateField('code', this.value)"
                                       oninput="var v=this.value.replace(/[^A-Za-z]/g,'').toUpperCase().slice(0,4);if(v!==this.value){this.value=v;}updateLookupButton()">
                                <button type="button" id="lookupAnacBtn" 
                                        onclick="lookupAirportFromANAC()"
                                        style="padding: 10px 16px; background: var(--anac-primary); color: white; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap; font-size: 14px;"
                                        disabled
                                        title="Buscar dados do aeroporto na lista oficial da ANAC">
                                    üîç Buscar da ANAC
                                </button>
                            </div>
                            <div class="help-text" id="code-help">C√≥digo ICAO de 4 letras (ex: SBGR, SBCF). O sistema busca na base oficial da ANAC. Se indispon√≠vel, usa cache ou cadastro local. <a href="#" onclick="refreshAnacCache(); return false;" style="font-size: 12px; color: var(--anac-primary);">Atualizar cache ANAC</a></div>
                            <span class="error-message" id="code-error" style="display: none;"></span>
                            <div id="anac-lookup-status" style="margin-top: 8px; font-size: 13px; display: none;"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="name">Nome do Aeroporto <span aria-label="obrigat√≥rio">*</span></label>
                            <input type="text" id="name" required 
                                   autocomplete="organization"
                                   aria-required="true" 
                                   aria-describedby="name-help"
                                   onblur="validateField('name', this.value)">
                            <div class="help-text" id="name-help">Nome completo do aeroporto (ex: Aeroporto Internacional de S√£o Paulo - Guarulhos)</div>
                            <span class="error-message" id="name-error" style="display: none;"></span>
                        </div>
                        
                        <div class="form-group">
                            <label for="airport_type">Tipo de Aeroporto *</label>
                            <select id="airport_type" required autocomplete="off">
                                <option value="">Selecione...</option>
                                <option value="commercial">Comercial</option>
                                <option value="general_aviation">Avia√ß√£o Geral</option>
                                <option value="military">Militar</option>
                                <option value="mixed">Misto</option>
                            </select>
                            <div class="help-text">Tipo de opera√ß√£o principal do aeroporto</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="usage_class">Classe por Uso (RBAC 153) *</label>
                            <select id="usage_class" required autocomplete="off">
                                <option value="">Selecione...</option>
                                <option value="I">Classe I - P√∫blico: &lt; 200 mil passageiros/ano</option>
                                <option value="II">Classe II - P√∫blico: 200 mil - 1 milh√£o passageiros/ano</option>
                                <option value="III">Classe III - P√∫blico: 1 milh√£o - 5 milh√µes passageiros/ano</option>
                                <option value="IV">Classe IV - P√∫blico: &gt; 5 milh√µes passageiros/ano</option>
                                <option value="PRIVADO">Privado - Uso restrito ao propriet√°rio</option>
                            </select>
                            <div class="help-text">Classifica√ß√£o por uso conforme RBAC 153 (P√∫blico: Classes I-IV baseadas em passageiros, ou Privado).</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="avsec_classification">Classifica√ß√£o AVSEC (Seguran√ßa) *</label>
                            <select id="avsec_classification" required autocomplete="off">
                                <option value="">Selecione...</option>
                                <option value="AP-0">AP-0 - Avia√ß√£o geral/t√°xi a√©reo/fretamento</option>
                                <option value="AP-1">AP-1 - Comercial regular/charter, &lt; 600 mil pass./ano</option>
                                <option value="AP-2">AP-2 - Comercial regular/charter, 600 mil - 5 milh√µes pass./ano</option>
                                <option value="AP-3">AP-3 - Comercial regular/charter, &gt; 5 milh√µes pass./ano</option>
                            </select>
                            <div class="help-text">Classifica√ß√£o AVSEC (Seguran√ßa contra Atos de Interfer√™ncia Il√≠cita) conforme ANAC.</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="aircraft_size_category">Categoria de Porte da Aeronave (Avalia√ß√£o de Pista) *</label>
                            <select id="aircraft_size_category" required autocomplete="off">
                                <option value="">Selecione...</option>
                                <option value="A/B">A/B - Aeronaves at√© 5.700 kg (MTOW)</option>
                                <option value="C">C - Aeronaves entre 5.700 kg e 136.000 kg (MTOW)</option>
                                <option value="D">D - Aeronaves acima de 136.000 kg (MTOW)</option>
                            </select>
                            <div class="help-text">Categoria baseada no peso m√°ximo de decolagem (MTOW - Maximum Take-Off Weight) da maior aeronave que opera regularmente no aer√≥dromo. Conforme classifica√ß√£o ANAC/ICAO.</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="reference_code">C√≥digo de Refer√™ncia das Aeronaves *</label>
                            <input type="text" id="reference_code" maxlength="10" pattern="[1-4][A-E]" placeholder="Ex: 3C, 4C, 4E" required autocomplete="off">
                            <div class="help-text">C√≥digo alfanum√©rico (ex: 3C, 4C, 4E) que indica a configura√ß√£o m√°xima de aeronave permitida no aeroporto. N√∫mero (1-4): comprimento de pista necess√°rio. Letra (A-E): envergadura/dist√¢ncia entre rodas. Exemplos: A318-100 (3C), A320 (4C), A330 (4E).</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="number_of_runways">N√∫mero de Pistas *</label>
                            <input type="number" id="number_of_runways" min="1" value="1" required autocomplete="off">
                            <div class="help-text">N√∫mero de pistas de pouso e decolagem</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="max_aircraft_weight">Peso M√°ximo de Aeronaves (toneladas)</label>
                            <input type="number" id="max_aircraft_weight" min="0" autocomplete="off">
                            <div class="help-text">Peso m√°ximo de decolagem (MTOW) da maior aeronave que opera regularmente</div>
                        </div>
                        
                        <div class="form-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="has_international_operations">
                                <label for="has_international_operations" style="margin: 0;">Opera√ß√µes Internacionais</label>
                            </div>
                            <div class="help-text">Selecione se o aeroporto recebe voos internacionais. Requer normas adicionais de seguran√ßa e alf√¢ndega.</div>
                        </div>
                        
                        <div class="form-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="has_cargo_operations">
                                <label for="has_cargo_operations" style="margin: 0;">Opera√ß√µes de Carga</label>
                            </div>
                            <div class="help-text">Selecione se o aeroporto realiza opera√ß√µes de carga. Requer infraestrutura espec√≠fica.</div>
                        </div>
                        
                        <div class="form-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="has_maintenance_facility">
                                <label for="has_maintenance_facility" style="margin: 0;">Facilidades de Manuten√ß√£o Aeron√°utica</label>
                            </div>
                            <div class="help-text">Selecione se o aeroporto possui hangares e facilidades para manuten√ß√£o de aeronaves.</div>
                        </div>
                        
                        <div class="button-group">
                            <button type="submit" id="submitBtn" aria-label="Salvar aeroporto">
                        <span id="submitBtnText">Salvar Aeroporto</span>
                    </button>
                            <button type="button" class="secondary" onclick="resetForm()" id="cancelBtn" style="display: none;">Cancelar</button>
                        </div>
                    </form>
                    
                    <div id="formMessage"></div>
                </div>
                
                <div class="card">
                    <h2>Aeroportos Cadastrados</h2>
                    <div class="info-box">
                        <h4>‚ÑπÔ∏è Como usar</h4>
                        <p>Cadastre seu aeroporto informando todas as caracter√≠sticas acima. O sistema usar√° essas informa√ß√µes para determinar quais normas ANAC (RBAC-153 e RBAC-154) se aplicam e gerar um plano de a√ß√£o personalizado.</p>
                    </div>
                    <div id="airportList" class="airport-list">
                        <div class="loading">Carregando aeroportos...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Compliance Check Tab -->
        <div id="complianceTab" class="tab-content">
            <div class="main-content">
                <div class="card">
                    <h2>Selecionar Aeroporto</h2>
                    <form id="complianceForm">
                    <div class="form-group">
                        <label for="airportSelect">Aeroporto:</label>
                        <select id="airportSelect" autocomplete="off">
                            <option value="">Carregando...</option>
                        </select>
                    </div>
                    <button type="submit" id="checkComplianceBtn" aria-label="Verificar conformidade do aeroporto selecionado">
                        <span id="checkComplianceBtnText">Verificar Conformidade</span>
                    </button>
                </form>
                
                <div id="airportInfo" style="margin-top: 20px; display: none;">
                    <h3 style="margin-bottom: 10px; color: #333;">Informa√ß√µes do Aeroporto</h3>
                    <div id="airportDetails" style="font-size: 14px; color: #666;"></div>
                </div>
            </div>
            
            <div class="card">
                <h2>Status de Conformidade</h2>
                <div id="complianceContent">
                    <div class="loading">Selecione um aeroporto para verificar a conformidade</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE = 'http://localhost:8000/api';
        let currentEditingId = null;
        
        // Tab switching - make it globally accessible (override the early definition)
        window.switchTab = function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => {
                t.classList.remove('active');
                t.setAttribute('aria-selected', 'false');
            });
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            // Update breadcrumbs
            updateBreadcrumbs(tabName);
            
            if (tabName === 'manage') {
                const manageTabBtn = document.getElementById('manageTabBtn');
                const manageTab = document.getElementById('manageTab');
                if (manageTabBtn) {
                    manageTabBtn.classList.add('active');
                    manageTabBtn.setAttribute('aria-selected', 'true');
                }
                if (manageTab) {
                    manageTab.classList.add('active');
                }
                loadAirports();
            } else if (tabName === 'areas') {
                const areasTabBtn = document.getElementById('areasTabBtn');
                const areasTab = document.getElementById('areasTab');
                if (areasTabBtn) {
                    areasTabBtn.classList.add('active');
                    areasTabBtn.setAttribute('aria-selected', 'true');
                }
                if (areasTab) {
                    areasTab.classList.add('active');
                }
                loadAreas();
            } else if (tabName === 'deadlines') {
                const deadlinesTabBtn = document.getElementById('deadlinesTabBtn');
                const deadlinesTab = document.getElementById('deadlinesTab');
                if (deadlinesTabBtn) {
                    deadlinesTabBtn.classList.add('active');
                    deadlinesTabBtn.setAttribute('aria-selected', 'true');
                }
                if (deadlinesTab) {
                    deadlinesTab.classList.add('active');
                }
                loadDeadlines();
            } else if (tabName === 'compliance') {
                const complianceTabBtn = document.getElementById('complianceTabBtn');
                const complianceTab = document.getElementById('complianceTab');
                if (complianceTabBtn) {
                    complianceTabBtn.classList.add('active');
                    complianceTabBtn.setAttribute('aria-selected', 'true');
                }
                if (complianceTab) {
                    complianceTab.classList.add('active');
                }
                loadAirportsForCompliance();
            }
        }
        
        // Update breadcrumbs
        function updateBreadcrumbs(tabName) {
            const separator = document.getElementById('breadcrumbSeparator');
            const current = document.getElementById('breadcrumbCurrent');
            
            const labels = {
                'manage': 'Gerenciar Aeroportos',
                'areas': '√Åreas SESCINC',
                'deadlines': 'Prazos e Vencimentos',
                'compliance': 'Verificar Conformidade'
            };
            
            separator.style.display = 'block';
            current.style.display = 'block';
            current.querySelector('span').textContent = labels[tabName] || tabName;
        }
        
        // Load Deadlines
        async function loadDeadlines() {
            const deadlinesContent = document.getElementById('deadlinesContent');
            if (!deadlinesContent) return;
            
            try {
                deadlinesContent.innerHTML = '<div class="loading">Carregando prazos...</div>';
                
                // Get selected airport - check both airportSelect and window.selectedAirportId
                const airportSelect = document.getElementById('airportSelect');
                let airportId = null;
                
                if (airportSelect && airportSelect.value) {
                    airportId = parseInt(airportSelect.value);
                } else if (window.selectedAirportId) {
                    airportId = parseInt(window.selectedAirportId);
                }
                
                if (!airportId) {
                    deadlinesContent.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--anac-gray-600);">
                            <div style="font-size: 48px; margin-bottom: 16px;">üìÖ</div>
                            <p style="margin-bottom: 20px;">Selecione um aeroporto para visualizar os prazos e vencimentos.</p>
                            <button onclick="switchTab('compliance')" style="padding: 12px 24px; background: var(--anac-primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
                                Selecionar Aeroporto
                            </button>
                        </div>
                    `;
                    return;
                }
                
                // Fetch compliance data
                const response = await fetch(`${API_BASE}/compliance/check`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ airport_id: airportId })
                });
                
                if (!response.ok) {
                    throw new Error('Erro ao carregar dados de conformidade');
                }
                
                const data = await response.json();
                displayDeadlines(data);
                
            } catch (error) {
                deadlinesContent.innerHTML = `
                    <div class="error" role="alert">
                        <strong>Erro:</strong> ${error.message}
                    </div>
                `;
                showToast('Erro ao carregar prazos', 'error');
            }
        }
        
        // Display deadlines grouped by area
        function displayDeadlines(data) {
            const deadlinesContent = document.getElementById('deadlinesContent');
            if (!deadlinesContent) return;
            
            // Helper functions
            function getFunctionalArea(code) {
                if (!code) return null;
                
                // RBAC-153 areas
                if (code.startsWith('RBAC-153')) {
                    const areaMap = {
                        'RBAC-153-01': 'Gest√£o da CAT', 'RBAC-153-02': 'Gest√£o da CAT',
                        'RBAC-153-03': 'Gest√£o de Equipamentos', 'RBAC-153-04': 'Gest√£o de Equipamentos',
                        'RBAC-153-05': 'Gest√£o de Equipamentos', 'RBAC-153-09': 'Gest√£o de Equipamentos',
                        'RBAC-153-06': 'Gest√£o de Recursos Humanos', 'RBAC-153-08': 'Gest√£o de Recursos Humanos',
                        'RBAC-153-10': 'Gest√£o de Recursos Humanos',
                        'RBAC-153-07': 'Gest√£o Operacional', 'RBAC-153-11': 'Gest√£o Operacional',
                        'RBAC-153-12': 'Gest√£o de Infraestrutura', 'RBAC-153-13': 'Gest√£o de Infraestrutura',
                        'RBAC-153-14': 'Gest√£o de Documenta√ß√£o'
                    };
                    return areaMap[code] || null;
                }
                
                // RBAC-154 areas (general compliance)
                if (code.startsWith('RBAC-154')) {
                    // Find the record to get safety category
                    const record = data.compliance_records.find(r => {
                        const reg = r.regulation || {};
                        return reg.code === code;
                    });
                    
                    if (record && record.regulation) {
                        const safetyCategory = record.regulation.safety_category;
                        const categoryValue = typeof safetyCategory === 'string' 
                            ? safetyCategory 
                            : (safetyCategory?.value || '');
                        
                        if (categoryValue === 'fire_safety') return 'Seguran√ßa Contra Inc√™ndio';
                        if (categoryValue === 'operational_safety') return 'Seguran√ßa Operacional';
                        if (categoryValue === 'security') return 'Seguran√ßa da Avia√ß√£o (AVSEC)';
                        if (categoryValue === 'infrastructure') return 'Infraestrutura';
                    }
                    
                    return 'RBAC-154 - Conformidade Geral';
                }
                
                return null;
            }
            
            function getAreaInfo(areaName) {
                const areaInfoMap = {
                    'Gest√£o da CAT': { icon: 'üìã', color: '#3b82f6' },
                    'Gest√£o de Equipamentos': { icon: 'üöõ', color: '#8b5cf6' },
                    'Gest√£o de Recursos Humanos': { icon: 'üë•', color: '#10b981' },
                    'Gest√£o Operacional': { icon: '‚öôÔ∏è', color: '#f59e0b' },
                    'Gest√£o de Infraestrutura': { icon: 'üèóÔ∏è', color: '#ef4444' },
                    'Gest√£o de Documenta√ß√£o': { icon: 'üìÑ', color: '#6b7280' },
                    'Seguran√ßa Contra Inc√™ndio': { icon: 'üöí', color: '#ef4444' },
                    'Seguran√ßa Operacional': { icon: '‚öôÔ∏è', color: '#3b82f6' },
                    'Seguran√ßa da Avia√ß√£o (AVSEC)': { icon: 'üõ°Ô∏è', color: '#10b981' },
                    'Infraestrutura': { icon: 'üèóÔ∏è', color: '#f59e0b' },
                    'RBAC-154 - Conformidade Geral': { icon: '‚úàÔ∏è', color: '#6b7280' }
                };
                return areaInfoMap[areaName] || { icon: 'üìÅ', color: '#6b7280' };
            }
            
            // Extract deadlines from records
            const deadlines = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            data.compliance_records.forEach(record => {
                const regulation = record.regulation || {};
                const code = regulation.code || '';
                const areaName = getFunctionalArea(code);
                
                // Debug: log all records being processed
                if (code && (code.startsWith('RBAC-153') || code.startsWith('RBAC-154'))) {
                    console.log(`Processing record: ${code}`, {
                        recordId: record.id,
                        areaName: areaName,
                        hasDueDates: !!record.action_item_due_dates,
                        dueDates: record.action_item_due_dates
                    });
                }
                
                if (!areaName) {
                    // Only skip if it's not RBAC-153 or RBAC-154
                    if (!code || (!code.startsWith('RBAC-153') && !code.startsWith('RBAC-154'))) {
                        return;
                    }
                }
                
                // Extract due dates from action items
                let actionItemDueDates = {};
                if (record.action_item_due_dates) {
                    try {
                        actionItemDueDates = typeof record.action_item_due_dates === 'string' 
                            ? JSON.parse(record.action_item_due_dates) 
                            : record.action_item_due_dates;
                    } catch (e) {
                        actionItemDueDates = {};
                    }
                }
                
                // Extract custom field dates (maintenance, training, etc.)
                let customFields = {};
                if (record.custom_fields) {
                    try {
                        customFields = typeof record.custom_fields === 'string' 
                            ? JSON.parse(record.custom_fields) 
                            : record.custom_fields;
                    } catch (e) {
                        customFields = {};
                    }
                }
                
                // Process action item due dates
                // Debug: log action item due dates
                if (Object.keys(actionItemDueDates).length > 0) {
                    console.log(`  Found ${Object.keys(actionItemDueDates).length} due dates for ${code}:`, actionItemDueDates);
                }
                
                // Parse action_items for display
                let actionItems = [];
                if (record.action_items) {
                    try {
                        actionItems = typeof record.action_items === 'string' 
                            ? JSON.parse(record.action_items) 
                            : record.action_items;
                    } catch (e) {
                        actionItems = [];
                    }
                }
                
                Object.keys(actionItemDueDates).forEach(itemIndex => {
                    const dueDateStr = actionItemDueDates[itemIndex];
                    if (dueDateStr) {
                        try {
                            const dueDate = new Date(dueDateStr);
                            if (isNaN(dueDate.getTime())) {
                                console.warn(`Invalid date format for ${code} item ${itemIndex}: ${dueDateStr}`);
                                return;
                            }
                            dueDate.setHours(0, 0, 0, 0);
                            
                            const daysDiff = Math.floor((dueDate - today) / (1000 * 60 * 60 * 24));
                            
                            const idx = parseInt(itemIndex);
                            const itemText = Array.isArray(actionItems) && actionItems[idx] 
                                ? actionItems[idx] 
                                : `Item de a√ß√£o #${idx + 1}`;
                            
                            deadlines.push({
                                type: 'action_item',
                                area: areaName,
                                regulationCode: code,
                                regulationTitle: regulation.title || '',
                                description: itemText,
                                dueDate: dueDate,
                                daysDiff: daysDiff,
                                status: daysDiff < 0 ? 'overdue' : (daysDiff <= 30 ? 'due_soon' : 'upcoming')
                            });
                            
                            console.log(`  Added deadline: ${code} item ${itemIndex} - ${dueDateStr} (${daysDiff} days)`);
                        } catch (e) {
                            console.error(`Error processing due date for ${code} item ${itemIndex}:`, e);
                        }
                    }
                });
                
                // Process custom field dates based on regulation code
                if (code === 'RBAC-153-04') {
                    // CCI maintenance dates
                    if (customFields.cci_next_maintenance) {
                        const dueDate = new Date(customFields.cci_next_maintenance);
                        dueDate.setHours(0, 0, 0, 0);
                        const daysDiff = Math.floor((dueDate - today) / (1000 * 60 * 60 * 24));
                        
                        deadlines.push({
                            type: 'maintenance',
                            area: areaName,
                            regulationCode: code,
                            regulationTitle: regulation.title || '',
                            description: 'Manuten√ß√£o do CCI',
                            dueDate: dueDate,
                            daysDiff: daysDiff,
                            status: daysDiff < 0 ? 'overdue' : (daysDiff <= 30 ? 'due_soon' : 'upcoming')
                        });
                    }
                } else if (code === 'RBAC-153-07') {
                    // Response time measurement
                    if (customFields.next_response_time_test) {
                        const dueDate = new Date(customFields.next_response_time_test);
                        dueDate.setHours(0, 0, 0, 0);
                        const daysDiff = Math.floor((dueDate - today) / (1000 * 60 * 60 * 24));
                        
                        deadlines.push({
                            type: 'test',
                            area: areaName,
                            regulationCode: code,
                            regulationTitle: regulation.title || '',
                            description: 'Aferi√ß√£o de Tempo-Resposta',
                            dueDate: dueDate,
                            daysDiff: daysDiff,
                            status: daysDiff < 0 ? 'overdue' : (daysDiff <= 30 ? 'due_soon' : 'upcoming')
                        });
                    }
                } else if (code === 'RBAC-153-08') {
                    // Training dates
                    if (customFields.next_training_date) {
                        const dueDate = new Date(customFields.next_training_date);
                        dueDate.setHours(0, 0, 0, 0);
                        const daysDiff = Math.floor((dueDate - today) / (1000 * 60 * 60 * 24));
                        
                        deadlines.push({
                            type: 'training',
                            area: areaName,
                            regulationCode: code,
                            regulationTitle: regulation.title || '',
                            description: 'Pr√≥ximo Treinamento',
                            dueDate: dueDate,
                            daysDiff: daysDiff,
                            status: daysDiff < 0 ? 'overdue' : (daysDiff <= 30 ? 'due_soon' : 'upcoming')
                        });
                    }
                }
            });
            
            // Count deadlines by status
            const overdue = deadlines.filter(d => d.status === 'overdue').length;
            const dueSoon = deadlines.filter(d => d.status === 'due_soon').length;
            const upcoming = deadlines.filter(d => d.status === 'upcoming').length;
            
            document.getElementById('deadlinesUrgent').textContent = overdue;
            document.getElementById('deadlinesDueSoon').textContent = dueSoon;
            document.getElementById('deadlinesUpcoming').textContent = upcoming;
            
            // Group deadlines by area
            const deadlinesByArea = {};
            deadlines.forEach(deadline => {
                if (!deadlinesByArea[deadline.area]) {
                    deadlinesByArea[deadline.area] = [];
                }
                deadlinesByArea[deadline.area].push(deadline);
            });
            
            // Sort deadlines within each area by due date
            Object.keys(deadlinesByArea).forEach(area => {
                deadlinesByArea[area].sort((a, b) => a.dueDate - b.dueDate);
            });
            
            // Debug: log deadlines found
            console.log('displayDeadlines - Total deadlines found:', deadlines.length);
            console.log('displayDeadlines - Records processed:', data.compliance_records?.length || 0);
            
            // Display deadlines
            if (deadlines.length === 0) {
                deadlinesContent.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--anac-gray-600);">
                        <div style="font-size: 48px; margin-bottom: 16px;">‚úÖ</div>
                        <p style="margin-bottom: 10px;">Nenhum prazo cadastrado no momento.</p>
                        <p style="font-size: 13px; color: #999; margin-top: 10px;">
                            Para adicionar prazos, marque os itens de a√ß√£o nas normas e defina as datas de vencimento.
                        </p>
                    </div>
                `;
                return;
            }
            
            let html = '<div style="display: grid; gap: 20px;">';
            
            const areaOrder = [
                'Gest√£o da CAT',
                'Gest√£o de Equipamentos',
                'Gest√£o de Recursos Humanos',
                'Gest√£o Operacional',
                'Gest√£o de Infraestrutura',
                'Gest√£o de Documenta√ß√£o',
                'Seguran√ßa Contra Inc√™ndio',
                'Seguran√ßa Operacional',
                'Seguran√ßa da Avia√ß√£o (AVSEC)',
                'Infraestrutura',
                'RBAC-154 - Conformidade Geral'
            ];
            
            // Also include any areas found in deadlines that aren't in the order list
            Object.keys(deadlinesByArea).forEach(area => {
                if (!areaOrder.includes(area)) {
                    areaOrder.push(area);
                }
            });
            
            areaOrder.forEach(areaName => {
                const areaDeadlines = deadlinesByArea[areaName];
                if (!areaDeadlines || areaDeadlines.length === 0) return;
                
                const areaInfo = getAreaInfo(areaName);
                
                html += `
                    <div style="background: white; border: 2px solid ${areaInfo.color}40; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="margin: 0 0 15px 0; font-size: 18px; color: var(--anac-primary); display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 24px;">${areaInfo.icon}</span>
                            <span>${areaName}</span>
                            <span style="font-size: 14px; color: #666; font-weight: normal;">(${areaDeadlines.length} prazo${areaDeadlines.length > 1 ? 's' : ''})</span>
                        </h3>
                        <div style="display: grid; gap: 10px;">
                `;
                
                areaDeadlines.forEach(deadline => {
                    const dueDateStr = deadline.dueDate.toLocaleDateString('pt-BR');
                    const statusColors = {
                        'overdue': { bg: '#fee2e2', border: '#ef4444', text: '#dc2626', label: 'Vencido' },
                        'due_soon': { bg: '#fef3c7', border: '#f59e0b', text: '#d97706', label: 'Vencendo' },
                        'upcoming': { bg: '#dbeafe', border: '#3b82f6', text: '#2563eb', label: 'Pr√≥ximo' }
                    };
                    const statusInfo = statusColors[deadline.status] || statusColors['upcoming'];
                    
                    const typeIcons = {
                        'action_item': 'üìù',
                        'maintenance': 'üîß',
                        'test': '‚è±Ô∏è',
                        'training': 'üéì'
                    };
                    const typeIcon = typeIcons[deadline.type] || 'üìÖ';
                    
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: ${statusInfo.bg}; border-left: 4px solid ${statusInfo.border}; border-radius: 6px;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                    <span style="font-size: 18px;">${typeIcon}</span>
                                    <strong style="color: ${statusInfo.text};">${deadline.description}</strong>
                                    <span style="padding: 2px 8px; background: ${statusInfo.border}; color: white; border-radius: 12px; font-size: 11px; font-weight: 600;">
                                        ${statusInfo.label}
                                    </span>
                                </div>
                                <div style="font-size: 13px; color: #666; margin-left: 26px;">
                                    ${deadline.regulationCode}: ${deadline.regulationTitle}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 16px; font-weight: 600; color: ${statusInfo.text};">
                                    ${dueDateStr}
                                </div>
                                <div style="font-size: 12px; color: #666;">
                                    ${deadline.daysDiff < 0 ? `${Math.abs(deadline.daysDiff)} dia${Math.abs(deadline.daysDiff) > 1 ? 's' : ''} atrasado` : 
                                      deadline.daysDiff === 0 ? 'Hoje' : 
                                      deadline.daysDiff === 1 ? 'Amanh√£' : 
                                      `Em ${deadline.daysDiff} dias`}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            // Store deadlines globally for calendar view
            window.currentDeadlines = deadlines;
            window.currentDeadlinesData = data;
            window.currentDeadlinesView = 'list';
            
            deadlinesContent.innerHTML = html;
        }
        
        // Switch deadlines view
        function switchDeadlinesView(view) {
            window.currentDeadlinesView = view;
            
            const listBtn = document.getElementById('deadlines-view-list');
            const calendarBtn = document.getElementById('deadlines-view-calendar');
            
            if (listBtn && calendarBtn) {
                if (view === 'list') {
                    listBtn.style.background = 'var(--anac-primary)';
                    calendarBtn.style.background = '#6b7280';
                    displayDeadlinesList();
                } else {
                    listBtn.style.background = '#6b7280';
                    calendarBtn.style.background = 'var(--anac-primary)';
                    displayDeadlinesCalendar();
                }
            }
        }
        
        // Display deadlines as list (existing function)
        function displayDeadlinesList() {
            if (!window.currentDeadlines || !window.currentDeadlinesData) {
                return;
            }
            displayDeadlines(window.currentDeadlinesData);
        }
        
        // Display deadlines as calendar
        function displayDeadlinesCalendar() {
            const deadlinesContent = document.getElementById('deadlinesContent');
            if (!deadlinesContent || !window.currentDeadlines) {
                return;
            }
            
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            // Get first day of month and number of days
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            
            // Group deadlines by date
            const deadlinesByDate = {};
            window.currentDeadlines.forEach(deadline => {
                const dateKey = deadline.dueDate.toISOString().split('T')[0];
                if (!deadlinesByDate[dateKey]) {
                    deadlinesByDate[dateKey] = [];
                }
                deadlinesByDate[dateKey].push(deadline);
            });
            
            const monthNames = [
                'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
            ];
            
            const dayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
            
            let html = `
                <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: var(--anac-primary); font-size: 20px;">
                            ${monthNames[currentMonth]} ${currentYear}
                        </h3>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="changeDeadlinesMonth(-1)" style="padding: 8px 12px; background: var(--anac-gray-200); border: none; border-radius: 6px; cursor: pointer;">
                                ‚Üê
                            </button>
                            <button onclick="changeDeadlinesMonth(1)" style="padding: 8px 12px; background: var(--anac-gray-200); border: none; border-radius: 6px; cursor: pointer;">
                                ‚Üí
                            </button>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px;">
                        ${dayNames.map(day => `
                            <div style="text-align: center; font-weight: 600; color: var(--anac-primary); padding: 8px;">
                                ${day}
                            </div>
                        `).join('')}
            `;
            
            // Add empty cells for days before month starts
            for (let i = 0; i < startingDayOfWeek; i++) {
                html += '<div style="padding: 8px; min-height: 60px;"></div>';
            }
            
            // Add cells for each day
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentYear, currentMonth, day);
                const dateKey = date.toISOString().split('T')[0];
                const dayDeadlines = deadlinesByDate[dateKey] || [];
                
                const isToday = date.toDateString() === today.toDateString();
                const isPast = date < today && !isToday;
                
                let bgColor = '#ffffff';
                let borderColor = '#e0e0e0';
                if (isToday) {
                    bgColor = '#dbeafe';
                    borderColor = '#3b82f6';
                } else if (isPast) {
                    bgColor = '#f3f4f6';
                }
                
                html += `
                    <div style="padding: 8px; min-height: 80px; border: 2px solid ${borderColor}; border-radius: 6px; background: ${bgColor}; ${isToday ? 'box-shadow: 0 0 0 2px var(--anac-primary);' : ''}">
                        <div style="font-weight: ${isToday ? 'bold' : 'normal'}; color: ${isToday ? 'var(--anac-primary)' : '#333'}; margin-bottom: 4px;">
                            ${day}
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 4px;">
                `;
                
                dayDeadlines.slice(0, 3).forEach(deadline => {
                    const statusColors = {
                        'overdue': { bg: '#fee2e2', text: '#dc2626' },
                        'due_soon': { bg: '#fef3c7', text: '#d97706' },
                        'upcoming': { bg: '#dbeafe', text: '#2563eb' }
                    };
                    const statusInfo = statusColors[deadline.status] || statusColors['upcoming'];
                    
                    html += `
                        <div style="font-size: 10px; padding: 2px 4px; background: ${statusInfo.bg}; color: ${statusInfo.text}; border-radius: 3px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${deadline.description}">
                            ${deadline.description.substring(0, 15)}${deadline.description.length > 15 ? '...' : ''}
                        </div>
                    `;
                });
                
                if (dayDeadlines.length > 3) {
                    html += `
                        <div style="font-size: 10px; color: #666; font-weight: 600;">
                            +${dayDeadlines.length - 3} mais
                        </div>
                    `;
                }
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            html += `
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #333;">Legenda:</h4>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <div style="width: 16px; height: 16px; background: #fee2e2; border: 1px solid #ef4444; border-radius: 3px;"></div>
                                <span style="font-size: 12px;">Vencido</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <div style="width: 16px; height: 16px; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 3px;"></div>
                                <span style="font-size: 12px;">Vencendo (30 dias)</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <div style="width: 16px; height: 16px; background: #dbeafe; border: 1px solid #3b82f6; border-radius: 3px;"></div>
                                <span style="font-size: 12px;">Pr√≥ximo</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            deadlinesContent.innerHTML = html;
        }
        
        // Change calendar month
        let currentDeadlinesMonth = new Date().getMonth();
        let currentDeadlinesYear = new Date().getFullYear();
        
        function changeDeadlinesMonth(delta) {
            currentDeadlinesMonth += delta;
            if (currentDeadlinesMonth < 0) {
                currentDeadlinesMonth = 11;
                currentDeadlinesYear--;
            } else if (currentDeadlinesMonth > 11) {
                currentDeadlinesMonth = 0;
                currentDeadlinesYear++;
            }
            
            // Re-render calendar with new month
            if (window.currentDeadlinesView === 'calendar') {
                displayDeadlinesCalendar();
            }
        }
        
        // Load Areas SESCINC
        async function loadAreas() {
            const areasContent = document.getElementById('areasContent');
            if (!areasContent) return;
            
            try {
                areasContent.innerHTML = '<div class="loading">Carregando √°reas funcionais...</div>';
                
                // Load airports into select if not already loaded
                const areasAirportSelect = document.getElementById('areasAirportSelect');
                if (areasAirportSelect) {
                    // Always reload to ensure it's up to date
                    try {
                        const airportsResponse = await fetch(`${API_BASE}/airports`);
                        if (airportsResponse.ok) {
                            const airports = await airportsResponse.json();
                            areasAirportSelect.innerHTML = '<option value="">Selecione um aeroporto...</option>';
                            airports.forEach(airport => {
                                const option = document.createElement('option');
                                option.value = airport.id;
                                option.textContent = `${airport.name} (${airport.code})`;
                                areasAirportSelect.appendChild(option);
                            });
                            
                            // Restore selected airport if exists, otherwise auto-select first
                            if (window.selectedAirportId) {
                                areasAirportSelect.value = window.selectedAirportId;
                            } else if (airports.length > 0) {
                                // Auto-select first airport
                                areasAirportSelect.value = airports[0].id;
                                window.selectedAirportId = airports[0].id;
                            } else if (airports.length > 0) {
                                // Auto-select first airport
                                areasAirportSelect.value = airports[0].id;
                                window.selectedAirportId = airports[0].id;
                            }
                        }
                    } catch (e) {
                        console.error('Error loading airports:', e);
                    }
                }
                
                // Get selected airport - check areasAirportSelect, airportSelect, and window.selectedAirportId
                let airportId = null;
                
                if (areasAirportSelect && areasAirportSelect.value) {
                    airportId = parseInt(areasAirportSelect.value);
                    window.selectedAirportId = airportId; // Store for other tabs
                } else {
                    const airportSelect = document.getElementById('airportSelect');
                    if (airportSelect && airportSelect.value) {
                        airportId = parseInt(airportSelect.value);
                    } else if (window.selectedAirportId) {
                        airportId = parseInt(window.selectedAirportId);
                    }
                }
                
                if (!airportId) {
                    // Check if areasAirportSelect has a value (might have been auto-selected during load)
                    if (areasAirportSelect && areasAirportSelect.value) {
                        airportId = parseInt(areasAirportSelect.value);
                        window.selectedAirportId = airportId;
                        console.log('Using airport from areasAirportSelect after auto-select:', airportId);
                    } else {
                        // No airport selected, show message
                        areasContent.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: var(--anac-gray-600);">
                                <div style="font-size: 48px; margin-bottom: 16px;">üöí</div>
                                <p style="margin-bottom: 10px; font-size: 16px; font-weight: 600;">Nenhum aeroporto selecionado</p>
                                <p style="margin-bottom: 20px; color: #666;">Selecione um aeroporto no campo acima ou:</p>
                                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                                    <button onclick="switchTab('manage')" style="padding: 12px 24px; background: var(--anac-primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
                                        ‚úàÔ∏è Cadastrar Aeroporto
                                    </button>
                                    <button onclick="switchTab('compliance')" style="padding: 12px 24px; background: var(--anac-success); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
                                        ‚úÖ Verificar Conformidade
                                    </button>
                                </div>
                            </div>
                        `;
                        return;
                    }
                }
                
                // Fetch compliance data
                const response = await fetch(`${API_BASE}/compliance/check`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ airport_id: airportId })
                });
                
                if (!response.ok) {
                    throw new Error('Erro ao carregar dados de conformidade');
                }
                
                const data = await response.json();
                window.currentComplianceData = data;  // Store for "Ver Detalhes" to use
                displayAreasFunctional(data);
                
            } catch (error) {
                areasContent.innerHTML = `
                    <div class="error" role="alert">
                        <strong>Erro:</strong> ${error.message}
                    </div>
                `;
                showToast('Erro ao carregar √°reas funcionais', 'error');
            }
        }
        
        // Display areas functional view
        function displayAreasFunctional(data) {
            const areasContent = document.getElementById('areasContent');
            if (!areasContent) {
                console.error('areasContent element not found');
                return;
            }
            
            // Debug: log received data
            console.log('displayAreasFunctional - Received data:', data);
            console.log('displayAreasFunctional - Compliance records count:', data.compliance_records?.length || 0);
            
            // Helper function to get functional area for RBAC-153 regulations
            function getFunctionalArea(code) {
                if (!code || !code.startsWith('RBAC-153')) return null;
                
                const areaMap = {
                    'RBAC-153-01': 'Gest√£o da CAT',
                    'RBAC-153-02': 'Gest√£o da CAT',
                    'RBAC-153-03': 'Gest√£o de Equipamentos',
                    'RBAC-153-04': 'Gest√£o de Equipamentos',
                    'RBAC-153-05': 'Gest√£o de Equipamentos',
                    'RBAC-153-09': 'Gest√£o de Equipamentos',
                    'RBAC-153-06': 'Gest√£o de Recursos Humanos',
                    'RBAC-153-08': 'Gest√£o de Recursos Humanos',
                    'RBAC-153-10': 'Gest√£o de Recursos Humanos',
                    'RBAC-153-07': 'Gest√£o Operacional',
                    'RBAC-153-11': 'Gest√£o Operacional',
                    'RBAC-153-12': 'Gest√£o de Infraestrutura',
                    'RBAC-153-13': 'Gest√£o de Infraestrutura',
                    'RBAC-153-14': 'Gest√£o de Documenta√ß√£o'
                };
                
                return areaMap[code] || null;
            }
            
            // Helper function to get area info
            function getAreaInfo(areaName) {
                const areaInfoMap = {
                    'Gest√£o da CAT': { icon: 'üìã', desc: 'Categoria Contrainc√™ndio e Opera√ß√µes Compat√≠veis', color: '#3b82f6' },
                    'Gest√£o de Equipamentos': { icon: 'üöõ', desc: 'CCI, Ve√≠culos de Apoio, Agentes Extintores e Equipamentos', color: '#8b5cf6' },
                    'Gest√£o de Recursos Humanos': { icon: 'üë•', desc: 'Equipe, Capacita√ß√£o e Treinamento Recorrente', color: '#10b981' },
                    'Gest√£o Operacional': { icon: '‚öôÔ∏è', desc: 'Tempo-Resposta e Plano Contrainc√™ndio (PCINC)', color: '#f59e0b' },
                    'Gest√£o de Infraestrutura': { icon: 'üèóÔ∏è', desc: 'SCI e Posto Avan√ßado (PACI)', color: '#ef4444' },
                    'Gest√£o de Documenta√ß√£o': { icon: 'üìÑ', desc: 'Comunica√ß√£o e Notifica√ß√µes √† ANAC', color: '#6b7280' }
                };
                return areaInfoMap[areaName] || { icon: 'üìÅ', desc: '', color: '#6b7280' };
            }
            
            // Group records by functional area
            const areasData = {};
            let rbac153Count = 0;
            
            if (!data.compliance_records || data.compliance_records.length === 0) {
                areasContent.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--anac-gray-600);">
                        <div style="font-size: 48px; margin-bottom: 16px;">üìã</div>
                        <p>Nenhum registro de conformidade encontrado para este aeroporto.</p>
                    </div>
                `;
                return;
            }
            
            data.compliance_records.forEach(record => {
                const regulation = record.regulation || {};
                const code = regulation.code || '';
                const areaName = getFunctionalArea(code);
                
                if (!areaName) return; // Skip non-RBAC-153 records
                
                rbac153Count++;
                
                if (!areasData[areaName]) {
                    areasData[areaName] = {
                        records: [],
                        compliant: 0,
                        partial: 0,
                        nonCompliant: 0,
                        pending: 0
                    };
                }
                
                areasData[areaName].records.push(record);
                
                const status = typeof record.status === 'string' 
                    ? record.status 
                    : (record.status?.value || 'pending_review');
                
                if (status === 'compliant') areasData[areaName].compliant++;
                else if (status === 'partial') areasData[areaName].partial++;
                else if (status === 'non_compliant') areasData[areaName].nonCompliant++;
                else areasData[areaName].pending++;
            });
            
            // Sort areas by priority
            const areaOrder = [
                'Gest√£o da CAT',
                'Gest√£o de Equipamentos',
                'Gest√£o de Recursos Humanos',
                'Gest√£o Operacional',
                'Gest√£o de Infraestrutura',
                'Gest√£o de Documenta√ß√£o'
            ];
            
            let html = '<div style="display: grid; gap: 20px;">';
            
            areaOrder.forEach(areaName => {
                const areaData = areasData[areaName];
                if (!areaData || areaData.records.length === 0) return;
                
                const areaInfo = getAreaInfo(areaName);
                const total = areaData.records.length;
                const compliantPercentage = Math.round((areaData.compliant / total) * 100);
                
                html += `
                    <div style="background: white; border: 2px solid ${areaInfo.color}40; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                            <div style="flex: 1;">
                                <h3 style="margin: 0 0 8px 0; font-size: 20px; color: var(--anac-primary); display: flex; align-items: center; gap: 10px;">
                                    <span style="font-size: 28px;">${areaInfo.icon}</span>
                                    <span>${areaName}</span>
                                </h3>
                                <p style="margin: 0; color: #666; font-size: 13px;">${areaInfo.desc}</p>
                            </div>
                            <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                                <div style="text-align: center; padding: 10px 15px; background: #f8f9fa; border-radius: 8px;">
                                    <div style="font-size: 28px; font-weight: bold; color: var(--anac-primary);">${total}</div>
                                    <div style="font-size: 11px; color: #666; margin-top: 4px;">norma${total > 1 ? 's' : ''}</div>
                                </div>
                                <div style="text-align: center; padding: 10px 15px; background: #d4edda; border-radius: 8px;">
                                    <div style="font-size: 28px; font-weight: bold; color: #10b981;">${compliantPercentage}%</div>
                                    <div style="font-size: 11px; color: #666; margin-top: 4px;">conforme</div>
                                </div>
                                ${areaData.nonCompliant > 0 ? `
                                    <div style="text-align: center; padding: 10px 15px; background: #f8d7da; border-radius: 8px;">
                                        <div style="font-size: 24px; font-weight: bold; color: #ef4444;">${areaData.nonCompliant}</div>
                                        <div style="font-size: 11px; color: #666; margin-top: 4px;">n√£o conforme</div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button onclick="viewAreaDetails('${areaName}')" style="padding: 10px 20px; background: ${areaInfo.color}; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
                                Ver Detalhes
                            </button>
                            <button onclick="exportAreaReport('${areaName}')" style="padding: 10px 20px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
                                üì• Exportar Excel
                            </button>
                            <button onclick="generateAreaReport('${areaName}')" style="padding: 10px 20px; background: var(--anac-primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
                                üìÑ Gerar Relat√≥rio PDF
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            // If no areas found, show message
            if (Object.keys(areasData).length === 0) {
                html = `
                    <div style="text-align: center; padding: 40px; color: var(--anac-gray-600);">
                        <div style="font-size: 48px; margin-bottom: 16px;">üöí</div>
                        <p style="margin-bottom: 10px; font-size: 16px; font-weight: 600;">Nenhuma √°rea funcional SESCINC encontrada</p>
                        <p style="font-size: 13px; color: #999; margin-bottom: 5px;">Total de registros RBAC-153 processados: ${rbac153Count}</p>
                        <p style="font-size: 13px; color: #999; margin-bottom: 15px;">Total de registros recebidos: ${data.compliance_records?.length || 0}</p>
                        <p style="font-size: 12px; color: #999; margin-top: 15px;">
                            Certifique-se de que o aeroporto selecionado possui normas RBAC-153 aplic√°veis.
                        </p>
                        <p style="font-size: 12px; color: #999; margin-top: 10px;">
                            Se voc√™ acabou de cadastrar um aeroporto, v√° para a aba "Verificar Conformidade" para gerar os registros de conformidade.
                        </p>
                    </div>
                `;
            }
            
            areasContent.innerHTML = html;
            console.log('displayAreasFunctional - Areas found:', Object.keys(areasData).length, 'RBAC-153 records:', rbac153Count);
            
            // If areas were found but no area cards were rendered (e.g. area names don't match areaOrder)
            if (Object.keys(areasData).length > 0 && !html.includes('Ver Detalhes')) {
                console.error('BUG: Areas found but HTML not generated correctly!', areasData);
                areasContent.innerHTML = `
                    <div class="error" role="alert">
                        <strong>Erro:</strong> √Åreas encontradas mas n√£o foram renderizadas. Verifique o console para mais detalhes.
                    </div>
                `;
            }
        }
        
        // View area details
        function viewAreaDetails(areaName) {
            // Switch to compliance tab
            switchTab('compliance');
            
            // Wait for compliance data to load, then filter
            setTimeout(() => {
                if (window.currentComplianceData) {
                    filterByArea(areaName);
                } else {
                    // If data not loaded yet, wait a bit more
                    setTimeout(() => {
                        if (window.currentComplianceData) {
                            filterByArea(areaName);
                        }
                    }, 500);
                }
            }, 300);
        }
        
        // Filter compliance records by area
        function filterByArea(areaName) {
            const contentDiv = document.getElementById('complianceContent');
            if (!contentDiv || !window.currentComplianceData) return;
            
            // Helper functions
            function getFunctionalArea(code) {
                if (!code || !code.startsWith('RBAC-153')) return null;
                const areaMap = {
                    'RBAC-153-01': 'Gest√£o da CAT', 'RBAC-153-02': 'Gest√£o da CAT',
                    'RBAC-153-03': 'Gest√£o de Equipamentos', 'RBAC-153-04': 'Gest√£o de Equipamentos',
                    'RBAC-153-05': 'Gest√£o de Equipamentos', 'RBAC-153-09': 'Gest√£o de Equipamentos',
                    'RBAC-153-06': 'Gest√£o de Recursos Humanos', 'RBAC-153-08': 'Gest√£o de Recursos Humanos',
                    'RBAC-153-10': 'Gest√£o de Recursos Humanos',
                    'RBAC-153-07': 'Gest√£o Operacional', 'RBAC-153-11': 'Gest√£o Operacional',
                    'RBAC-153-12': 'Gest√£o de Infraestrutura', 'RBAC-153-13': 'Gest√£o de Infraestrutura',
                    'RBAC-153-14': 'Gest√£o de Documenta√ß√£o'
                };
                return areaMap[code] || null;
            }
            
            // Filter records
            const filteredData = {
                ...window.currentComplianceData,
                compliance_records: window.currentComplianceData.compliance_records.filter(record => {
                    const code = record.regulation?.code || '';
                    const functionalArea = getFunctionalArea(code);
                    return functionalArea === areaName;
                })
            };
            
            // Recalculate counts
            filteredData.total_regulations = filteredData.compliance_records.length;
            filteredData.compliant_count = filteredData.compliance_records.filter(r => {
                const status = typeof r.status === 'string' ? r.status : (r.status?.value || '');
                return status === 'compliant';
            }).length;
            filteredData.non_compliant_count = filteredData.compliance_records.filter(r => {
                const status = typeof r.status === 'string' ? r.status : (r.status?.value || '');
                return status === 'non_compliant';
            }).length;
            filteredData.partial_count = filteredData.compliance_records.filter(r => {
                const status = typeof r.status === 'string' ? r.status : (r.status?.value || '');
                return status === 'partial';
            }).length;
            filteredData.pending_count = filteredData.compliance_records.filter(r => {
                const status = typeof r.status === 'string' ? r.status : (r.status?.value || '');
                return status === 'pending_review';
            }).length;
            
            // Re-render with filtered data
            displayCompliance(filteredData);
            
            // Add filter indicator
            const filterIndicator = document.createElement('div');
            filterIndicator.id = 'area-filter-indicator';
            filterIndicator.style.cssText = `
                background: linear-gradient(135deg, var(--anac-primary) 0%, var(--anac-primary-light) 100%);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                margin-bottom: 20px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            `;
            filterIndicator.innerHTML = `
                <div>
                    <strong>Filtro Ativo:</strong> ${areaName}
                    <span style="font-size: 12px; opacity: 0.9; margin-left: 10px;">
                        (${filteredData.total_regulations} norma${filteredData.total_regulations !== 1 ? 's' : ''})
                    </span>
                </div>
                <button onclick="clearAreaFilter()" style="padding: 6px 12px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 4px; cursor: pointer; font-size: 12px;">
                    Limpar Filtro
                </button>
            `;
            
            // Insert at the beginning
            const firstChild = contentDiv.firstElementChild;
            if (firstChild && firstChild.id !== 'area-filter-indicator') {
                contentDiv.insertBefore(filterIndicator, firstChild);
            } else if (!firstChild) {
                contentDiv.appendChild(filterIndicator);
            }
            
            showToast(`Filtrado por √°rea: ${areaName}`, 'info');
        }
        
        // Clear area filter
        function clearAreaFilter() {
            const indicator = document.getElementById('area-filter-indicator');
            if (indicator) {
                indicator.remove();
            }
            
            if (window.currentComplianceData) {
                displayCompliance(window.currentComplianceData);
            }
            
            showToast('Filtro removido', 'info');
        }
        
        // Export area report (already implemented above)
        
        // Load dashboard
        async function loadDashboard() {
            try {
                const response = await fetch(`${API_BASE}/airports`);
                const airports = await response.json();
                
                // Update stats
                document.getElementById('totalAirports').textContent = airports.length;
                
                // Load compliance data for stats
                let compliantCount = 0;
                let pendingCount = 0;
                let nonCompliantCount = 0;
                
                for (const airport of airports) {
                    try {
                        const complianceResponse = await fetch(`${API_BASE}/compliance/check`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ airport_id: airport.id })
                        });
                        if (complianceResponse.ok) {
                            const complianceData = await complianceResponse.json();
                            if (complianceData.anac_scores && complianceData.anac_scores.essential_compliant) {
                                compliantCount++;
                            } else if (complianceData.non_compliant_count > 0) {
                                nonCompliantCount++;
                            } else if (complianceData.pending_count > 0) {
                                pendingCount++;
                            } else {
                                pendingCount++;
                            }
                        } else {
                            pendingCount++;
                        }
                    } catch (e) {
                        pendingCount++;
                    }
                }
                
                document.getElementById('compliantAirports').textContent = compliantCount;
                document.getElementById('pendingAirports').textContent = pendingCount;
                document.getElementById('nonCompliantAirports').textContent = nonCompliantCount;
                
                // Display airport list with quick actions
                const listDiv = document.getElementById('dashboardAirportList');
                
                if (airports.length === 0) {
                    listDiv.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--anac-gray-600);">
                            <div style="font-size: 48px; margin-bottom: 16px;">‚úàÔ∏è</div>
                            <p style="margin-bottom: 20px;">Nenhum aeroporto cadastrado ainda.</p>
                            <button onclick="switchTab('manage')" style="padding: 12px 24px; background: var(--anac-primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
                                Cadastrar Primeiro Aeroporto
                            </button>
                        </div>
                    `;
                    return;
                }
                
                listDiv.innerHTML = airports.map(airport => `
                    <div class="airport-item" style="display: flex; justify-content: space-between; align-items: center; padding: 16px; border: 1px solid var(--anac-gray-200); border-radius: 8px; margin-bottom: 12px; transition: all 0.2s ease; cursor: pointer;" 
                         onclick="viewAirportCompliance(${airport.id})"
                         onmouseover="this.style.background='var(--anac-gray-50)'; this.style.borderColor='var(--anac-primary)';"
                         onmouseout="this.style.background='white'; this.style.borderColor='var(--anac-gray-200)';">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                <strong style="font-size: 16px; color: var(--anac-primary);">${airport.name}</strong>
                                <span style="background: var(--anac-primary-light); color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">${airport.code}</span>
                                ${airport.usage_class ? `<span style="background: var(--anac-gray-200); color: var(--anac-gray-700); padding: 2px 8px; border-radius: 4px; font-size: 12px;">Classe ${airport.usage_class}</span>` : ''}
                                ${airport.avsec_classification ? `<span style="background: var(--anac-primary-light); color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin-left: 4px;">${airport.avsec_classification}</span>` : ''}
                            </div>
                            <div style="display: flex; gap: 16px; font-size: 13px; color: var(--anac-gray-600);">
                                ${airport.usage_class ? `<span>${airport.usage_class === 'PRIVADO' ? 'Privado' : `Classe ${airport.usage_class}`}</span>` : ''}
                                ${airport.usage_class ? `<span>‚Ä¢</span>` : ''}
                                <span>${getTypeLabel(airport.airport_type)}</span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;" onclick="event.stopPropagation();">
                            <button onclick="event.stopPropagation(); viewAirportCompliance(${airport.id})" 
                                    style="padding: 8px 16px; background: var(--anac-primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; white-space: nowrap;">
                                ‚úÖ Verificar Conformidade
                            </button>
                            <button onclick="event.stopPropagation(); editAirport(${airport.id})" 
                                    style="padding: 8px 16px; background: var(--anac-gray-200); color: var(--anac-gray-700); border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; white-space: nowrap;">
                                ‚úèÔ∏è Editar
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading dashboard:', error);
                document.getElementById('dashboardAirportList').innerHTML = 
                    '<div class="error">Erro ao carregar dashboard</div>';
            }
        }
        
        // View airport compliance from dashboard
        async function viewAirportCompliance(airportId) {
            switchTab('compliance');
            const airportSelect = document.getElementById('airportSelect');
            if (airportSelect) {
                airportSelect.value = airportId;
            }
            // Store selected airport ID for other tabs
            window.selectedAirportId = airportId;
            await checkCompliance(airportId);
            await loadAirportInfo(airportId);
            updateBreadcrumbs('compliance');
            document.getElementById('breadcrumbCurrent').querySelector('span').textContent = `Conformidade - Aeroporto #${airportId}`;
        }
        
        // Load airports for management
        async function loadAirports() {
            try {
                const response = await fetch(`${API_BASE}/airports`);
                const airports = await response.json();
                
                const listDiv = document.getElementById('airportList');
                
                if (airports.length === 0) {
                    listDiv.innerHTML = '<div class="loading">Nenhum aeroporto cadastrado. Use o formul√°rio ao lado para cadastrar.</div>';
                    return;
                }
                
                listDiv.innerHTML = airports.map(airport => `
                    <div class="airport-item" onclick="selectAirport(${airport.id})">
                        <strong>${airport.name}</strong> (${airport.code})<br>
                        <small style="color: #666;">${airport.usage_class ? (airport.usage_class === 'PRIVADO' ? 'Privado' : `Classe ${airport.usage_class}`) : 'N/A'} ‚Ä¢ ${getTypeLabel(airport.airport_type)}</small>
                        <div style="margin-top: 10px; display: flex; gap: 5px;">
                            <button onclick="event.stopPropagation(); editAirport(${airport.id})" style="padding: 5px 10px; font-size: 12px; width: auto;">Editar</button>
                            <button onclick="event.stopPropagation(); deleteAirport(${airport.id})" class="danger" style="padding: 5px 10px; font-size: 12px; width: auto;">Excluir</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading airports:', error);
                document.getElementById('airportList').innerHTML = 
                    '<div class="error">Erro ao carregar aeroportos</div>';
            }
        }
        
        // Load airports for compliance check
        async function loadAirportsForCompliance() {
            try {
                const response = await fetch(`${API_BASE}/airports`);
                const airports = await response.json();
                
                const select = document.getElementById('airportSelect');
                if (!select) return;
                
                select.innerHTML = '<option value="">Selecione um aeroporto...</option>';
                
                airports.forEach(airport => {
                    const option = document.createElement('option');
                    option.value = airport.id;
                    option.textContent = `${airport.name} (${airport.code})`;
                    select.appendChild(option);
                });
                
                // Restore selected airport if exists
                if (window.selectedAirportId) {
                    select.value = window.selectedAirportId;
                }
                
                // Remove existing listener if any (to avoid duplicates)
                const newSelect = select.cloneNode(true);
                select.parentNode.replaceChild(newSelect, select);
                
                // Add event listener to update other tabs when airport is selected
                document.getElementById('airportSelect').addEventListener('change', function() {
                    const airportId = this.value;
                    if (airportId) {
                        // Store selected airport ID for other tabs to use
                        window.selectedAirportId = airportId;
                        
                        // If deadlines or areas tabs are active, reload them
                        const deadlinesTab = document.getElementById('deadlinesTab');
                        const areasTab = document.getElementById('areasTab');
                        
                        if (deadlinesTab && deadlinesTab.classList.contains('active')) {
                            loadDeadlines();
                        }
                        if (areasTab && areasTab.classList.contains('active')) {
                            loadAreas();
                        }
                    } else {
                        window.selectedAirportId = null;
                    }
                });
            } catch (error) {
                console.error('Error loading airports:', error);
                const select = document.getElementById('airportSelect');
                if (select) {
                    select.innerHTML = '<option value="">Erro ao carregar aeroportos</option>';
                }
            }
        }
        
        // Form submission
        document.getElementById('airportForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            // Calcular size e annual_passengers automaticamente a partir de usage_class
            const usageClass = document.getElementById('usage_class').value;
            let calculatedSize = 'small'; // default
            let calculatedPassengers = null;
            
            if (usageClass === 'PRIVADO') {
                calculatedSize = 'small';
                calculatedPassengers = 0; // Privado n√£o tem passageiros comerciais
            } else if (usageClass === 'I') {
                calculatedSize = 'small';
                calculatedPassengers = 100000; // Estimativa m√©dia para Classe I
            } else if (usageClass === 'II') {
                calculatedSize = 'medium';
                calculatedPassengers = 600000; // Estimativa m√©dia para Classe II
            } else if (usageClass === 'III') {
                calculatedSize = 'large';
                calculatedPassengers = 3000000; // Estimativa m√©dia para Classe III
            } else if (usageClass === 'IV') {
                calculatedSize = 'international';
                calculatedPassengers = 10000000; // Estimativa m√©dia para Classe IV
            }
            
            const formData = {
                name: document.getElementById('name').value,
                code: document.getElementById('code').value.toUpperCase(),
                size: calculatedSize, // Calculado automaticamente
                airport_type: document.getElementById('airport_type').value,
                usage_class: document.getElementById('usage_class').value || null,
                avsec_classification: document.getElementById('avsec_classification').value || null,
                aircraft_size_category: document.getElementById('aircraft_size_category').value || null,
                reference_code: document.getElementById('reference_code').value || null,
                annual_passengers: calculatedPassengers, // Calculado automaticamente a partir de usage_class
                number_of_runways: parseInt(document.getElementById('number_of_runways').value),
                max_aircraft_weight: document.getElementById('max_aircraft_weight').value ? parseInt(document.getElementById('max_aircraft_weight').value) : null,
                has_international_operations: document.getElementById('has_international_operations').checked,
                has_cargo_operations: document.getElementById('has_cargo_operations').checked,
                has_maintenance_facility: document.getElementById('has_maintenance_facility').checked
            };
            
            // Validate all required fields
            const nameValid = validateField('name', document.getElementById('name').value);
            const codeValid = validateField('code', document.getElementById('code').value);
            
            if (!nameValid || !codeValid) {
                showToast('Por favor, corrija os erros no formul√°rio', 'error');
                return;
            }
            
            const submitBtn = document.getElementById('submitBtn');
            const submitBtnText = document.getElementById('submitBtnText');
            const originalText = submitBtnText.textContent;
            
            // Show loading state
            submitBtn.disabled = true;
            submitBtn.classList.add('btn-loading');
            submitBtnText.textContent = 'Salvando...';
            
            try {
                let response;
                if (currentEditingId) {
                    response = await fetch(`${API_BASE}/airports/${currentEditingId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                } else {
                    response = await fetch(`${API_BASE}/airports`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                }
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Erro ao salvar aeroporto');
                }
                
                const airport = await response.json();
                showToast('Aeroporto salvo com sucesso!', 'success');
                resetForm();
                loadAirports();
            } catch (error) {
                showToast(`Erro: ${error.message}`, 'error');
            } finally {
                // Reset button state
                submitBtn.disabled = false;
                submitBtn.classList.remove('btn-loading');
                submitBtnText.textContent = originalText;
            }
        });
        
        // Select airport (for viewing/editing)
        function selectAirport(id) {
            editAirport(id);
        }
        
        // Edit airport
        async function editAirport(id) {
            try {
                const response = await fetch(`${API_BASE}/airports/${id}`);
                const airport = await response.json();
                
                currentEditingId = airport.id;
                document.getElementById('airportId').value = airport.id;
                document.getElementById('name').value = airport.name;
                document.getElementById('code').value = airport.code;
                // size √© calculado automaticamente, n√£o precisa ser editado
                document.getElementById('airport_type').value = airport.airport_type;
                document.getElementById('usage_class').value = airport.usage_class || '';
                document.getElementById('avsec_classification').value = airport.avsec_classification || '';
                document.getElementById('aircraft_size_category').value = airport.aircraft_size_category || '';
                document.getElementById('reference_code').value = airport.reference_code || '';
                // annual_passengers √© calculado automaticamente, n√£o precisa ser editado
                document.getElementById('number_of_runways').value = airport.number_of_runways;
                document.getElementById('max_aircraft_weight').value = airport.max_aircraft_weight || '';
                document.getElementById('has_international_operations').checked = airport.has_international_operations;
                document.getElementById('has_cargo_operations').checked = airport.has_cargo_operations;
                document.getElementById('has_maintenance_facility').checked = airport.has_maintenance_facility;
                
                document.getElementById('formTitle').textContent = 'Editar Aeroporto';
                document.getElementById('submitBtn').textContent = 'Atualizar Aeroporto';
                document.getElementById('cancelBtn').style.display = 'block';
                
                document.getElementById('airportForm').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                showMessage(`Erro ao carregar aeroporto: ${error.message}`, 'error');
            }
        }
        
        // Delete airport
        async function deleteAirport(id) {
            // Use a more accessible confirmation
            const confirmed = confirm('Tem certeza que deseja excluir este aeroporto?');
            if (!confirmed) return;
            
            try {
                const response = await fetch(`${API_BASE}/airports/${id}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) throw new Error('Erro ao excluir aeroporto');
                
                showMessage('Aeroporto exclu√≠do com sucesso!', 'success');
                loadAirports();
            } catch (error) {
                showMessage(`Erro: ${error.message}`, 'error');
            }
        }
        
        // Reset form
        // Calculate ANAC classifications from annual passengers and aircraft weight
        function calculateANACClassifications() {
            const usageClassSelect = document.getElementById('usage_class');
            const avsecSelect = document.getElementById('avsec_classification');
            const aircraftSizeSelect = document.getElementById('aircraft_size_category');
            const maxAircraftWeight = parseInt(document.getElementById('max_aircraft_weight').value) || 0;
            const usageClass = usageClassSelect.value;
            
            // Calcular Classifica√ß√£o AVSEC baseado em usage_class
            if (usageClass) {
                if (usageClass === 'PRIVADO') {
                    avsecSelect.value = 'AP-0'; // Avia√ß√£o geral/t√°xi a√©reo/fretamento
                } else if (usageClass === 'I') {
                    avsecSelect.value = 'AP-1'; // < 600 mil pass./ano
                } else if (usageClass === 'II') {
                    avsecSelect.value = 'AP-1'; // 200k-1M, mas pode ser AP-1 ou AP-2
                    // Para Classe II, usar AP-1 como padr√£o (mais conservador)
                } else if (usageClass === 'III') {
                    avsecSelect.value = 'AP-2'; // 1M-5M pass./ano
                } else if (usageClass === 'IV') {
                    avsecSelect.value = 'AP-3'; // > 5 milh√µes pass./ano
                }
            }
            
            // Calcular Categoria de Porte da Aeronave (baseado em max_aircraft_weight)
            // Classifica√ß√£o ANAC/ICAO: A/B at√© 5.700 kg, C entre 5.700-136.000 kg, D acima de 136.000 kg
            if (maxAircraftWeight > 0) {
                const weightKg = maxAircraftWeight * 1000; // Converter toneladas para kg
                if (weightKg <= 5700) {
                    aircraftSizeSelect.value = 'A/B';
                } else if (weightKg <= 136000) {
                    aircraftSizeSelect.value = 'C';
                } else {
                    aircraftSizeSelect.value = 'D';
                }
            }
        }
        
        // Adicionar listeners para calcular classifica√ß√µes quando usage_class ou max_aircraft_weight mudarem
        document.addEventListener('DOMContentLoaded', function() {
            const usageClassSelect = document.getElementById('usage_class');
            const maxWeightInput = document.getElementById('max_aircraft_weight');
            
            if (usageClassSelect) {
                usageClassSelect.addEventListener('change', calculateANACClassifications);
            }
            if (maxWeightInput) {
                maxWeightInput.addEventListener('change', calculateANACClassifications);
            }
        });
        
        // ANAC Lookup Functions
        function updateLookupButton() {
            const codeInput = document.getElementById('code');
            const lookupBtn = document.getElementById('lookupAnacBtn');
            if (codeInput && lookupBtn) {
                const code = codeInput.value.trim().toUpperCase();
                lookupBtn.disabled = code.length !== 4 || !/^[A-Z]{4}$/.test(code);
            }
        }
        
        async function lookupAirportFromANAC() {
            const codeInput = document.getElementById('code');
            const statusDiv = document.getElementById('anac-lookup-status');
            const lookupBtn = document.getElementById('lookupAnacBtn');
            
            if (!codeInput || !statusDiv) return;
            
            const code = codeInput.value.trim().toUpperCase();
            
            if (code.length !== 4 || !/^[A-Z]{4}$/.test(code)) {
                showToast('C√≥digo ICAO deve ter exatamente 4 letras', 'error');
                return;
            }
            
            // Desabilitar bot√£o durante busca
            if (lookupBtn) lookupBtn.disabled = true;
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '<span style="color: var(--anac-info);">üîç Buscando dados da ANAC...</span>';
            
            try {
                const response = await fetch(`${API_BASE}/airports/lookup/${code}`);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: 'Erro desconhecido' }));
                    throw new Error(errorData.detail || `Erro ${response.status}`);
                }
                
                const data = await response.json();
                
                // Preencher todos os campos dispon√≠veis
                if (data.name) document.getElementById('name').value = data.name;
                if (data.reference_code) document.getElementById('reference_code').value = data.reference_code;
                if (data.usage_class) document.getElementById('usage_class').value = data.usage_class;
                if (data.avsec_classification) document.getElementById('avsec_classification').value = data.avsec_classification;
                if (data.aircraft_size_category) document.getElementById('aircraft_size_category').value = data.aircraft_size_category;
                if (data.airport_type) document.getElementById('airport_type').value = data.airport_type;
                
                // Calcular campos derivados (avsec, aircraft_size) a partir de usage_class/max_weight
                if (typeof calculateANACClassifications === 'function') {
                    calculateANACClassifications();
                }
                
                // Mostrar status de sucesso
                const sourceLabel = data.source === 'local' ? 'Cadastro local' : (data.source === 'anac_cache' ? 'ANAC (cache)' : 'ANAC');
                statusDiv.innerHTML = `<span style="color: var(--anac-success);">‚úÖ Dados da ${sourceLabel} - ${data.name || code}</span>`;
                statusDiv.style.display = 'block';
                
                showToast(`Dados preenchidos (${sourceLabel})`, 'success');
                
            } catch (error) {
                console.error('Erro ao buscar da ANAC:', error);
                statusDiv.innerHTML = `<span style="color: var(--anac-error);">‚ùå ${error.message}</span>`;
                statusDiv.style.display = 'block';
                showToast(`Erro: ${error.message}`, 'error');
            } finally {
                if (lookupBtn) {
                    updateLookupButton(); // Re-habilitar se c√≥digo ainda v√°lido
                }
            }
        }
        
        async function refreshAnacCache() {
            try {
                showToast('Atualizando cache ANAC...', 'info');
                const response = await fetch(`${API_BASE}/airports/sync/anac/refresh-cache`, { method: 'POST' });
                const data = await response.json().catch(() => ({}));
                if (response.ok) {
                    showToast(`Cache atualizado: ${data.airports_count || 0} aeroportos`, 'success');
                } else {
                    const msg = Array.isArray(data.detail) ? data.detail[0]?.msg : data.detail;
                    showToast(msg || 'Site da ANAC temporariamente indispon√≠vel. Tente novamente mais tarde ou quando a conex√£o estiver est√°vel.', 'error', 8000);
                }
            } catch (e) {
                showToast('Site da ANAC indispon√≠vel. A busca "Buscar da ANAC" usar√° o cache ou cadastro local.', 'warning', 8000);
            }
        }
        
        function resetForm() {
            document.getElementById('airportForm').reset();
            currentEditingId = null;
            document.getElementById('airportId').value = '';
            document.getElementById('formTitle').textContent = 'Cadastrar Novo Aeroporto';
            document.getElementById('submitBtn').textContent = 'Salvar Aeroporto';
            document.getElementById('cancelBtn').style.display = 'none';
            document.getElementById('formMessage').innerHTML = '';
            // Reset ANAC lookup status
            const statusDiv = document.getElementById('anac-lookup-status');
            if (statusDiv) {
                statusDiv.style.display = 'none';
                statusDiv.innerHTML = '';
            }
            updateLookupButton();
        }
        
        // Toast Notification System
        function showToast(message, type = 'info', duration = 5000) {
            const container = document.getElementById('toastContainer');
            if (!container) return;
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            toast.innerHTML = `
                <span class="toast-icon" aria-hidden="true">${icons[type] || icons.info}</span>
                <div class="toast-content">
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()" aria-label="Fechar notifica√ß√£o">√ó</button>
            `;
            
            container.appendChild(toast);
            
            // Auto-remove after duration
            if (duration > 0) {
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.style.animation = 'slideIn 0.3s ease-out reverse';
                        setTimeout(() => toast.remove(), 300);
                    }
                }, duration);
            }
        }
        
        // Show message (legacy support - now uses toast)
        function showMessage(message, type) {
            showToast(message, type === 'error' ? 'error' : type === 'success' ? 'success' : 'info');
        }
        
        // Form validation
        function validateField(fieldId, value) {
            const field = document.getElementById(fieldId);
            const errorElement = document.getElementById(`${fieldId}-error`);
            const formGroup = field.closest('.form-group');
            
            if (!field || !errorElement || !formGroup) return;
            
            let isValid = true;
            let errorMessage = '';
            
            switch(fieldId) {
                case 'name':
                    if (!value || value.trim().length < 3) {
                        isValid = false;
                        errorMessage = 'Nome deve ter pelo menos 3 caracteres';
                    }
                    break;
                case 'code':
                    if (!value || value.length !== 4) {
                        isValid = false;
                        errorMessage = 'C√≥digo ICAO deve ter exatamente 4 letras';
                    } else if (!/^[A-Z]{4}$/.test(value)) {
                        isValid = false;
                        errorMessage = 'C√≥digo ICAO deve conter apenas letras mai√∫sculas';
                    }
                    break;
            }
            
            if (isValid) {
                formGroup.classList.remove('error');
                formGroup.classList.add('success');
                errorElement.style.display = 'none';
                field.setAttribute('aria-invalid', 'false');
            } else {
                formGroup.classList.remove('success');
                formGroup.classList.add('error');
                errorElement.textContent = errorMessage;
                errorElement.style.display = 'block';
                field.setAttribute('aria-invalid', 'true');
                field.setAttribute('aria-describedby', `${fieldId}-help ${fieldId}-error`);
            }
            
            return isValid;
        }
        
        // Toggle form section
        function toggleSection(header) {
            const section = header.closest('.form-section');
            section.classList.toggle('collapsed');
        }
        
        // Helper functions
        function getSizeLabel(size) {
            const map = {
                    'small': 'Pequeno',
                    'medium': 'M√©dio',
                    'large': 'Grande',
                    'international': 'Internacional'
                };
            return map[size] || size;
        }
        
        function getPassengerRange(usageClass) {
            const map = {
                'PRIVADO': 'N/A (Uso restrito)',
                'I': '< 200.000 passageiros/ano',
                'II': '200.000 - 1.000.000 passageiros/ano',
                'III': '1.000.000 - 5.000.000 passageiros/ano',
                'IV': '> 5.000.000 passageiros/ano'
            };
            return map[usageClass] || 'N/A';
        }
                
        function getTypeLabel(type) {
            const map = {
                    'commercial': 'Comercial',
                    'general_aviation': 'Avia√ß√£o Geral',
                    'military': 'Militar',
                    'mixed': 'Misto'
                };
            return map[type] || type;
        }
        
        // Compliance check form
        // Initialize airport selection tracking
        window.selectedAirportId = null;
        
        document.getElementById('complianceForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const airportId = document.getElementById('airportSelect').value;
            
            if (!airportId) {
                showToast('Por favor, selecione um aeroporto', 'warning');
                return;
            }
            
            // Store selected airport ID for other tabs
            window.selectedAirportId = airportId;
            
            await checkCompliance(airportId);
            await loadAirportInfo(airportId);
            
            // Update other tabs if they are active
            const deadlinesTab = document.getElementById('deadlinesTab');
            const areasTab = document.getElementById('areasTab');
            
            if (deadlinesTab && deadlinesTab.classList.contains('active')) {
                loadDeadlines();
            }
            if (areasTab && areasTab.classList.contains('active')) {
                loadAreas();
            }
        });
        
        // Load airport information
        async function loadAirportInfo(airportId) {
            try {
                const response = await fetch(`${API_BASE}/airports/${airportId}`);
                const airport = await response.json();
                
                const infoDiv = document.getElementById('airportInfo');
                const detailsDiv = document.getElementById('airportDetails');
                
                detailsDiv.innerHTML = `
                    <p><strong>Tipo:</strong> ${getTypeLabel(airport.airport_type)}</p>
                    ${airport.usage_class ? `<p><strong>Classe por Uso (RBAC 153):</strong> ${airport.usage_class === 'PRIVADO' ? 'Privado' : `Classe ${airport.usage_class}`}</p>` : ''}
                    ${airport.avsec_classification ? `<p><strong>Classifica√ß√£o AVSEC:</strong> ${airport.avsec_classification}</p>` : ''}
                    ${airport.aircraft_size_category ? `<p><strong>Categoria de Porte da Aeronave:</strong> ${airport.aircraft_size_category}</p>` : ''}
                    ${airport.reference_code ? `<p><strong>C√≥digo de Refer√™ncia das Aeronaves:</strong> ${airport.reference_code}</p>` : ''}
                    ${airport.usage_class ? `<p><strong>Faixa de Passageiros/ano:</strong> ${getPassengerRange(airport.usage_class)}</p>` : ''}
                    <p><strong>Opera√ß√µes Internacionais:</strong> ${airport.has_international_operations ? 'Sim' : 'N√£o'}</p>
                    <p><strong>Opera√ß√µes de Carga:</strong> ${airport.has_cargo_operations ? 'Sim' : 'N√£o'}</p>
                    <p><strong>Pistas:</strong> ${airport.number_of_runways}</p>
                `;
                
                infoDiv.style.display = 'block';
            } catch (error) {
                console.error('Error loading airport info:', error);
            }
        }
        
        // Check compliance
        async function checkCompliance(airportId) {
            const contentDiv = document.getElementById('complianceContent');
            const checkBtn = document.getElementById('checkComplianceBtn');
            const checkBtnText = document.getElementById('checkComplianceBtnText');
            
            contentDiv.innerHTML = '<div class="loading">Verificando conformidade...</div>';
            
            // Show loading state on button
            if (checkBtn && checkBtnText) {
                checkBtn.disabled = true;
                checkBtn.classList.add('btn-loading');
                const originalText = checkBtnText.textContent;
                checkBtnText.textContent = 'Verificando...';
            }
            
            try {
                const response = await fetch(`${API_BASE}/compliance/check`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ airport_id: parseInt(airportId) })
                });
                
                if (!response.ok) {
                    throw new Error('Erro ao verificar conformidade');
                }
                
                const data = await response.json();
                displayCompliance(data);
                
                // Store selected airport ID for other tabs
                window.selectedAirportId = airportId;
                
                // Update other tabs if they are active
                const deadlinesTab = document.getElementById('deadlinesTab');
                const areasTab = document.getElementById('areasTab');
                
                if (deadlinesTab && deadlinesTab.classList.contains('active')) {
                    loadDeadlines();
                }
                if (areasTab && areasTab.classList.contains('active')) {
                    loadAreas();
                }
                
                showToast(`Conformidade verificada: ${data.total_regulations} normas aplic√°veis`, 'success', 3000);
            } catch (error) {
                contentDiv.innerHTML = `
                    <div class="error" role="alert">
                        <strong>Erro:</strong> ${error.message}
                        <br>Certifique-se de que o servidor est√° rodando em http://localhost:8000
                    </div>
                `;
                showToast('Erro ao verificar conformidade', 'error');
            } finally {
                // Reset button state
                if (checkBtn && checkBtnText) {
                    checkBtn.disabled = false;
                    checkBtn.classList.remove('btn-loading');
                    checkBtnText.textContent = 'Verificar Conformidade';
                }
            }
        }
        
        // Display compliance results
        function displayCompliance(data) {
            const contentDiv = document.getElementById('complianceContent');
            
            // Store data globally
            window.currentComplianceData = data;
            window.currentViewMode = 'cards';
            
            let html = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                    <div style="flex: 1;">
                        <h3 style="margin: 0; color: var(--anac-primary);">
                            Conformidades Encontradas
                            <span style="font-size: 14px; color: #666; font-weight: normal;">(${data.total_regulations} norma${data.total_regulations !== 1 ? 's' : ''})</span>
                        </h3>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button id="view-toggle-cards" onclick="toggleView('cards')" 
                                style="padding: 8px 16px; background: var(--anac-primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">
                            üìã Cards
                        </button>
                        <button id="view-toggle-table" onclick="toggleView('table')" 
                                style="padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">
                            üìä Tabela
                        </button>
                    </div>
                </div>
                
                <div class="summary">
                    <div class="summary-item">
                        <div class="number">${data.total_regulations}</div>
                        <div class="label">Normas Aplic√°veis</div>
                    </div>
                    <div class="summary-item">
                        <div class="number" style="color: #10b981;">${data.compliant_count}</div>
                        <div class="label">Conformes</div>
                    </div>
                    <div class="summary-item">
                        <div class="number" style="color: #ef4444;">${data.non_compliant_count}</div>
                        <div class="label">N√£o Conformes</div>
                    </div>
                    <div class="summary-item">
                        <div class="number" style="color: #f59e0b;">${data.partial_count}</div>
                        <div class="label">Parciais</div>
                    </div>
                    <div class="summary-item">
                        <div class="number" style="color: #6b7280;">${data.pending_count}</div>
                        <div class="label">Pendentes</div>
                    </div>
                </div>
            `;
            
            // Display ANAC scores if available
            if (data.anac_scores) {
                const scores = data.anac_scores;
                const essentialColor = scores.essential_compliant ? '#10b981' : '#ef4444';
                html += `
                    <div style="background: white; padding: 20px; border-radius: 10px; margin-top: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h3 style="margin-bottom: 15px; color: #333;">üìä Pontua√ß√£o ANAC</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="padding: 15px; background: ${essentialColor}15; border-radius: 6px; border-left: 4px solid ${essentialColor};">
                                <div style="font-size: 24px; font-weight: bold; color: ${essentialColor};">
                                    ${scores.essential_percentage}%
                                </div>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                    Requisitos Essenciais (D)
                                </div>
                                <div style="font-size: 11px; color: #999; margin-top: 3px;">
                                    ${scores.essential_compliant ? '‚úì ACOP eleg√≠vel (‚â•85%)' : '‚ö†Ô∏è Abaixo do m√≠nimo (85%)'}
                                </div>
                            </div>
                            <div style="padding: 15px; background: #f0f9ff; border-radius: 6px; border-left: 4px solid #3b82f6;">
                                <div style="font-size: 24px; font-weight: bold; color: #3b82f6;">
                                    ${scores.complementary_percentage}%
                                </div>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                    Complementares (C)
                                </div>
                            </div>
                            <div style="padding: 15px; background: #fef3c7; border-radius: 6px; border-left: 4px solid #f59e0b;">
                                <div style="font-size: 24px; font-weight: bold; color: #f59e0b;">
                                    ${scores.recommended_percentage}%
                                </div>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                    Recomendadas (B)
                                </div>
                            </div>
                            <div style="padding: 15px; background: #f3e8ff; border-radius: 6px; border-left: 4px solid #8b5cf6;">
                                <div style="font-size: 24px; font-weight: bold; color: #8b5cf6;">
                                    ${scores.best_practices_percentage}%
                                </div>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                    Melhores Pr√°ticas (A)
                                </div>
                            </div>
                            <div style="padding: 15px; background: #ecfdf5; border-radius: 6px; border-left: 4px solid #10b981;">
                                <div style="font-size: 24px; font-weight: bold; color: #10b981;">
                                    ${scores.overall_score}%
                                </div>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                    Pontua√ß√£o Geral
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 15px; padding: 12px; background: #f8f9fa; border-radius: 6px; font-size: 12px; color: #666;">
                            <strong>Legenda:</strong> D = Essenciais (85% m√≠nimo para ACOP) | C = Complementares | B = Recomendadas | A = Melhores Pr√°ticas
                        </div>
                    </div>
                `;
            }
            
            // Generate and show action plan - REMOVIDO para reduzir informa√ß√£o na tela
            // html += generateActionPlan(data);
            
            // Show reminders for expiring/expired items
            const reminders = generateReminders(data);
            if (reminders) {
                html += reminders;
            }
            
            // Recomenda√ß√µes Gerais - REMOVIDO para reduzir informa√ß√£o na tela
            // if (data.recommendations && data.recommendations.length > 0) {
            //     html += `
            //         <div class="recommendations" style="margin-top: 20px;">
            //             <h3>üí° Recomenda√ß√µes Gerais</h3>
            //             <ul>
            //                 ${data.recommendations.map(rec => `<li>${rec}</li>`).join('')}
            //             </ul>
            //         </div>
            //     `;
            // }
            
            html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-top: 30px; margin-bottom: 15px; flex-wrap: wrap; gap: 15px;">';
            html += '<div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">';
            html += '<h3>Checklist de Conformidade</h3>';
            html += `<span style="color: #666; font-size: 14px;">${data.compliance_records.length} norma(s) encontrada(s)</span>`;
            html += '</div>';
            html += '<div style="display: flex; gap: 10px; flex-wrap: wrap;">';
            html += '<button onclick="toggleBatchEdit()" id="batchEditBtn" style="padding: 10px 20px; background: var(--anac-primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; transition: all 0.2s ease;">üìù Edi√ß√£o em Lote</button>';
            html += '<button onclick="exportReport()" class="export-btn">üì• Exportar Relat√≥rio</button>';
            html += '</div>';
            html += '</div>';
            
            // Batch edit mode banner
            html += `
                <div id="batchEditBanner" class="batch-edit-mode" style="display: none;">
                    <div class="batch-edit-controls">
                        <strong>Modo de Edi√ß√£o em Lote</strong>
                        <button onclick="selectAllForBatch()" class="batch-select-all">Selecionar Todas</button>
                        <div class="batch-actions">
                            <button onclick="batchUpdateStatus('compliant')" class="batch-action-btn">Marcar como Conforme</button>
                            <button onclick="batchUpdateStatus('partial')" class="batch-action-btn">Marcar como Parcial</button>
                            <button onclick="batchUpdateStatus('non_compliant')" class="batch-action-btn">Marcar como N√£o Conforme</button>
                            <button onclick="batchUpdateStatus('pending_review')" class="batch-action-btn">Marcar como Pendente</button>
                        </div>
                        <button onclick="toggleBatchEdit()" style="padding: 10px 20px; background: var(--anac-error); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; transition: all 0.2s ease;">Cancelar</button>
                    </div>
                    <div id="batchSelectedCount" style="margin-top: 12px; font-size: 13px; color: var(--anac-gray-700); font-weight: 500;">0 norma(s) selecionada(s)</div>
                </div>
            `;
            
            // Add filters and search
            html += `
                <div class="filters-container">
                    <div class="filters-row">
                        <div class="filter-group autocomplete-container">
                            <label for="searchRegulations">Buscar Norma</label>
                            <input type="text" id="searchRegulations" class="search-input" 
                                   placeholder="Buscar por c√≥digo ou t√≠tulo..." 
                                   aria-label="Buscar normas"
                                   autocomplete="off">
                            <div id="autocompleteSuggestions" class="autocomplete-suggestions"></div>
                        </div>
                        <div class="filter-group">
                            <label for="filterStatus">Status</label>
                            <select id="filterStatus" class="filter-select" aria-label="Filtrar por status">
                                <option value="">Todos</option>
                                <option value="compliant">Conforme</option>
                                <option value="partial">Parcial</option>
                                <option value="non_compliant">N√£o Conforme</option>
                                <option value="pending_review">Pendente</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="filterClassification">Classifica√ß√£o</label>
                            <select id="filterClassification" class="filter-select" aria-label="Filtrar por classifica√ß√£o">
                                <option value="">Todas</option>
                                <option value="D">D - Essencial</option>
                                <option value="C">C - Complementar</option>
                                <option value="B">B - Recomendada</option>
                                <option value="A">A - Melhor Pr√°tica</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="filterCategory">Categoria</label>
                            <select id="filterCategory" class="filter-select" aria-label="Filtrar por categoria">
                                <option value="">Todas</option>
                                <option value="operational_safety">Seguran√ßa Operacional</option>
                                <option value="fire_safety">Seguran√ßa contra Inc√™ndio</option>
                                <option value="security">Seguran√ßa</option>
                                <option value="infrastructure">Infraestrutura</option>
                                <option value="emergency_response">Resposta a Emerg√™ncias</option>
                            </select>
                        </div>
                        <button type="button" class="clear-filters-btn" onclick="clearFilters()" aria-label="Limpar filtros">
                            Limpar
                        </button>
                    </div>
                </div>
            `;
            
            // Add sort controls
            html += `
                <div class="sort-controls">
                    <label for="sortBy" style="font-size: 13px; color: #666; white-space: nowrap;">Ordenar por:</label>
                    <select id="sortBy" class="sort-select" aria-label="Ordenar normas">
                        <option value="code">C√≥digo (A-Z)</option>
                        <option value="code-desc">C√≥digo (Z-A)</option>
                        <option value="status">Status</option>
                        <option value="classification">Classifica√ß√£o (D‚ÜíA)</option>
                        <option value="category">Categoria</option>
                    </select>
                </div>
            `;
            
            
            // Store original records for filtering
            window.allComplianceRecords = data.compliance_records;
            
            // Helper function to get functional area for RBAC-153 regulations
            function getFunctionalArea(code) {
                if (!code || !code.startsWith('RBAC-153')) return null;
                
                const areaMap = {
                    'RBAC-153-01': 'Gest√£o da CAT',
                    'RBAC-153-02': 'Gest√£o da CAT',
                    'RBAC-153-03': 'Gest√£o de Equipamentos',
                    'RBAC-153-04': 'Gest√£o de Equipamentos',
                    'RBAC-153-05': 'Gest√£o de Equipamentos',
                    'RBAC-153-09': 'Gest√£o de Equipamentos',
                    'RBAC-153-06': 'Gest√£o de Recursos Humanos',
                    'RBAC-153-08': 'Gest√£o de Recursos Humanos',
                    'RBAC-153-10': 'Gest√£o de Recursos Humanos',
                    'RBAC-153-07': 'Gest√£o Operacional',
                    'RBAC-153-11': 'Gest√£o Operacional',
                    'RBAC-153-12': 'Gest√£o de Infraestrutura',
                    'RBAC-153-13': 'Gest√£o de Infraestrutura',
                    'RBAC-153-14': 'Gest√£o de Documenta√ß√£o'
                };
                
                return areaMap[code] || null;
            }
            
            // Group records by RBAC (153 vs 154) and then by functional area
            const groupedRecords = {
                'RBAC-153': {
                    'Gest√£o da CAT': [],
                    'Gest√£o de Equipamentos': [],
                    'Gest√£o de Recursos Humanos': [],
                    'Gest√£o Operacional': [],
                    'Gest√£o de Infraestrutura': [],
                    'Gest√£o de Documenta√ß√£o': [],
                    'Outros': []
                },
                'RBAC-154': {
                    'Seguran√ßa Operacional': [],
                    'Seguran√ßa contra Inc√™ndio': [],
                    'Seguran√ßa (AVSEC)': [],
                    'Infraestrutura': [],
                    'Resposta a Emerg√™ncias': [],
                    'Meio Ambiente': [],
                    'Gerenciamento de Fauna': [],
                    'Manuten√ß√£o': [],
                    'Certifica√ß√£o de Pessoal': [],
                    'Servi√ßos de Tr√°fego A√©reo': [],
                    'Outros': []
                }
            };
            
            // Helper function to get RBAC number from code
            function getRBACNumber(code) {
                if (!code) return 'RBAC-154';
                if (code.startsWith('RBAC-153')) return 'RBAC-153';
                if (code.startsWith('RBAC-154')) return 'RBAC-154';
                return 'RBAC-154'; // Default
            }
            
            // Helper function to get area name from safety category (for RBAC-154)
            function getAreaName(safetyCategory) {
                const categoryMap = {
                    'operational_safety': 'Seguran√ßa Operacional',
                    'fire_safety': 'Seguran√ßa contra Inc√™ndio',
                    'security': 'Seguran√ßa (AVSEC)',
                    'infrastructure': 'Infraestrutura',
                    'emergency_response': 'Resposta a Emerg√™ncias',
                    'environmental': 'Meio Ambiente',
                    'wildlife_management': 'Gerenciamento de Fauna',
                    'maintenance': 'Manuten√ß√£o',
                    'personnel_certification': 'Certifica√ß√£o de Pessoal',
                    'air_traffic_services': 'Servi√ßos de Tr√°fego A√©reo'
                };
                
                let categoryStr = safetyCategory;
                if (typeof safetyCategory !== 'string' && safetyCategory?.value) {
                    categoryStr = safetyCategory.value;
                } else if (typeof safetyCategory !== 'string') {
                    categoryStr = String(safetyCategory);
                }
                
                return categoryMap[categoryStr] || 'Outros';
            }
            
            // Group records
            data.compliance_records.forEach((record) => {
                const regulation = record.regulation || {};
                const code = regulation.code || '';
                const rbacNumber = getRBACNumber(code);
                
                let areaName;
                if (rbacNumber === 'RBAC-153') {
                    // Use functional area mapping for RBAC-153
                    areaName = getFunctionalArea(code) || 'Outros';
                } else {
                    // Use safety category for RBAC-154
                    let safetyCategory = regulation.safety_category;
                    if (typeof safetyCategory !== 'string' && safetyCategory?.value) {
                        safetyCategory = safetyCategory.value;
                    } else if (typeof safetyCategory !== 'string') {
                        safetyCategory = String(safetyCategory);
                    }
                    areaName = getAreaName(safetyCategory);
                }
                
                if (!groupedRecords[rbacNumber]) {
                    groupedRecords[rbacNumber] = {};
                }
                if (!groupedRecords[rbacNumber][areaName]) {
                    groupedRecords[rbacNumber][areaName] = [];
                }
                
                groupedRecords[rbacNumber][areaName].push(record);
            });
            
            // Display grouped records
            let recordIndex = 0;
            
            // Display RBAC-153 (SESCINC) first
            if (groupedRecords['RBAC-153'] && Object.keys(groupedRecords['RBAC-153']).length > 0) {
                html += `
                    <div style="margin-bottom: 40px;">
                `;
                
                // Helper function to get icon and description for functional area
                function getAreaInfo(areaName) {
                    const areaInfoMap = {
                        'Gest√£o da CAT': { icon: 'üìã', desc: 'Categoria Contrainc√™ndio e Opera√ß√µes Compat√≠veis' },
                        'Gest√£o de Equipamentos': { icon: 'üöõ', desc: 'CCI, Ve√≠culos de Apoio, Agentes Extintores e Equipamentos' },
                        'Gest√£o de Recursos Humanos': { icon: 'üë•', desc: 'Equipe, Capacita√ß√£o e Treinamento Recorrente' },
                        'Gest√£o Operacional': { icon: '‚öôÔ∏è', desc: 'Tempo-Resposta e Plano Contrainc√™ndio (PCINC)' },
                        'Gest√£o de Infraestrutura': { icon: 'üèóÔ∏è', desc: 'SCI e Posto Avan√ßado (PACI)' },
                        'Gest√£o de Documenta√ß√£o': { icon: 'üìÑ', desc: 'Comunica√ß√£o e Notifica√ß√µes √† ANAC' }
                    };
                    return areaInfoMap[areaName] || { icon: 'üìÅ', desc: '' };
                }
                
                // Sort areas by priority (order matters for SESCINC)
                const areaOrder = [
                    'Gest√£o da CAT',
                    'Gest√£o de Equipamentos',
                    'Gest√£o de Recursos Humanos',
                    'Gest√£o Operacional',
                    'Gest√£o de Infraestrutura',
                    'Gest√£o de Documenta√ß√£o',
                    'Outros'
                ];
                
                const sortedAreas = areaOrder.filter(area => 
                    groupedRecords['RBAC-153'][area] && groupedRecords['RBAC-153'][area].length > 0
                );
                
                sortedAreas.forEach(areaName => {
                    const areaRecords = groupedRecords['RBAC-153'][areaName];
                    if (areaRecords.length === 0) return;
                    
                    const areaInfo = getAreaInfo(areaName);
                    
                    // Calculate area statistics
                    let compliantCount = 0;
                    let partialCount = 0;
                    let nonCompliantCount = 0;
                    let pendingCount = 0;
                    
                    areaRecords.forEach(record => {
                        const status = typeof record.status === 'string' 
                            ? record.status 
                            : (record.status?.value || 'pending_review');
                        if (status === 'compliant') compliantCount++;
                        else if (status === 'partial') partialCount++;
                        else if (status === 'non_compliant') nonCompliantCount++;
                        else pendingCount++;
                    });
                    
                    const totalCount = areaRecords.length;
                    const compliantPercentage = Math.round((compliantCount / totalCount) * 100);
                    
                    html += `
                        <div style="margin-bottom: 30px;">
                            <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid var(--anac-primary);">
                                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                                    <div>
                                        <h3 style="color: var(--anac-primary); font-size: 18px; margin: 0 0 5px 0; display: flex; align-items: center; gap: 8px;">
                                            <span>${areaInfo.icon}</span>
                                            <span>${areaName}</span>
                                        </h3>
                                        ${areaInfo.desc ? `<p style="margin: 5px 0 0 0; color: #666; font-size: 12px;">${areaInfo.desc}</p>` : ''}
                                    </div>
                                    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                                        <div style="text-align: center;">
                                            <div style="font-size: 24px; font-weight: bold; color: var(--anac-primary);">${totalCount}</div>
                                            <div style="font-size: 11px; color: #666;">norma${totalCount > 1 ? 's' : ''}</div>
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 24px; font-weight: bold; color: #10b981;">${compliantPercentage}%</div>
                                            <div style="font-size: 11px; color: #666;">conforme</div>
                                        </div>
                                        ${nonCompliantCount > 0 ? `
                                            <div style="text-align: center;">
                                                <div style="font-size: 20px; font-weight: bold; color: #ef4444;">${nonCompliantCount}</div>
                                                <div style="font-size: 11px; color: #666;">n√£o conforme</div>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                    `;
                    
                    areaRecords.forEach((record) => {
                        recordIndex++;
                        const index = recordIndex - 1;
                        
                        // Safely get status value (handle both string and object formats)
                let statusValue = 'pending_review';
                if (typeof record.status === 'string') {
                    statusValue = record.status;
                } else if (record.status && record.status.value) {
                    statusValue = record.status.value;
                } else if (record.status) {
                    statusValue = String(record.status);
                }
                
                const statusClass = `status-${String(statusValue).replace('_', '-')}`;
                const statusText = {
                    'compliant': 'Conforme',
                    'non_compliant': 'N√£o Conforme',
                    'partial': 'Parcial',
                    'pending_review': 'Pendente',
                    'not_applicable': 'N√£o Aplic√°vel'
                }[statusValue] || statusValue;
                
                // Safely get regulation data
                const regulation = record.regulation;
                
                // If regulation is null/undefined, log error and skip this record
                if (!regulation) {
                    console.error(`Regulation not found for record ${record.id} (regulation_id: ${record.regulation_id})`);
                    // Skip this record - don't render it (use return in forEach, not continue)
                    return;
                }
                
                const regulationCode = regulation.code || 'N/A';
                const regulationTitle = regulation.title || 'Norma n√£o encontrada';
                
                // Handle safety_category (can be string or object)
                let safetyCategory = 'unknown';
                if (typeof regulation.safety_category === 'string') {
                    safetyCategory = regulation.safety_category;
                } else if (regulation.safety_category && regulation.safety_category.value) {
                    safetyCategory = regulation.safety_category.value;
                } else if (regulation.safety_category) {
                    safetyCategory = String(regulation.safety_category);
                }
                
                const categoryDisplay = String(safetyCategory).replace(/_/g, ' ').toUpperCase();
                const requirements = regulation.requirements || 'Requisitos n√£o dispon√≠veis';
                
                // ANAC Classification information
                let classification = regulation.requirement_classification;
                if (classification && typeof classification !== 'string') {
                    classification = classification.value || classification;
                }
                const classificationLabels = {
                    'D': { text: 'Essencial', desc: 'Requisitos essenciais (85% m√≠nimo para ACOP)', color: '#ef4444' },
                    'C': { text: 'Complementar', desc: 'Requisitos complementares', color: '#3b82f6' },
                    'B': { text: 'Recomendada', desc: 'Pr√°ticas recomendadas', color: '#f59e0b' },
                    'A': { text: 'Melhor Pr√°tica', desc: 'Melhores pr√°ticas', color: '#8b5cf6' }
                };
                const classInfo = classification ? classificationLabels[classification] : null;
                
                // Evaluation type
                let evalType = regulation.evaluation_type;
                if (evalType && typeof evalType !== 'string') {
                    evalType = evalType.value || evalType;
                }
                const evalTypeLabels = {
                    'DOCS': 'Documental (remoto)',
                    'TOPS': 'Operacional (no local)',
                    'BOTH': 'Documental e Operacional'
                };
                const evalTypeDisplay = evalType ? (evalTypeLabels[evalType] || evalType) : '';
                
                // Weight and ANAC reference
                const weight = regulation.weight || null;
                const anacRef = regulation.anac_reference || null;
                
                // Get action items
                let actionItems = [];
                if (record.action_items) {
                    try {
                        actionItems = typeof record.action_items === 'string' 
                            ? JSON.parse(record.action_items) 
                            : record.action_items;
                        if (!Array.isArray(actionItems)) {
                            actionItems = [];
                        }
                    } catch (e) {
                        actionItems = [];
                    }
                }
                
                // Status selection buttons
                const recordId = record.id;
                html += `
                    <div class="compliance-item" id="record-${recordId}" data-record-id="${recordId}">
                        <div id="batchCheckbox-${recordId}" class="batch-checkbox" style="display: none; margin-bottom: 10px;">
                            <input type="checkbox" id="batch-select-${recordId}" onchange="updateBatchSelection()" style="width: auto; margin-right: 8px;">
                            <label for="batch-select-${recordId}" style="cursor: pointer; font-weight: 500;">Selecionar para edi√ß√£o em lote</label>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <div style="flex: 1;">
                                <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-bottom: 8px;">
                                    <span class="status-badge ${statusClass}" id="badge-${recordId}">${statusText}</span>
                                    ${classInfo ? `<span style="background: ${classInfo.color}20; color: ${classInfo.color}; padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: bold; border: 1px solid ${classInfo.color}40;" title="${classInfo.desc}">${classification}: ${classInfo.text}</span>` : ''}
                                    ${weight ? `<span style="background: #e0e0e0; color: #666; padding: 4px 10px; border-radius: 4px; font-size: 11px;" title="Peso do item">Peso: ${weight}</span>` : ''}
                                    ${evalTypeDisplay ? `<span style="background: #e3f2fd; color: #1976d2; padding: 4px 10px; border-radius: 4px; font-size: 11px;" title="Tipo de avalia√ß√£o">${evalTypeDisplay}</span>` : ''}
                                </div>
                                <h3 style="margin-top: 5px;">${regulationCode}: ${regulationTitle}</h3>
                                <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 8px; font-size: 12px; color: #666;">
                                    <span><strong>Categoria:</strong> ${categoryDisplay}</span>
                                    ${anacRef ? `<span><strong>Ref. ANAC:</strong> ${anacRef}</span>` : ''}
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px; flex-direction: column; align-items: end;">
                                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 13px;">
                                    <input type="radio" name="status-${recordId}" value="compliant" ${statusValue === 'compliant' ? 'checked' : ''} 
                                           onchange="updateComplianceStatus(${recordId}, 'compliant')">
                                    <span>Conforme</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 13px;">
                                    <input type="radio" name="status-${recordId}" value="partial" ${statusValue === 'partial' ? 'checked' : ''} 
                                           onchange="updateComplianceStatus(${recordId}, 'partial')">
                                    <span>Parcial</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 13px;">
                                    <input type="radio" name="status-${recordId}" value="non_compliant" ${statusValue === 'non_compliant' ? 'checked' : ''} 
                                           onchange="updateComplianceStatus(${recordId}, 'non_compliant')">
                                    <span>N√£o Conforme</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 13px;">
                                    <input type="radio" name="status-${recordId}" value="pending_review" ${statusValue === 'pending_review' ? 'checked' : ''} 
                                           onchange="updateComplianceStatus(${recordId}, 'pending_review')">
                                    <span>Pendente</span>
                                </label>
                            </div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin: 15px 0;">
                            <strong style="color: #333;">O que seu aeroporto precisa ter/fazer:</strong>
                            <p style="margin-top: 8px; color: #555;">${requirements}</p>
                        </div>
                        
                        ${actionItems.length > 0 ? `
                                <div class="action-items">
                                <strong style="color: #333;">Plano de A√ß√£o (${actionItems.length} itens):</strong>
                                <p style="color: #666; font-size: 12px; margin-top: 5px;">Marque os itens conforme voc√™ os completa. O status ser√° atualizado automaticamente.</p>
                                
                                <!-- Progress Bar -->
                                ${(() => {
                                    const completedItems = record.completed_action_items || [];
                                    const completedCount = Array.isArray(completedItems) ? completedItems.length : 0;
                                    const totalCount = actionItems.length;
                                    const percentage = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
                                    return `
                                        <div class="action-items-progress">
                                            <div class="progress-bar-text">
                                                Progresso: ${completedCount} de ${totalCount} itens completos (${percentage}%)
                                            </div>
                                            <div class="progress-bar-container">
                                                <div class="progress-bar-fill" style="width: ${percentage}%">
                                                    ${percentage > 10 ? percentage + '%' : ''}
                                                </div>
                                            </div>
                                </div>
                            `;
                                })()}
                                
                                <ul style="margin-top: 10px;">
                                    ${actionItems.map((item, idx) => {
                                        const completedItems = record.completed_action_items || [];
                                        const isChecked = Array.isArray(completedItems) && completedItems.includes(idx);
                                        const dueDates = record.action_item_due_dates || {};
                                        const dueDate = dueDates[idx] || null;
                                        
                                        // Only show as crossed out if status is compliant AND item is checked
                                        const isCompliantStatus = statusValue === 'compliant';
                                        const shouldStrikeThrough = isChecked && isCompliantStatus && !dateStatus.includes('EXPIRADO');
                                        
                                        // Check if expired or expiring soon
                                        let dateStatus = '';
                                        let dateClass = '';
                                        if (dueDate) {
                                            const today = new Date();
                                            today.setHours(0, 0, 0, 0);
                                            const due = new Date(dueDate);
                                            due.setHours(0, 0, 0, 0);
                                            const daysDiff = Math.ceil((due - today) / (1000 * 60 * 60 * 24));
                                            
                                            if (daysDiff < 0) {
                                                dateStatus = `‚ö†Ô∏è EXPIRADO h√° ${Math.abs(daysDiff)} dia(s)`;
                                                dateClass = 'expired';
                                            } else if (daysDiff <= 7) {
                                                dateStatus = `‚ö†Ô∏è Expira em ${daysDiff} dia(s)`;
                                                dateClass = 'expiring-soon';
                                            } else if (daysDiff <= 30) {
                                                dateStatus = `‚è∞ Expira em ${daysDiff} dia(s)`;
                                                dateClass = 'expiring-month';
                                            } else {
                                                dateStatus = `‚úì V√°lido at√© ${new Date(dueDate).toLocaleDateString('pt-BR')}`;
                                                dateClass = 'valid';
                                            }
                                        }
                                        
                                        // Determine background color based on status and checked state
                                        let bgColor = '#f8f9fa';
                                        let borderColor = '#e0e0e0';
                                        if (dateStatus.includes('EXPIRADO')) {
                                            bgColor = '#f8d7da';
                                            borderColor = '#ef4444';
                                        } else if (shouldStrikeThrough) {
                                            bgColor = '#d4edda';
                                            borderColor = '#10b981';
                                        } else if (statusValue === 'non_compliant') {
                                            bgColor = '#f8d7da';
                                            borderColor = '#ef4444';
                                        }
                                        
                                        return `
                                        <li style="margin-bottom: 12px; padding: 12px; background: ${bgColor}; border-radius: 4px; border-left: 3px solid ${borderColor};">
                                            <div style="display: flex; align-items: start; gap: 8px;">
                                                <input type="checkbox" id="action-${recordId}-${idx}" 
                                                       ${isChecked ? 'checked' : ''}
                                                       onchange="toggleActionItem(${recordId}, ${idx}, ${actionItems.length})"
                                                       style="width: auto; margin-top: 4px;">
                                                <div style="flex: 1;">
                                                    <span style="${shouldStrikeThrough ? 'text-decoration: line-through; color: #666;' : ''}">${item}</span>
                                                    ${isChecked ? `
                                                        <div style="margin-top: 8px;">
                                                            <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">
                                                                Data de validade/renova√ß√£o (opcional):
                                                            </label>
                                                            <div style="display: flex; gap: 8px; align-items: center;">
                                                                <input type="date" 
                                                                       id="due-date-${recordId}-${idx}" 
                                                                       value="${dueDate || ''}"
                                                                       onchange="saveDueDate(${recordId}, ${idx})"
                                                                       style="padding: 6px; border: 2px solid #e0e0e0; border-radius: 4px; font-size: 12px;">
                                                                ${dueDate ? `
                                                                    <span style="font-size: 11px; padding: 4px 8px; border-radius: 4px; background: ${dateClass === 'expired' ? '#fee' : dateClass === 'expiring-soon' ? '#fff3cd' : dateClass === 'expiring-month' ? '#e3f2fd' : '#d4edda'}; color: ${dateClass === 'expired' ? '#c33' : dateClass === 'expiring-soon' ? '#856404' : dateClass === 'expiring-month' ? '#1976d2' : '#155724'};">
                                                                        ${dateStatus}
                                                                    </span>
                                                                ` : ''}
                                                            </div>
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            </div>
                                        </li>
                                    `;
                                    }).join('')}
                                    </ul>
                            </div>
                        ` : ''}
                        
                        <div style="margin-top: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">Notas:</label>
                            <textarea id="notes-${recordId}" rows="2" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 4px; font-size: 14px; font-family: inherit;" 
                                      placeholder="Adicione notas sobre o status de conformidade..."
                                      onblur="saveNotes(${recordId})">${record.notes || ''}</textarea>
                        </div>
                        
                        ${renderCustomFields(recordId, regulationCode, record)}
                        
                        ${renderDocumentSection(recordId)}
                                </div>
                            `;
                
                // Load documents after rendering
                setTimeout(() => loadDocuments(recordId), 100);
                    });
                    
                    html += '</div>'; // Close area div
                });
                
                html += '</div>'; // Close RBAC-153 section
            }
            
            // Display RBAC-154
            if (groupedRecords['RBAC-154'] && Object.keys(groupedRecords['RBAC-154']).length > 0) {
                html += `
                    <div style="margin-bottom: 40px;">
                `;
                
                Object.keys(groupedRecords['RBAC-154']).forEach(areaName => {
                    const areaRecords = groupedRecords['RBAC-154'][areaName];
                    if (areaRecords.length === 0) return;
                    
                    html += `
                        <div style="margin-bottom: 30px;">
                            <h3 style="color: var(--anac-primary); font-size: 18px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid var(--anac-gray-200);">
                                ${areaName} (${areaRecords.length} norma${areaRecords.length > 1 ? 's' : ''})
                            </h3>
                    `;
                    
                    areaRecords.forEach((record) => {
                        recordIndex++;
                        const index = recordIndex - 1;
                        
                        // Safely get status value (handle both string and object formats)
                        let statusValue = 'pending_review';
                        if (typeof record.status === 'string') {
                            statusValue = record.status;
                        } else if (record.status && record.status.value) {
                            statusValue = record.status.value;
                        } else if (record.status) {
                            statusValue = String(record.status);
                        }
                        
                        const statusClass = `status-${String(statusValue).replace('_', '-')}`;
                        const statusText = {
                            'compliant': 'Conforme',
                            'non_compliant': 'N√£o Conforme',
                            'partial': 'Parcial',
                            'pending_review': 'Pendente',
                            'not_applicable': 'N√£o Aplic√°vel'
                        }[statusValue] || statusValue;
                        
                        // Safely get regulation data
                        const regulation = record.regulation;
                        
                        // If regulation is null/undefined, log error and skip this record
                        if (!regulation) {
                            console.error(`Regulation not found for record ${record.id} (regulation_id: ${record.regulation_id})`);
                            // Skip this record - don't render it (use return in forEach, not continue)
                            return;
                        }
                        
                        const regulationCode = regulation.code || 'N/A';
                        const regulationTitle = regulation.title || 'Norma n√£o encontrada';
                        
                        // Handle safety_category (can be string or object)
                        let safetyCategory = 'unknown';
                        if (typeof regulation.safety_category === 'string') {
                            safetyCategory = regulation.safety_category;
                        } else if (regulation.safety_category && regulation.safety_category.value) {
                            safetyCategory = regulation.safety_category.value;
                        } else if (regulation.safety_category) {
                            safetyCategory = String(regulation.safety_category);
                        }
                        
                        const categoryDisplay = String(safetyCategory).replace(/_/g, ' ').toUpperCase();
                        const requirements = regulation.requirements || 'Requisitos n√£o dispon√≠veis';
                        
                        // ANAC Classification information
                        let classification = regulation.requirement_classification;
                        if (classification && typeof classification !== 'string') {
                            classification = classification.value || classification;
                        }
                        const classificationLabels = {
                            'D': { text: 'Essencial', desc: 'Requisitos essenciais (85% m√≠nimo para ACOP)', color: '#ef4444' },
                            'C': { text: 'Complementar', desc: 'Requisitos complementares', color: '#3b82f6' },
                            'B': { text: 'Recomendada', desc: 'Pr√°ticas recomendadas', color: '#f59e0b' },
                            'A': { text: 'Melhor Pr√°tica', desc: 'Melhores pr√°ticas', color: '#8b5cf6' }
                        };
                        const classInfo = classification ? classificationLabels[classification] : null;
                        
                        // Evaluation type
                        let evalType = regulation.evaluation_type;
                        if (evalType && typeof evalType !== 'string') {
                            evalType = evalType.value || evalType;
                        }
                        const evalTypeLabels = {
                            'DOCS': 'Documental (remoto)',
                            'TOPS': 'Operacional (no local)',
                            'BOTH': 'Documental e Operacional'
                        };
                        const evalTypeDisplay = evalType ? (evalTypeLabels[evalType] || evalType) : '';
                        
                        // Weight and ANAC reference
                        const weight = regulation.weight || null;
                        const anacRef = regulation.anac_reference || null;
                        
                        // Get action items
                        let actionItems = [];
                        if (record.action_items) {
                            try {
                                actionItems = typeof record.action_items === 'string' 
                                    ? JSON.parse(record.action_items) 
                                    : record.action_items;
                                if (!Array.isArray(actionItems)) {
                                    actionItems = [];
                        }
                    } catch (e) {
                                actionItems = [];
                    }
                }
                
                        // Status selection buttons
                        const recordId = record.id;
                html += `
                    <div class="compliance-item" id="record-${recordId}" data-record-id="${recordId}">
                        <div id="batchCheckbox-${recordId}" class="batch-checkbox" style="display: none; margin-bottom: 10px;">
                            <input type="checkbox" id="batch-select-${recordId}" onchange="updateBatchSelection()" style="width: auto; margin-right: 8px;">
                            <label for="batch-select-${recordId}" style="cursor: pointer; font-weight: 500;">Selecionar para edi√ß√£o em lote</label>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <div style="flex: 1;">
                                <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-bottom: 8px;">
                                    <span class="status-badge ${statusClass}" id="badge-${recordId}">${statusText}</span>
                                    ${classInfo ? `<span style="background: ${classInfo.color}20; color: ${classInfo.color}; padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: bold; border: 1px solid ${classInfo.color}40;" title="${classInfo.desc}">${classification}: ${classInfo.text}</span>` : ''}
                                    ${weight ? `<span style="background: #e0e0e0; color: #666; padding: 4px 10px; border-radius: 4px; font-size: 11px;" title="Peso do item">Peso: ${weight}</span>` : ''}
                                    ${evalTypeDisplay ? `<span style="background: #e3f2fd; color: #1976d2; padding: 4px 10px; border-radius: 4px; font-size: 11px;" title="Tipo de avalia√ß√£o">${evalTypeDisplay}</span>` : ''}
                                </div>
                                <h3 style="margin-top: 5px;">${regulationCode}: ${regulationTitle}</h3>
                                <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 8px; font-size: 12px; color: #666;">
                                    <span><strong>Categoria:</strong> ${categoryDisplay}</span>
                                    ${anacRef ? `<span><strong>Ref. ANAC:</strong> ${anacRef}</span>` : ''}
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px; flex-direction: column; align-items: end;">
                                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 13px;">
                                    <input type="radio" name="status-${recordId}" value="compliant" ${statusValue === 'compliant' ? 'checked' : ''} 
                                           onchange="updateComplianceStatus(${recordId}, 'compliant')">
                                    <span>Conforme</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 13px;">
                                    <input type="radio" name="status-${recordId}" value="partial" ${statusValue === 'partial' ? 'checked' : ''} 
                                           onchange="updateComplianceStatus(${recordId}, 'partial')">
                                    <span>Parcial</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 13px;">
                                    <input type="radio" name="status-${recordId}" value="non_compliant" ${statusValue === 'non_compliant' ? 'checked' : ''} 
                                           onchange="updateComplianceStatus(${recordId}, 'non_compliant')">
                                    <span>N√£o Conforme</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 13px;">
                                    <input type="radio" name="status-${recordId}" value="pending_review" ${statusValue === 'pending_review' ? 'checked' : ''} 
                                           onchange="updateComplianceStatus(${recordId}, 'pending_review')">
                                    <span>Pendente</span>
                                </label>
                            </div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin: 15px 0;">
                            <strong style="color: #333;">O que seu aeroporto precisa ter/fazer:</strong>
                            <p style="margin-top: 8px; color: #555;">${requirements}</p>
                        </div>
                        
                        ${actionItems.length > 0 ? `
                                <div class="action-items">
                                <strong style="color: #333;">Plano de A√ß√£o (${actionItems.length} itens):</strong>
                                <p style="color: #666; font-size: 12px; margin-top: 5px;">Marque os itens conforme voc√™ os completa. O status ser√° atualizado automaticamente.</p>
                                
                                <!-- Progress Bar -->
                                ${(() => {
                                    const completedItems = record.completed_action_items || [];
                                    const completedCount = Array.isArray(completedItems) ? completedItems.length : 0;
                                    const totalCount = actionItems.length;
                                    const percentage = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
                                    return `
                                        <div class="action-items-progress">
                                            <div class="progress-bar-text">
                                                Progresso: ${completedCount} de ${totalCount} itens completos (${percentage}%)
                                            </div>
                                            <div class="progress-bar-container">
                                                <div class="progress-bar-fill" style="width: ${percentage}%">
                                                    ${percentage > 10 ? percentage + '%' : ''}
                                                </div>
                                            </div>
                    </div>
                `;
                                })()}
                                
                                <ul style="margin-top: 10px;">
                                    ${actionItems.map((item, idx) => {
                                        const completedItems = record.completed_action_items || [];
                                        const isChecked = Array.isArray(completedItems) && completedItems.includes(idx);
                                        const dueDates = record.action_item_due_dates || {};
                                        const dueDate = dueDates[idx] || null;
                                        
                                        // Only show as crossed out if status is compliant AND item is checked
                                        const isCompliantStatus = statusValue === 'compliant';
                                        
                                        // Check if expired or expiring soon
                                        let dateStatus = '';
                                        let dateClass = '';
                                        if (dueDate) {
                                            const today = new Date();
                                            today.setHours(0, 0, 0, 0);
                                            const due = new Date(dueDate);
                                            due.setHours(0, 0, 0, 0);
                                            const daysDiff = Math.ceil((due - today) / (1000 * 60 * 60 * 24));
                                            
                                            if (daysDiff < 0) {
                                                dateStatus = `‚ö†Ô∏è EXPIRADO h√° ${Math.abs(daysDiff)} dia(s)`;
                                                dateClass = 'expired';
                                            } else if (daysDiff <= 7) {
                                                dateStatus = `‚ö†Ô∏è Expira em ${daysDiff} dia(s)`;
                                                dateClass = 'expiring-soon';
                                            } else if (daysDiff <= 30) {
                                                dateStatus = `‚è∞ Expira em ${daysDiff} dia(s)`;
                                                dateClass = 'expiring-month';
                                            } else {
                                                dateStatus = `‚úì V√°lido at√© ${new Date(dueDate).toLocaleDateString('pt-BR')}`;
                                                dateClass = 'valid';
                                            }
                                        }
                                        const shouldStrikeThrough = isChecked && isCompliantStatus && !dateStatus.includes('EXPIRADO');
                                        
                                        // Determine background color based on status and checked state
                                        let bgColor = '#f8f9fa';
                                        let borderColor = '#e0e0e0';
                                        if (dateStatus.includes('EXPIRADO')) {
                                            bgColor = '#f8d7da';
                                            borderColor = '#ef4444';
                                        } else if (shouldStrikeThrough) {
                                            bgColor = '#d4edda';
                                            borderColor = '#10b981';
                                        } else if (statusValue === 'non_compliant') {
                                            bgColor = '#f8d7da';
                                            borderColor = '#ef4444';
                                        }
                                        
                                        return `
                                        <li style="margin-bottom: 12px; padding: 12px; background: ${bgColor}; border-radius: 4px; border-left: 3px solid ${borderColor};">
                                            <div style="display: flex; align-items: start; gap: 8px;">
                                                <input type="checkbox" id="action-${recordId}-${idx}" 
                                                       ${isChecked ? 'checked' : ''}
                                                       onchange="toggleActionItem(${recordId}, ${idx}, ${actionItems.length})"
                                                       style="width: auto; margin-top: 4px;">
                                                <div style="flex: 1;">
                                                    <span style="${shouldStrikeThrough ? 'text-decoration: line-through; color: #666;' : ''}">${item}</span>
                                                    ${isChecked ? `
                                                        <div style="margin-top: 8px;">
                                                            <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">
                                                                Data de validade/renova√ß√£o (opcional):
                                                            </label>
                                                            <div style="display: flex; gap: 8px; align-items: center;">
                                                                <input type="date" 
                                                                       id="due-date-${recordId}-${idx}" 
                                                                       value="${dueDate || ''}"
                                                                       onchange="saveDueDate(${recordId}, ${idx})"
                                                                       style="padding: 6px; border: 2px solid #e0e0e0; border-radius: 4px; font-size: 12px;">
                                                                ${dueDate ? `
                                                                    <span style="font-size: 11px; padding: 4px 8px; border-radius: 4px; background: ${dateClass === 'expired' ? '#fee' : dateClass === 'expiring-soon' ? '#fff3cd' : dateClass === 'expiring-month' ? '#e3f2fd' : '#d4edda'}; color: ${dateClass === 'expired' ? '#c33' : dateClass === 'expiring-soon' ? '#856404' : dateClass === 'expiring-month' ? '#1976d2' : '#155724'};">
                                                                        ${dateStatus}
                                                                    </span>
                                                                ` : ''}
                                                            </div>
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            </div>
                                        </li>
                                    `;
                                    }).join('')}
                                    </ul>
                            </div>
                        ` : ''}
                        
                        <div style="margin-top: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">Notas:</label>
                            <textarea id="notes-${recordId}" rows="2" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 4px; font-size: 14px; font-family: inherit;" 
                                      placeholder="Adicione notas sobre o status de conformidade..."
                                      onblur="saveNotes(${recordId})">${record.notes || ''}</textarea>
                        </div>
                        
                        ${renderCustomFields(recordId, regulationCode, record)}
                        
                        ${renderDocumentSection(recordId)}
                    </div>
                `;
                
                // Load documents after rendering
                setTimeout(() => loadDocuments(recordId), 100);
            });
                    
                    html += '</div>'; // Close area div
                });
                
                html += '</div>'; // Close RBAC-154 section
            }
            
            // Store data globally for table view
            window.currentComplianceData = data;
            window.currentViewMode = 'cards';
            
            contentDiv.innerHTML = html;
            
            // Setup filter event listeners
            setupFilters();
            
            // Load documents for all records
            data.compliance_records.forEach(record => {
                setTimeout(() => loadDocuments(record.id), 100);
            });
        }
        
        // Setup filter functionality
        function setupFilters() {
            const searchInput = document.getElementById('searchRegulations');
            const statusFilter = document.getElementById('filterStatus');
            const classificationFilter = document.getElementById('filterClassification');
            const categoryFilter = document.getElementById('filterCategory');
            
            if (!searchInput || !statusFilter) return;
            
            const applyFilters = () => {
                const searchTerm = (searchInput?.value || '').toLowerCase();
                const statusValue = statusFilter?.value || '';
                const classificationValue = classificationFilter?.value || '';
                const categoryValue = categoryFilter?.value || '';
                
                const records = document.querySelectorAll('.compliance-item');
                let visibleCount = 0;
                
                records.forEach(record => {
                    const recordId = record.id.replace('record-', '');
                    const recordData = window.allComplianceRecords?.find(r => r.id == recordId);
                    if (!recordData) {
                        record.style.display = 'none';
                        return;
                    }
                    
                    // Get status
                    const status = typeof recordData.status === 'string' 
                        ? recordData.status 
                        : (recordData.status?.value || 'pending_review');
                    
                    // Get regulation data
                    const regulation = recordData.regulation || {};
                    const code = (regulation.code || '').toLowerCase();
                    const title = (regulation.title || '').toLowerCase();
                    const classification = regulation.requirement_classification?.value || regulation.requirement_classification || '';
                    const category = typeof regulation.safety_category === 'string'
                        ? regulation.safety_category
                        : (regulation.safety_category?.value || '');
                    
                    // Apply filters
                    let matches = true;
                    
                    if (searchTerm && !code.includes(searchTerm) && !title.includes(searchTerm)) {
                        matches = false;
                    }
                    
                    if (statusValue && status !== statusValue) {
                        matches = false;
                    }
                    
                    if (classificationValue && String(classification) !== classificationValue) {
                        matches = false;
                    }
                    
                    if (categoryValue && category !== categoryValue) {
                        matches = false;
                    }
                    
                    record.style.display = matches ? 'block' : 'none';
                    if (matches) visibleCount++;
                });
                
                // Update count
                const countElement = document.querySelector('h3 + span');
                if (countElement) {
                    countElement.textContent = `${visibleCount} norma(s) encontrada(s)`;
                }
            };
            
            // Autocomplete functionality
            let autocompleteTimeout;
            searchInput?.addEventListener('input', (e) => {
                clearTimeout(autocompleteTimeout);
                const term = e.target.value.toLowerCase();
                const suggestionsDiv = document.getElementById('autocompleteSuggestions');
                
                if (term.length < 2) {
                    suggestionsDiv?.classList.remove('show');
                    applyFilters();
                    return;
                }
                
                // Debounce autocomplete
                autocompleteTimeout = setTimeout(() => {
                    if (!window.allComplianceRecords) return;
                    
                    const matches = [];
                    window.allComplianceRecords.forEach(record => {
                        const regulation = record.regulation || {};
                        const code = (regulation.code || '').toLowerCase();
                        const title = (regulation.title || '').toLowerCase();
                        
                        if (code.includes(term) || title.includes(term)) {
                            matches.push({
                                code: regulation.code || 'N/A',
                                title: regulation.title || 'Norma',
                                recordId: record.id
                            });
                        }
                    });
                    
                    if (matches.length > 0 && suggestionsDiv) {
                        suggestionsDiv.innerHTML = matches.slice(0, 5).map(match => 
                            `<div class="autocomplete-item" onclick="selectAutocomplete('${match.code}', ${match.recordId})">
                                <strong>${match.code}</strong>: ${match.title}
                            </div>`
                        ).join('');
                        suggestionsDiv.classList.add('show');
                    } else {
                        suggestionsDiv?.classList.remove('show');
                    }
                    
                    applyFilters();
                }, 300);
            });
            
            // Close autocomplete on click outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.autocomplete-container')) {
                    document.getElementById('autocompleteSuggestions')?.classList.remove('show');
                }
            });
            
            // Sort functionality
            const sortSelect = document.getElementById('sortBy');
            sortSelect?.addEventListener('change', () => {
                const sortValue = sortSelect.value;
                const records = Array.from(document.querySelectorAll('.compliance-item'));
                
                records.sort((a, b) => {
                    const aId = parseInt(a.id.replace('record-', ''));
                    const bId = parseInt(b.id.replace('record-', ''));
                    const aData = window.allComplianceRecords?.find(r => r.id === aId);
                    const bData = window.allComplianceRecords?.find(r => r.id === bId);
                    
                    if (!aData || !bData) return 0;
                    
                    const aReg = aData.regulation || {};
                    const bReg = bData.regulation || {};
                    
                    switch(sortValue) {
                        case 'code':
                            return (aReg.code || '').localeCompare(bReg.code || '');
                        case 'code-desc':
                            return (bReg.code || '').localeCompare(aReg.code || '');
                        case 'status':
                            const aStatus = typeof aData.status === 'string' ? aData.status : (aData.status?.value || '');
                            const bStatus = typeof bData.status === 'string' ? bData.status : (bData.status?.value || '');
                            return aStatus.localeCompare(bStatus);
                        case 'classification':
                            const aClass = aReg.requirement_classification?.value || aReg.requirement_classification || '';
                            const bClass = bReg.requirement_classification?.value || bReg.requirement_classification || '';
                            const classOrder = { 'D': 1, 'C': 2, 'B': 3, 'A': 4 };
                            return (classOrder[aClass] || 99) - (classOrder[bClass] || 99);
                        case 'category':
                            const aCat = typeof aReg.safety_category === 'string' ? aReg.safety_category : (aReg.safety_category?.value || '');
                            const bCat = typeof bReg.safety_category === 'string' ? bReg.safety_category : (bReg.safety_category?.value || '');
                            return aCat.localeCompare(bCat);
                        default:
                            return 0;
                    }
                });
                
                // Re-append sorted records
                const container = records[0]?.parentElement;
                if (container) {
                    records.forEach(record => container.appendChild(record));
                }
            });
            
            searchInput?.addEventListener('input', applyFilters);
            statusFilter?.addEventListener('change', applyFilters);
            classificationFilter?.addEventListener('change', applyFilters);
            categoryFilter?.addEventListener('change', applyFilters);
        }
        
        // Select autocomplete suggestion
        function selectAutocomplete(code, recordId) {
            const searchInput = document.getElementById('searchRegulations');
            if (searchInput) {
                searchInput.value = code;
                document.getElementById('autocompleteSuggestions')?.classList.remove('show');
                
                // Scroll to the record
                const recordElement = document.getElementById(`record-${recordId}`);
                if (recordElement) {
                    recordElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    recordElement.style.background = '#fff3cd';
                    setTimeout(() => {
                        recordElement.style.background = '';
                    }, 2000);
                }
                
                // Trigger filter update
                const event = new Event('input', { bubbles: true });
                searchInput.dispatchEvent(event);
            }
        }
        
        // Clear all filters
        function clearFilters() {
            const searchInput = document.getElementById('searchRegulations');
            const statusFilter = document.getElementById('filterStatus');
            const classificationFilter = document.getElementById('filterClassification');
            const categoryFilter = document.getElementById('filterCategory');
            
            if (searchInput) searchInput.value = '';
            if (statusFilter) statusFilter.value = '';
            if (classificationFilter) classificationFilter.value = '';
            if (categoryFilter) categoryFilter.value = '';
            
            // Show all records
            const records = document.querySelectorAll('.compliance-item');
            records.forEach(record => {
                record.style.display = 'block';
            });
            
            // Update count
            const countElement = document.querySelector('h3 + span');
            if (countElement && window.allComplianceRecords) {
                countElement.textContent = `${window.allComplianceRecords.length} norma(s) encontrada(s)`;
            }
            
            showToast('Filtros limpos', 'info', 2000);
        }
        
        // Render custom fields for SESCINC regulations
        function renderCustomFields(recordId, regulationCode, record) {
            const code = (regulationCode || '').toUpperCase();
            let customFields = {};
            
            // Parse existing custom_fields
            if (record.custom_fields) {
                try {
                    customFields = typeof record.custom_fields === 'string' 
                        ? JSON.parse(record.custom_fields) 
                        : record.custom_fields;
                    } catch (e) {
                    customFields = {};
                    }
                }
                
            let html = '';
            
            // RBAC-153-01: Determina√ß√£o da CAT
            if (code === 'RBAC-153-01') {
                html += `
                    <div class="form-section" style="margin-top: 20px; border-top: 2px solid var(--anac-gray-200); padding-top: 15px;">
                        <div class="form-section-header" style="margin-bottom: 15px;">
                            <h3 style="color: var(--anac-primary); font-size: 16px; font-weight: 600;">üìã Campos Espec√≠ficos SESCINC - Determina√ß√£o da CAT</h3>
                        </div>
                        <div class="form-section-content">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">CAT do Aer√≥dromo:</label>
                                    <select id="custom-cat-${recordId}" class="form-input" autocomplete="off" autocomplete="off" onchange="saveCustomField(${recordId}, 'fire_category', this.value)">
                                        <option value="">Selecione...</option>
                                        ${[1,2,3,4,5,6,7,8,9].map(cat => 
                                            `<option value="${cat}" ${customFields.fire_category == cat ? 'selected' : ''}>CAT ${cat}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">Data de Determina√ß√£o:</label>
                                    <input type="date" id="custom-cat-date-${recordId}" class="form-input" autocomplete="off" 
                                           autocomplete="off"
                                           value="${customFields.cat_determination_date || ''}"
                                           onchange="saveCustomField(${recordId}, 'cat_determination_date', this.value)">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">Data de √öltima Revis√£o:</label>
                                    <input type="date" id="custom-cat-review-${recordId}" class="form-input" autocomplete="off" 
                                           value="${customFields.cat_last_review_date || ''}"
                                           onchange="saveCustomField(${recordId}, 'cat_last_review_date', this.value)">
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // RBAC-153-07: Tempo-Resposta
            else if (code === 'RBAC-153-07') {
                html += `
                    <div class="form-section" style="margin-top: 20px; border-top: 2px solid var(--anac-gray-200); padding-top: 15px;">
                        <div class="form-section-header" style="margin-bottom: 15px;">
                            <h3 style="color: var(--anac-primary); font-size: 16px; font-weight: 600;">‚è±Ô∏è Campos Espec√≠ficos SESCINC - Tempo-Resposta</h3>
                        </div>
                        <div class="form-section-content">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">Tempo-Resposta Medido (minutos):</label>
                                    <input type="number" id="custom-response-time-${recordId}" class="form-input" autocomplete="off" 
                                           step="0.1" min="0" max="10"
                                           value="${customFields.response_time_minutes || ''}"
                                           placeholder="Ex: 2.5"
                                           onchange="saveCustomField(${recordId}, 'response_time_minutes', this.value); validateResponseTime(${recordId}, this.value)">
                                    <small style="color: #666; font-size: 12px;">M√°ximo permitido: 3 minutos</small>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">Data da √öltima Aferi√ß√£o:</label>
                                    <input type="date" id="custom-last-test-${recordId}" class="form-input" autocomplete="off" 
                                           value="${customFields.last_response_test_date || ''}"
                                           onchange="saveCustomField(${recordId}, 'last_response_test_date', this.value)">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">Data da Pr√≥xima Aferi√ß√£o:</label>
                                    <input type="date" id="custom-next-test-${recordId}" class="form-input" autocomplete="off" 
                                           value="${customFields.next_response_test_date || ''}"
                                           onchange="saveCustomField(${recordId}, 'next_response_test_date', this.value)">
                                </div>
                                <div style="grid-column: 1 / -1;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">Ponto Cr√≠tico Testado:</label>
                                    <input type="text" id="custom-test-point-${recordId}" class="form-input" autocomplete="off" 
                                           value="${customFields.test_point || ''}"
                                           placeholder="Ex: Pista 01, cabeceira 09"
                                           onchange="saveCustomField(${recordId}, 'test_point', this.value)">
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // RBAC-153-06: Equipe de Servi√ßo
            else if (code === 'RBAC-153-06') {
                html += `
                    <div class="form-section" style="margin-top: 20px; border-top: 2px solid var(--anac-gray-200); padding-top: 15px;">
                        <div class="form-section-header" style="margin-bottom: 15px;">
                            <h3 style="color: var(--anac-primary); font-size: 16px; font-weight: 600;">üë• Campos Espec√≠ficos SESCINC - Composi√ß√£o da Equipe</h3>
                        </div>
                        <div class="form-section-content">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">N√∫mero de BA-CE (Chefe de Equipe):</label>
                                    <input type="number" id="custom-ba-ce-${recordId}" class="form-input" autocomplete="off" 
                                           min="0" value="${customFields.team_ba_ce || ''}"
                                           onchange="saveCustomField(${recordId}, 'team_ba_ce', this.value); updateTeamTotal(${recordId})">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">N√∫mero de BA-LR (L√≠der de Resgate):</label>
                                    <input type="number" id="custom-ba-lr-${recordId}" class="form-input" autocomplete="off" 
                                           min="0" value="${customFields.team_ba_lr || ''}"
                                           onchange="saveCustomField(${recordId}, 'team_ba_lr', this.value); updateTeamTotal(${recordId})">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">N√∫mero de BA-MC (Motorista/Operador):</label>
                                    <input type="number" id="custom-ba-mc-${recordId}" class="form-input" autocomplete="off" 
                                           min="0" value="${customFields.team_ba_mc || ''}"
                                           onchange="saveCustomField(${recordId}, 'team_ba_mc', this.value); updateTeamTotal(${recordId})">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">N√∫mero de BA-RE (Resgatista):</label>
                                    <input type="number" id="custom-ba-re-${recordId}" class="form-input" autocomplete="off" 
                                           min="0" value="${customFields.team_ba_re || ''}"
                                           onchange="saveCustomField(${recordId}, 'team_ba_re', this.value); updateTeamTotal(${recordId})">
                                </div>
                                <div style="grid-column: 1 / -1;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: var(--anac-primary);">Total de BA na Equipe:</label>
                                    <input type="number" id="custom-team-total-${recordId}" class="form-input" autocomplete="off" 
                                           value="${customFields.team_total || ''}" readonly 
                                           style="background: var(--anac-gray-100); font-weight: 600;">
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // RBAC-153-04: CCI
            else if (code === 'RBAC-153-04') {
                html += `
                    <div class="form-section" style="margin-top: 20px; border-top: 2px solid var(--anac-gray-200); padding-top: 15px;">
                        <div class="form-section-header" style="margin-bottom: 15px;">
                            <h3 style="color: var(--anac-primary); font-size: 16px; font-weight: 600;">üöí Campos Espec√≠ficos SESCINC - Carro Contrainc√™ndio (CCI)</h3>
                        </div>
                        <div class="form-section-content">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">N√∫mero de CCI:</label>
                                    <input type="number" id="custom-cci-count-${recordId}" class="form-input" autocomplete="off" 
                                           min="0" value="${customFields.cci_count || ''}"
                                           onchange="saveCustomField(${recordId}, 'cci_count', this.value)">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">Capacidade de √Ågua (litros):</label>
                                    <input type="number" id="custom-cci-water-${recordId}" class="form-input" autocomplete="off" 
                                           min="0" value="${customFields.cci_water_capacity || ''}"
                                           onchange="saveCustomField(${recordId}, 'cci_water_capacity', this.value)">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">Capacidade de Espuma (litros):</label>
                                    <input type="number" id="custom-cci-foam-${recordId}" class="form-input" autocomplete="off" 
                                           min="0" value="${customFields.cci_foam_capacity || ''}"
                                           onchange="saveCustomField(${recordId}, 'cci_foam_capacity', this.value)">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">Data da √öltima Manuten√ß√£o:</label>
                                    <input type="date" id="custom-cci-last-maint-${recordId}" class="form-input" autocomplete="off" 
                                           value="${customFields.cci_last_maintenance || ''}"
                                           onchange="saveCustomField(${recordId}, 'cci_last_maintenance', this.value)">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">Data da Pr√≥xima Manuten√ß√£o:</label>
                                    <input type="date" id="custom-cci-next-maint-${recordId}" class="form-input" autocomplete="off" 
                                           value="${customFields.cci_next_maintenance || ''}"
                                           onchange="saveCustomField(${recordId}, 'cci_next_maintenance', this.value)">
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // RBAC-153-03: Agentes Extintores
            else if (code === 'RBAC-153-03') {
                html += `
                    <div class="form-section" style="margin-top: 20px; border-top: 2px solid var(--anac-gray-200); padding-top: 15px;">
                        <div class="form-section-header" style="margin-bottom: 15px;">
                            <h3 style="color: var(--anac-primary); font-size: 16px; font-weight: 600;">üßØ Campos Espec√≠ficos SESCINC - Agentes Extintores</h3>
                        </div>
                        <div class="form-section-content">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">Quantidade AFFF (litros):</label>
                                    <input type="number" id="custom-afff-${recordId}" class="form-input" autocomplete="off" 
                                           min="0" value="${customFields.extinguisher_afff || ''}"
                                           onchange="saveCustomField(${recordId}, 'extinguisher_afff', this.value)">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">Quantidade P√≥ Qu√≠mico (kg):</label>
                                    <input type="number" id="custom-pq-${recordId}" class="form-input" autocomplete="off" 
                                           min="0" value="${customFields.extinguisher_pq || ''}"
                                           onchange="saveCustomField(${recordId}, 'extinguisher_pq', this.value)">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">Quantidade CO2 (kg):</label>
                                    <input type="number" id="custom-co2-${recordId}" class="form-input" autocomplete="off" 
                                           min="0" value="${customFields.extinguisher_co2 || ''}"
                                           onchange="saveCustomField(${recordId}, 'extinguisher_co2', this.value)">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">Data de Validade Mais Pr√≥xima:</label>
                                    <input type="date" id="custom-ext-validity-${recordId}" class="form-input" autocomplete="off" 
                                           value="${customFields.extinguisher_validity_date || ''}"
                                           onchange="saveCustomField(${recordId}, 'extinguisher_validity_date', this.value)">
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // RBAC-153-08: Capacita√ß√£o
            else if (code === 'RBAC-153-08') {
                html += `
                    <div class="form-section" style="margin-top: 20px; border-top: 2px solid var(--anac-gray-200); padding-top: 15px;">
                        <div class="form-section-header" style="margin-bottom: 15px;">
                            <h3 style="color: var(--anac-primary); font-size: 16px; font-weight: 600;">üéì Campos Espec√≠ficos SESCINC - Capacita√ß√£o</h3>
                        </div>
                        <div class="form-section-content">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">N√∫mero de BA com CBA-1:</label>
                                    <input type="number" id="custom-cba1-${recordId}" class="form-input" autocomplete="off" 
                                           min="0" value="${customFields.cert_cba1_count || ''}"
                                           onchange="saveCustomField(${recordId}, 'cert_cba1_count', this.value)">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">N√∫mero de BA com CBA-2:</label>
                                    <input type="number" id="custom-cba2-${recordId}" class="form-input" autocomplete="off" 
                                           min="0" value="${customFields.cert_cba2_count || ''}"
                                           onchange="saveCustomField(${recordId}, 'cert_cba2_count', this.value)">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">N√∫mero de BA com CBA-AT (v√°lido):</label>
                                    <input type="number" id="custom-cba-at-${recordId}" class="form-input" autocomplete="off" 
                                           min="0" value="${customFields.cert_cba_at_count || ''}"
                                           onchange="saveCustomField(${recordId}, 'cert_cba_at_count', this.value)">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">Data do Pr√≥ximo Treinamento:</label>
                                    <input type="date" id="custom-next-training-${recordId}" class="form-input" autocomplete="off" 
                                           value="${customFields.next_training_date || ''}"
                                           onchange="saveCustomField(${recordId}, 'next_training_date', this.value)">
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            return html;
        }
        
        // Save custom field
        async function saveCustomField(recordId, fieldName, fieldValue) {
            try {
                // Get current custom_fields
                const recordElement = document.getElementById(`record-${recordId}`);
                if (!recordElement) return;
                
                // Get existing custom_fields from the record data
                const recordData = window.allComplianceRecords?.find(r => r.id == recordId);
                let customFields = {};
                
                if (recordData && recordData.custom_fields) {
                    try {
                        customFields = typeof recordData.custom_fields === 'string' 
                            ? JSON.parse(recordData.custom_fields) 
                            : recordData.custom_fields;
                    } catch (e) {
                        customFields = {};
                    }
                }
                
                // Update the field
                if (fieldValue === '' || fieldValue === null || fieldValue === undefined) {
                    delete customFields[fieldName];
                } else {
                    customFields[fieldName] = fieldValue;
                }
                
                // Save to backend
                const response = await fetch(`${API_BASE}/compliance/records/${recordId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ custom_fields: JSON.stringify(customFields) })
                });
                
                if (!response.ok) {
                    throw new Error('Erro ao salvar campo customizado');
                }
                
                // Update local data
                if (recordData) {
                    recordData.custom_fields = JSON.stringify(customFields);
                }
                
            } catch (error) {
                console.error('Error saving custom field:', error);
                showToast('Erro ao salvar campo. Tente novamente.', 'error');
            }
        }
        
        // Validate response time
        function validateResponseTime(recordId, value) {
            const numValue = parseFloat(value);
            if (numValue > 3) {
                showToast('‚ö†Ô∏è Aten√ß√£o: Tempo-resposta acima de 3 minutos n√£o est√° em conformidade!', 'warning');
            }
        }
        
        // Update team total
        function updateTeamTotal(recordId) {
            const baCe = parseInt(document.getElementById(`custom-ba-ce-${recordId}`)?.value || 0);
            const baLr = parseInt(document.getElementById(`custom-ba-lr-${recordId}`)?.value || 0);
            const baMc = parseInt(document.getElementById(`custom-ba-mc-${recordId}`)?.value || 0);
            const baRe = parseInt(document.getElementById(`custom-ba-re-${recordId}`)?.value || 0);
            
            const total = baCe + baLr + baMc + baRe;
            const totalInput = document.getElementById(`custom-team-total-${recordId}`);
            if (totalInput) {
                totalInput.value = total;
                saveCustomField(recordId, 'team_total', total);
            }
        }
        
        // Render document section
        function renderDocumentSection(recordId) {
            return `
                <div class="form-section" style="margin-top: 20px; border-top: 2px solid var(--anac-gray-200); padding-top: 15px;">
                    <div class="form-section-header" style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="color: var(--anac-primary); font-size: 16px; font-weight: 600; margin: 0;">üìé Documentos Anexados</h3>
                        <button onclick="showUploadDialog(${recordId})" style="padding: 8px 16px; background: var(--anac-primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">
                            + Anexar Documento
                        </button>
                    </div>
                    <div id="documents-list-${recordId}" class="documents-list">
                        <div class="loading" style="text-align: center; padding: 20px; color: #666;">Carregando documentos...</div>
                    </div>
                </div>
            `;
        }
        
        // Load documents for a record
        async function loadDocuments(recordId) {
            const documentsList = document.getElementById(`documents-list-${recordId}`);
            if (!documentsList) return;
            
            try {
                const response = await fetch(`${API_BASE}/compliance/records/${recordId}/documents`);
                if (!response.ok) {
                    throw new Error('Erro ao carregar documentos');
                }
                
                const documents = await response.json();
                
                if (documents.length === 0) {
                    documentsList.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #999; font-size: 14px;">
                            Nenhum documento anexado ainda.
                        </div>
                    `;
                    return;
                }
                
                let html = '<div style="display: grid; gap: 10px;">';
                documents.forEach(doc => {
                    const fileSizeKB = Math.round(doc.file_size / 1024);
                    const uploadDate = new Date(doc.uploaded_at).toLocaleDateString('pt-BR');
                    
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 6px; border: 1px solid #e0e0e0;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span style="font-size: 20px;">üìÑ</span>
                                    <div>
                                        <div style="font-weight: 500; color: #333;">${doc.filename}</div>
                                        <div style="font-size: 12px; color: #666; margin-top: 4px;">
                                            ${doc.document_type ? `<span style="background: #e3f2fd; padding: 2px 8px; border-radius: 4px; margin-right: 8px;">${doc.document_type}</span>` : ''}
                                            ${fileSizeKB} KB ‚Ä¢ ${uploadDate}
                                            ${doc.uploaded_by ? `‚Ä¢ ${doc.uploaded_by}` : ''}
                                        </div>
                                        ${doc.description ? `<div style="font-size: 12px; color: #666; margin-top: 4px; font-style: italic;">${doc.description}</div>` : ''}
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="downloadDocument(${doc.id})" style="padding: 6px 12px; background: var(--anac-primary); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                    üì• Download
                                </button>
                                <button onclick="deleteDocument(${doc.id}, ${recordId})" style="padding: 6px 12px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                    üóëÔ∏è Excluir
                                </button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                documentsList.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading documents:', error);
                documentsList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #ef4444; font-size: 14px;">
                        Erro ao carregar documentos. Tente novamente.
                    </div>
                `;
            }
        }
        
        // Show upload dialog
        function showUploadDialog(recordId) {
            const dialog = document.createElement('div');
            dialog.id = `upload-dialog-${recordId}`;
            dialog.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5); z-index: 10000;
                display: flex; align-items: center; justify-content: center;
            `;
            
            dialog.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                    <h3 style="margin: 0 0 20px 0; color: var(--anac-primary); font-size: 20px;">üìé Anexar Documento</h3>
                    <form id="upload-form-${recordId}" onsubmit="uploadDocument(event, ${recordId})">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">Arquivo:</label>
                            <input type="file" id="file-input-${recordId}" name="file" required
                                   accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx"
                                   style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 6px;">
                            <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                Formatos aceitos: PDF, JPG, PNG, DOC, DOCX, XLS, XLSX (m√°x. 10MB)
                            </div>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">Tipo de Documento:</label>
                            <select id="doc-type-${recordId}" name="document_type" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 6px;">
                                <option value="">Selecione...</option>
                                <option value="Certificado">Certificado</option>
                                <option value="Relat√≥rio">Relat√≥rio</option>
                                <option value="Foto">Foto</option>
                                <option value="Outro">Outro</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #555;">Descri√ß√£o (opcional):</label>
                            <textarea id="doc-desc-${recordId}" name="description" rows="3"
                                      style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 6px; font-family: inherit;"
                                      placeholder="Descreva o documento..."></textarea>
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button type="button" onclick="closeUploadDialog(${recordId})" 
                                    style="padding: 10px 20px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                Cancelar
                            </button>
                            <button type="submit" 
                                    style="padding: 10px 20px; background: var(--anac-primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                üì§ Enviar
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(dialog);
            
            // Close on background click
            dialog.addEventListener('click', (e) => {
                if (e.target === dialog) {
                    closeUploadDialog(recordId);
                }
            });
        }
        
        // Close upload dialog
        function closeUploadDialog(recordId) {
            const dialog = document.getElementById(`upload-dialog-${recordId}`);
            if (dialog) {
                dialog.remove();
            }
        }
        
        // Upload document
        async function uploadDocument(event, recordId) {
            event.preventDefault();
            
            const form = event.target;
            const fileInput = document.getElementById(`file-input-${recordId}`);
            const docType = document.getElementById(`doc-type-${recordId}`).value;
            const description = document.getElementById(`doc-desc-${recordId}`).value;
            
            if (!fileInput.files || fileInput.files.length === 0) {
                showToast('Selecione um arquivo', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            
            // Validate file size (10MB)
            if (file.size > 10 * 1024 * 1024) {
                showToast('Arquivo muito grande. Tamanho m√°ximo: 10MB', 'error');
                return;
            }
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                if (docType) formData.append('document_type', docType);
                if (description) formData.append('description', description);
                
                const response = await fetch(`${API_BASE}/compliance/records/${recordId}/documents`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: 'Erro desconhecido' }));
                    throw new Error(errorData.detail || 'Erro ao fazer upload');
                }
                
                showToast('Documento anexado com sucesso!', 'success');
                closeUploadDialog(recordId);
                loadDocuments(recordId);
                
            } catch (error) {
                console.error('Error uploading document:', error);
                showToast(`Erro ao fazer upload: ${error.message}`, 'error');
            }
        }
        
        // Download document
        function downloadDocument(documentId) {
            window.open(`${API_BASE}/documents/${documentId}/download`, '_blank');
        }
        
        // Delete document
        async function deleteDocument(documentId, recordId) {
            if (!confirm('Tem certeza que deseja excluir este documento?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/documents/${documentId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    throw new Error('Erro ao excluir documento');
                }
                
                showToast('Documento exclu√≠do com sucesso!', 'success');
                loadDocuments(recordId);
                
            } catch (error) {
                console.error('Error deleting document:', error);
                showToast('Erro ao excluir documento', 'error');
            }
        }
        
        // Toggle view between cards and table
        function toggleView(mode) {
            window.currentViewMode = mode;
            
            // Update button styles
            const cardsBtn = document.getElementById('view-toggle-cards');
            const tableBtn = document.getElementById('view-toggle-table');
            
            if (cardsBtn && tableBtn) {
                if (mode === 'cards') {
                    cardsBtn.style.background = 'var(--anac-primary)';
                    tableBtn.style.background = '#6b7280';
                } else {
                    cardsBtn.style.background = '#6b7280';
                    tableBtn.style.background = 'var(--anac-primary)';
                }
            }
            
            // Re-render with new view
            if (window.currentComplianceData) {
                if (mode === 'table') {
                    displayComplianceTable(window.currentComplianceData);
                } else {
                    displayCompliance(window.currentComplianceData);
                }
            }
        }
        
        // Display compliance in table view
        function displayComplianceTable(data) {
            const contentDiv = document.getElementById('complianceContent');
            if (!contentDiv) return;
            
            // Helper functions
            function getFunctionalArea(code) {
                if (!code || !code.startsWith('RBAC-153')) return null;
                const areaMap = {
                    'RBAC-153-01': 'Gest√£o da CAT', 'RBAC-153-02': 'Gest√£o da CAT',
                    'RBAC-153-03': 'Gest√£o de Equipamentos', 'RBAC-153-04': 'Gest√£o de Equipamentos',
                    'RBAC-153-05': 'Gest√£o de Equipamentos', 'RBAC-153-09': 'Gest√£o de Equipamentos',
                    'RBAC-153-06': 'Gest√£o de Recursos Humanos', 'RBAC-153-08': 'Gest√£o de Recursos Humanos',
                    'RBAC-153-10': 'Gest√£o de Recursos Humanos',
                    'RBAC-153-07': 'Gest√£o Operacional', 'RBAC-153-11': 'Gest√£o Operacional',
                    'RBAC-153-12': 'Gest√£o de Infraestrutura', 'RBAC-153-13': 'Gest√£o de Infraestrutura',
                    'RBAC-153-14': 'Gest√£o de Documenta√ß√£o'
                };
                return areaMap[code] || null;
            }
            
            function getAreaName(safetyCategory) {
                const categoryMap = {
                    'operational_safety': 'Seguran√ßa Operacional',
                    'fire_safety': 'Seguran√ßa contra Inc√™ndio',
                    'security': 'Seguran√ßa (AVSEC)',
                    'infrastructure': 'Infraestrutura',
                    'emergency_response': 'Resposta a Emerg√™ncias',
                    'environmental': 'Meio Ambiente',
                    'wildlife_management': 'Gerenciamento de Fauna',
                    'maintenance': 'Manuten√ß√£o',
                    'personnel_certification': 'Certifica√ß√£o de Pessoal',
                    'air_traffic_services': 'Servi√ßos de Tr√°fego A√©reo'
                };
                let categoryStr = safetyCategory;
                if (typeof safetyCategory !== 'string' && safetyCategory?.value) {
                    categoryStr = safetyCategory.value;
                } else if (typeof safetyCategory !== 'string') {
                    categoryStr = String(safetyCategory);
                }
                return categoryMap[categoryStr] || 'Outros';
            }
            
            function getRBACNumber(code) {
                if (!code) return 'RBAC-154';
                if (code.startsWith('RBAC-153')) return 'RBAC-153';
                if (code.startsWith('RBAC-154')) return 'RBAC-154';
                return 'RBAC-154';
            }
            
            let html = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                    <div style="flex: 1;">
                        <h3 style="margin: 0; color: var(--anac-primary);">
                            Conformidades Encontradas
                            <span style="font-size: 14px; color: #666; font-weight: normal;">(${data.total_regulations} norma${data.total_regulations !== 1 ? 's' : ''})</span>
                        </h3>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button id="view-toggle-cards" onclick="toggleView('cards')" 
                                style="padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">
                            üìã Cards
                        </button>
                        <button id="view-toggle-table" onclick="toggleView('table')" 
                                style="padding: 8px 16px; background: var(--anac-primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">
                            üìä Tabela
                        </button>
                    </div>
                </div>
                
                <div class="summary" style="margin-bottom: 20px;">
                    <div class="summary-item">
                        <div class="number">${data.total_regulations}</div>
                        <div class="label">Normas Aplic√°veis</div>
                    </div>
                    <div class="summary-item">
                        <div class="number" style="color: #10b981;">${data.compliant_count}</div>
                        <div class="label">Conformes</div>
                    </div>
                    <div class="summary-item">
                        <div class="number" style="color: #ef4444;">${data.non_compliant_count}</div>
                        <div class="label">N√£o Conformes</div>
                    </div>
                    <div class="summary-item">
                        <div class="number" style="color: #f59e0b;">${data.partial_count}</div>
                        <div class="label">Parciais</div>
                    </div>
                    <div class="summary-item">
                        <div class="number" style="color: #6b7280;">${data.pending_count}</div>
                        <div class="label">Pendentes</div>
                    </div>
                </div>
                
                <div style="overflow-x: auto; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                        <thead>
                            <tr style="background: linear-gradient(135deg, var(--anac-primary) 0%, var(--anac-primary-light) 100%); color: white;">
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--anac-primary); font-weight: 600;">RBAC</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--anac-primary); font-weight: 600;">√Årea</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--anac-primary); font-weight: 600;">C√≥digo</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--anac-primary); font-weight: 600;">Norma</th>
                                <th style="padding: 12px; text-align: center; border-bottom: 2px solid var(--anac-primary); font-weight: 600;">Status</th>
                                <th style="padding: 12px; text-align: center; border-bottom: 2px solid var(--anac-primary); font-weight: 600;">Classifica√ß√£o</th>
                                <th style="padding: 12px; text-align: center; border-bottom: 2px solid var(--anac-primary); font-weight: 600;">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Group records by RBAC and area
            const groupedRecords = {
                'RBAC-153': {},
                'RBAC-154': {}
            };
            
            data.compliance_records.forEach(record => {
                const regulation = record.regulation || {};
                const code = regulation.code || '';
                const rbacNumber = getRBACNumber(code);
                
                let areaName;
                if (rbacNumber === 'RBAC-153') {
                    areaName = getFunctionalArea(code) || 'Outros';
                } else {
                    let safetyCategory = regulation.safety_category;
                    if (typeof safetyCategory !== 'string' && safetyCategory?.value) {
                        safetyCategory = safetyCategory.value;
                    } else if (typeof safetyCategory !== 'string') {
                        safetyCategory = String(safetyCategory);
                    }
                    areaName = getAreaName(safetyCategory);
                }
                
                if (!groupedRecords[rbacNumber][areaName]) {
                    groupedRecords[rbacNumber][areaName] = [];
                }
                groupedRecords[rbacNumber][areaName].push(record);
            });
            
            // Render table rows
            const areaOrder = [
                'Gest√£o da CAT', 'Gest√£o de Equipamentos', 'Gest√£o de Recursos Humanos',
                'Gest√£o Operacional', 'Gest√£o de Infraestrutura', 'Gest√£o de Documenta√ß√£o'
            ];
            
            // RBAC-153 rows
            if (groupedRecords['RBAC-153'] && Object.keys(groupedRecords['RBAC-153']).length > 0) {
                areaOrder.forEach(areaName => {
                    const areaRecords = groupedRecords['RBAC-153'][areaName];
                    if (!areaRecords || areaRecords.length === 0) return;
                    
                    areaRecords.forEach((record, idx) => {
                        const regulation = record.regulation || {};
                        const code = regulation.code || '';
                        const status = typeof record.status === 'string' 
                            ? record.status 
                            : (record.status?.value || 'pending_review');
                        
                        const statusMap = {
                            'compliant': { text: 'Conforme', color: '#10b981', bg: '#d4edda' },
                            'partial': { text: 'Parcial', color: '#f59e0b', bg: '#fff3cd' },
                            'non_compliant': { text: 'N√£o Conforme', color: '#ef4444', bg: '#f8d7da' },
                            'pending_review': { text: 'Pendente', color: '#6b7280', bg: '#e9ecef' }
                        };
                        const statusInfo = statusMap[status] || statusMap['pending_review'];
                        
                        const classification = regulation.requirement_classification?.value || regulation.requirement_classification || '';
                        const classMap = {
                            'D': { text: 'D - Essencial', color: '#ef4444' },
                            'C': { text: 'C - Complementar', color: '#3b82f6' },
                            'B': { text: 'B - Recomendada', color: '#f59e0b' },
                            'A': { text: 'A - Melhor Pr√°tica', color: '#8b5cf6' }
                        };
                        const classInfo = classMap[classification] || { text: '-', color: '#666' };
                        
                        html += `
                            <tr style="border-bottom: 1px solid #e0e0e0; ${idx === 0 ? 'border-top: 2px solid var(--anac-primary);' : ''}">
                                <td style="padding: 12px; font-weight: 600; color: var(--anac-primary);">${idx === 0 ? 'RBAC-153' : ''}</td>
                                <td style="padding: 12px; color: #666;">${idx === 0 ? areaName : ''}</td>
                                <td style="padding: 12px; font-family: monospace; font-weight: 500;">${code}</td>
                                <td style="padding: 12px;">
                                    <div style="font-weight: 500; color: #333;">${regulation.title || ''}</div>
                                    ${regulation.anac_reference ? `<div style="font-size: 12px; color: #666; margin-top: 4px;">${regulation.anac_reference}</div>` : ''}
                                </td>
                                <td style="padding: 12px; text-align: center;">
                                    <span style="padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; background: ${statusInfo.bg}; color: ${statusInfo.color};">
                                        ${statusInfo.text}
                                    </span>
                                </td>
                                <td style="padding: 12px; text-align: center;">
                                    <span style="color: ${classInfo.color}; font-weight: 600;">${classInfo.text}</span>
                                </td>
                                <td style="padding: 12px; text-align: center;">
                                    <button onclick="scrollToRecord(${record.id})" style="padding: 6px 12px; background: var(--anac-primary); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                        Ver Detalhes
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                });
            }
            
            // RBAC-154 rows
            if (groupedRecords['RBAC-154'] && Object.keys(groupedRecords['RBAC-154']).length > 0) {
                Object.keys(groupedRecords['RBAC-154']).forEach(areaName => {
                    const areaRecords = groupedRecords['RBAC-154'][areaName];
                    if (!areaRecords || areaRecords.length === 0) return;
                    
                    areaRecords.forEach((record, idx) => {
                        const regulation = record.regulation || {};
                        const code = regulation.code || '';
                        const status = typeof record.status === 'string' 
                            ? record.status 
                            : (record.status?.value || 'pending_review');
                        
                        const statusMap = {
                            'compliant': { text: 'Conforme', color: '#10b981', bg: '#d4edda' },
                            'partial': { text: 'Parcial', color: '#f59e0b', bg: '#fff3cd' },
                            'non_compliant': { text: 'N√£o Conforme', color: '#ef4444', bg: '#f8d7da' },
                            'pending_review': { text: 'Pendente', color: '#6b7280', bg: '#e9ecef' }
                        };
                        const statusInfo = statusMap[status] || statusMap['pending_review'];
                        
                        const classification = regulation.requirement_classification?.value || regulation.requirement_classification || '';
                        const classMap = {
                            'D': { text: 'D - Essencial', color: '#ef4444' },
                            'C': { text: 'C - Complementar', color: '#3b82f6' },
                            'B': { text: 'B - Recomendada', color: '#f59e0b' },
                            'A': { text: 'A - Melhor Pr√°tica', color: '#8b5cf6' }
                        };
                        const classInfo = classMap[classification] || { text: '-', color: '#666' };
                        
                        html += `
                            <tr style="border-bottom: 1px solid #e0e0e0; ${idx === 0 ? 'border-top: 2px solid var(--anac-secondary);' : ''}">
                                <td style="padding: 12px; font-weight: 600; color: var(--anac-secondary);">${idx === 0 ? 'RBAC-154' : ''}</td>
                                <td style="padding: 12px; color: #666;">${idx === 0 ? areaName : ''}</td>
                                <td style="padding: 12px; font-family: monospace; font-weight: 500;">${code}</td>
                                <td style="padding: 12px;">
                                    <div style="font-weight: 500; color: #333;">${regulation.title || ''}</div>
                                    ${regulation.anac_reference ? `<div style="font-size: 12px; color: #666; margin-top: 4px;">${regulation.anac_reference}</div>` : ''}
                                </td>
                                <td style="padding: 12px; text-align: center;">
                                    <span style="padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; background: ${statusInfo.bg}; color: ${statusInfo.color};">
                                        ${statusInfo.text}
                                    </span>
                                </td>
                                <td style="padding: 12px; text-align: center;">
                                    <span style="color: ${classInfo.color}; font-weight: 600;">${classInfo.text}</span>
                                </td>
                                <td style="padding: 12px; text-align: center;">
                                    <button onclick="scrollToRecord(${record.id})" style="padding: 6px 12px; background: var(--anac-secondary); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                        Ver Detalhes
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                });
            }
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            contentDiv.innerHTML = html;
            
            // Setup filter event listeners
            setupFilters();
        }
        
        // Scroll to record (for table view)
        function scrollToRecord(recordId) {
            // Switch to cards view and scroll
            toggleView('cards');
            setTimeout(() => {
                const element = document.getElementById(`record-${recordId}`);
                if (element) {
                    element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    element.style.animation = 'pulse 2s';
                }
            }, 300);
        }
        
        // Update compliance status
        async function updateComplianceStatus(recordId, status) {
            try {
                // If marking as compliant, get all action items and mark them all
                let completedItems = null;
                if (status === 'compliant') {
                    // Get total number of action items
                    const recordElement = document.getElementById(`record-${recordId}`);
                    if (recordElement) {
                        const checkboxes = recordElement.querySelectorAll('input[type="checkbox"]');
                        completedItems = Array.from({length: checkboxes.length}, (_, i) => i);
                        // Mark all checkboxes
                        checkboxes.forEach(cb => cb.checked = true);
                    }
                } else if (status === 'non_compliant') {
                    // If marking as non-compliant, clear all completed items
                    completedItems = [];
                    // Uncheck all checkboxes
                    const recordElement = document.getElementById(`record-${recordId}`);
                    if (recordElement) {
                        const checkboxes = recordElement.querySelectorAll('input[type="checkbox"]');
                        checkboxes.forEach(cb => cb.checked = false);
                    }
                }
                
                const response = await fetch(`${API_BASE}/compliance/records/${recordId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        status: status,
                        completed_action_items: completedItems
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: 'Erro desconhecido' }));
                    throw new Error(errorData.detail || 'Erro ao atualizar status');
                }
                
                // Update badge
                const badge = document.getElementById(`badge-${recordId}`);
                const statusMap = {
                    'compliant': { text: 'Conforme', class: 'status-compliant' },
                    'partial': { text: 'Parcial', class: 'status-partial' },
                    'non_compliant': { text: 'N√£o Conforme', class: 'status-non-compliant' },
                    'pending_review': { text: 'Pendente', class: 'status-pending' }
                };
                
                if (badge && statusMap[status]) {
                    badge.textContent = statusMap[status].text;
                    badge.className = `status-badge ${statusMap[status].class}`;
                }
                
                // Update visual style of action items based on status
                const recordElement = document.getElementById(`record-${recordId}`);
                if (recordElement) {
                    const actionItemList = recordElement.querySelectorAll('li');
                    actionItemList.forEach(li => {
                        const checkbox = li.querySelector('input[type="checkbox"]');
                        const span = li.querySelector('span');
                        if (checkbox && span) {
                            if (status === 'non_compliant') {
                                // Non-compliant: uncheck and remove strike-through
                                checkbox.checked = false;
                                li.style.background = '#f8d7da';
                                li.style.borderLeftColor = '#ef4444';
                                span.style.textDecoration = 'none';
                                span.style.color = '';
                            } else if (status === 'compliant') {
                                // Compliant: check and add strike-through
                                checkbox.checked = true;
                                li.style.background = '#d4edda';
                                li.style.borderLeftColor = '#10b981';
                                span.style.textDecoration = 'line-through';
                                span.style.color = '#666';
                            } else {
                                // Partial or pending: reset to default
                                li.style.background = '#f8f9fa';
                                li.style.borderLeftColor = '#e0e0e0';
                                span.style.textDecoration = 'none';
                                span.style.color = '';
                            }
                        }
                    });
                }
                
                // Refresh compliance summary
                const airportId = document.getElementById('airportSelect').value;
                if (airportId) {
                    await checkCompliance(airportId);
                }
            } catch (error) {
                console.error('Error updating status:', error);
                showToast('Erro ao atualizar status. Tente novamente.', 'error');
            }
        }
        
        // Save notes
        async function saveNotes(recordId) {
            const notes = document.getElementById(`notes-${recordId}`).value;
            try {
                const response = await fetch(`${API_BASE}/compliance/records/${recordId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ notes: notes })
                });
                
                if (!response.ok) {
                    throw new Error('Erro ao salvar notas');
                }
            } catch (error) {
                console.error('Error saving notes:', error);
            }
        }
        
        // Toggle action item and update status automatically
        async function toggleActionItem(recordId, itemIndex, totalItems) {
            const checkbox = document.getElementById(`action-${recordId}-${itemIndex}`);
            if (!checkbox) return;
            
            // Get all checkboxes for this record
            const recordElement = document.getElementById(`record-${recordId}`);
            const checkboxes = recordElement.querySelectorAll('input[type="checkbox"]');
            
            // Build list of completed items
            const completedItems = [];
            checkboxes.forEach((cb, idx) => {
                if (cb.checked) {
                    completedItems.push(idx);
                }
            });
            
            try {
                // Update completed action items (status will be auto-calculated)
                const response = await fetch(`${API_BASE}/compliance/records/${recordId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        completed_action_items: completedItems
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: 'Erro desconhecido' }));
                    console.error('Error response:', errorData);
                    throw new Error(errorData.detail || `Erro ao atualizar item de a√ß√£o (${response.status})`);
                }
                
                const updatedRecord = await response.json();
                
                // Update the status badge and radio buttons based on new status
                const newStatus = typeof updatedRecord.status === 'string' ? updatedRecord.status : (updatedRecord.status?.value || 'pending_review');
                const statusMap = {
                    'compliant': { text: 'Conforme', class: 'status-compliant' },
                    'partial': { text: 'Parcial', class: 'status-partial' },
                    'non_compliant': { text: 'N√£o Conforme', class: 'status-non-compliant' },
                    'pending_review': { text: 'Pendente', class: 'status-pending' }
                };
                
                // Update badge
                const badge = document.getElementById(`badge-${recordId}`);
                if (badge && statusMap[newStatus]) {
                    badge.textContent = statusMap[newStatus].text;
                    badge.className = `status-badge ${statusMap[newStatus].class}`;
                }
                
                // Update radio button
                const radioButton = document.querySelector(`input[name="status-${recordId}"][value="${newStatus}"]`);
                if (radioButton) {
                    radioButton.checked = true;
                }
                
                // Update visual style of action items - only strike through if status is compliant
                const actionItem = checkbox.closest('li');
                if (actionItem) {
                    const span = actionItem.querySelector('span');
                    if (checkbox.checked && newStatus === 'compliant') {
                        // Only strike through if status is compliant
                        actionItem.style.background = '#d4edda';
                        actionItem.style.borderLeftColor = '#10b981';
                        if (span) {
                            span.style.textDecoration = 'line-through';
                            span.style.color = '#666';
                        }
                    } else {
                        // Don't strike through if status is not compliant
                        if (newStatus === 'non_compliant') {
                            actionItem.style.background = '#f8d7da';
                            actionItem.style.borderLeftColor = '#ef4444';
                        } else {
                            actionItem.style.background = '#f8f9fa';
                            actionItem.style.borderLeftColor = '#e0e0e0';
                        }
                        if (span) {
                            span.style.textDecoration = 'none';
                            span.style.color = '';
                        }
                    }
                }
                
                // Update all action items in the record based on final status
                const recordElement = document.getElementById(`record-${recordId}`);
                if (recordElement && newStatus !== 'compliant') {
                    const allActionItems = recordElement.querySelectorAll('li');
                    allActionItems.forEach(li => {
                        const cb = li.querySelector('input[type="checkbox"]');
                        const sp = li.querySelector('span');
                        if (cb && sp) {
                            // If status is not compliant, remove strike-through even if checked
                            if (newStatus === 'non_compliant') {
                                li.style.background = '#f8d7da';
                                li.style.borderLeftColor = '#ef4444';
                            } else {
                                li.style.background = '#f8f9fa';
                                li.style.borderLeftColor = '#e0e0e0';
                            }
                            sp.style.textDecoration = 'none';
                            sp.style.color = '';
                        }
                    });
                } else if (recordElement && newStatus === 'compliant') {
                    // If status is compliant, strike through all checked items
                    const allActionItems = recordElement.querySelectorAll('li');
                    allActionItems.forEach(li => {
                        const cb = li.querySelector('input[type="checkbox"]');
                        const sp = li.querySelector('span');
                        if (cb && sp && cb.checked) {
                            li.style.background = '#d4edda';
                            li.style.borderLeftColor = '#10b981';
                            sp.style.textDecoration = 'line-through';
                            sp.style.color = '#666';
                        }
                    });
                }
                
                // Refresh compliance summary
                const airportId = document.getElementById('airportSelect').value;
                if (airportId) {
                    await checkCompliance(airportId);
                }
            } catch (error) {
                console.error('Error toggling action item:', error);
                // Revert checkbox if error
                checkbox.checked = !checkbox.checked;
                showToast('Erro ao atualizar item de a√ß√£o. Tente novamente.', 'error');
            }
        }
        
        // Save due date for an action item
        async function saveDueDate(recordId, itemIndex, dateValue = null) {
            if (dateValue === null) {
                const dateInput = document.getElementById(`due-date-${recordId}-${itemIndex}`);
                if (!dateInput) return;
                dateValue = dateInput.value;
            }
            
            try {
                // Get current due dates
                const response = await fetch(`${API_BASE}/compliance/check`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        airport_id: parseInt(document.getElementById('airportSelect').value)
                    })
                });
                
                if (!response.ok) return;
                
                const data = await response.json();
                const record = data.compliance_records.find(r => r.id === recordId);
                if (!record) return;
                
                const currentDueDates = record.action_item_due_dates || {};
                const updatedDueDates = { ...currentDueDates };
                
                if (dateValue) {
                    updatedDueDates[itemIndex] = dateValue;
                } else {
                    delete updatedDueDates[itemIndex];
                }
                
                // Update the record
                const updateResponse = await fetch(`${API_BASE}/compliance/records/${recordId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action_item_due_dates: updatedDueDates
                    })
                });
                
                if (updateResponse.ok) {
                    showToast('Data de vencimento salva com sucesso!', 'success');
                    
                    // Refresh to show updated date status
                    const airportId = document.getElementById('airportSelect').value || window.selectedAirportId;
                    if (airportId) {
                        await checkCompliance(airportId);
                        
                        // Also refresh deadlines tab if it's active
                        const deadlinesTab = document.getElementById('deadlinesTab');
                        if (deadlinesTab && deadlinesTab.classList.contains('active')) {
                            await loadDeadlines();
                        }
                    }
                } else {
                    const errorData = await updateResponse.json().catch(() => ({ detail: 'Erro desconhecido' }));
                    showToast(`Erro ao salvar data: ${errorData.detail || 'Erro desconhecido'}`, 'error');
                    console.error('Error saving due date:', errorData);
                }
            } catch (error) {
                console.error('Error saving due date:', error);
            }
        }
        
        // Generate reminders for expiring/expired items
        function generateReminders(data) {
            const reminders = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            data.compliance_records.forEach(record => {
                if (!record.action_item_due_dates) return;
                
                const dueDates = record.action_item_due_dates;
                const regulation = record.regulation || {};
                
                Object.keys(dueDates).forEach(itemIdx => {
                    const dueDateStr = dueDates[itemIdx];
                    const dueDate = new Date(dueDateStr);
                    dueDate.setHours(0, 0, 0, 0);
                    const daysDiff = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                    
                    if (daysDiff < 0) {
                        reminders.push({
                            type: 'expired',
                            days: Math.abs(daysDiff),
                            regulation: regulation.code || 'N/A',
                            title: regulation.title || 'Norma',
                            itemIndex: parseInt(itemIdx),
                            dueDate: dueDateStr
                        });
                    } else if (daysDiff <= 30) {
                        reminders.push({
                            type: 'expiring',
                            days: daysDiff,
                            regulation: regulation.code || 'N/A',
                            title: regulation.title || 'Norma',
                            itemIndex: parseInt(itemIdx),
                            dueDate: dueDateStr
                        });
                    }
                });
            });
            
            if (reminders.length === 0) return null;
            
            // Sort: expired first, then by days remaining
            reminders.sort((a, b) => {
                if (a.type === 'expired' && b.type !== 'expired') return -1;
                if (a.type !== 'expired' && b.type === 'expired') return 1;
                return a.days - b.days;
            });
            
            let html = '<div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 20px; border-radius: 6px; margin-top: 20px;">';
            html += '<h3 style="color: #856404; margin-bottom: 15px;">üîî Lembretes e Itens Expirados</h3>';
            
            const expired = reminders.filter(r => r.type === 'expired');
            const expiring = reminders.filter(r => r.type === 'expiring');
            
            if (expired.length > 0) {
                html += '<div style="margin-bottom: 15px;">';
                html += `<strong style="color: #c33;">‚ö†Ô∏è Itens Expirados (${expired.length}):</strong>`;
                html += '<ul style="margin-top: 8px; padding-left: 20px;">';
                expired.forEach(r => {
                    html += `<li style="color: #c33; margin-bottom: 5px;">
                        <strong>${r.regulation}</strong>: Item expirado h√° ${r.days} dia(s) - Renovar at√© ${new Date(r.dueDate).toLocaleDateString('pt-BR')}
                    </li>`;
                });
                html += '</ul></div>';
            }
            
            if (expiring.length > 0) {
                html += '<div>';
                html += `<strong style="color: #856404;">‚è∞ Itens Expirando em Breve (${expiring.length}):</strong>`;
                html += '<ul style="margin-top: 8px; padding-left: 20px;">';
                expiring.forEach(r => {
                    html += `<li style="color: #856404; margin-bottom: 5px;">
                        <strong>${r.regulation}</strong>: Expira em ${r.days} dia(s) - Renovar at√© ${new Date(r.dueDate).toLocaleDateString('pt-BR')}
                    </li>`;
                });
                html += '</ul></div>';
            }
            
            html += '</div>';
            return html;
        }
        
        // Generate action plan
        function generateActionPlan(data) {
            const nonCompliant = data.compliance_records.filter(r => {
                const status = typeof r.status === 'string' ? r.status : (r.status?.value || 'pending_review');
                return status === 'non_compliant' || status === 'partial';
            });
            
            // Only show success message if ALL records are compliant (not just if there are no non-compliant)
            const allCompliant = data.compliance_records.length > 0 && 
                                 data.compliance_records.every(r => {
                                     const status = typeof r.status === 'string' ? r.status : (r.status?.value || 'pending_review');
                                     return status === 'compliant';
                                 });
            
            if (allCompliant && data.compliance_records.length > 0) {
                return '<p style="color: #10b981; font-weight: 500; padding: 15px; background: #d4edda; border-radius: 6px; margin-top: 20px;">‚úÖ Parab√©ns! Todas as normas est√£o em conformidade.</p>';
            }
            
            // Only show action plan if there are non-compliant or partial records
            if (nonCompliant.length === 0) {
                return ''; // Don't show action plan if there are no non-compliant records
            }
            
            let planHtml = '<div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 20px; border-radius: 6px; margin-top: 20px;">';
            planHtml += '<h3 style="color: #856404; margin-bottom: 15px;">üìã Plano de A√ß√£o Priorit√°rio</h3>';
            planHtml += '<p style="color: #856404; margin-bottom: 15px;">Baseado nas normas n√£o conformes ou parciais, aqui est√° o que precisa ser feito:</p>';
            planHtml += '<ol style="color: #856404; padding-left: 20px;">';
            
            nonCompliant.forEach((record, idx) => {
                const regulation = record.regulation || {};
                const status = typeof record.status === 'string' ? record.status : (record.status?.value || 'pending_review');
                const statusText = status === 'non_compliant' ? 'N√ÉO CONFORME' : 'PARCIAL';
                
                planHtml += `<li style="margin-bottom: 15px;">`;
                planHtml += `<strong>${regulation.code || 'N/A'}: ${regulation.title || 'Norma'}</strong> <span style="color: #ef4444;">(${statusText})</span><br>`;
                
                // Get action items
                let actionItems = [];
                if (record.action_items) {
                    try {
                        actionItems = typeof record.action_items === 'string' 
                            ? JSON.parse(record.action_items) 
                            : record.action_items;
                        if (!Array.isArray(actionItems)) actionItems = [];
                    } catch (e) {
                        actionItems = [];
                    }
                }
                
                if (actionItems.length > 0) {
                    planHtml += '<ul style="margin-top: 8px; padding-left: 20px;">';
                    actionItems.forEach(item => {
                        planHtml += `<li style="margin-bottom: 5px;">${item}</li>`;
                    });
                    planHtml += '</ul>';
                } else {
                    planHtml += `<span style="color: #666;">${regulation.requirements || 'Revisar requisitos da norma'}</span>`;
                }
                
                planHtml += `</li>`;
            });
            
            planHtml += '</ol>';
            planHtml += '</div>';
            
            return planHtml;
        }
        
        // Initialize
        loadAirports();
        // ============================================
        // FASE 3 - FUNCIONALIDADES AVAN√áADAS
        // ============================================
        
        // Tour Guide System
        let currentTourStep = 0;
        const tourSteps = [
            {
                title: 'Bem-vindo ao Sistema!',
                description: 'Este √© o sistema de conformidade ANAC. Vamos fazer um tour r√°pido para voc√™ conhecer as funcionalidades principais.',
                element: 'header',
                position: 'bottom'
            },
            {
                title: 'Gerenciar Aeroportos',
                description: 'Na primeira aba, voc√™ pode cadastrar e gerenciar seus aeroportos. O formul√°rio est√° organizado em se√ß√µes para facilitar o preenchimento.',
                element: '.tab:first-child',
                position: 'bottom'
            },
            {
                title: 'Verificar Conformidade',
                description: 'Na segunda aba, voc√™ pode verificar a conformidade de um aeroporto. O sistema mostrar√° todas as normas aplic√°veis baseadas nas caracter√≠sticas do aeroporto.',
                element: '.tab:last-child',
                position: 'bottom'
            },
            {
                title: 'Filtros e Busca',
                description: 'Use os filtros e a busca para encontrar normas espec√≠ficas rapidamente. O autocomplete ajuda a encontrar normas pelo c√≥digo.',
                element: '.filters-container',
                position: 'bottom'
            },
            {
                title: 'Checklist Interativo',
                description: 'Marque cada norma como conforme, parcial ou n√£o conforme. O sistema gerar√° automaticamente um plano de a√ß√£o.',
                element: '.compliance-item:first-child',
                position: 'top'
            }
        ];
        
        function startTour() {
            currentTourStep = 0;
            if (tourSteps.length === 0) {
                showToast('Tour n√£o dispon√≠vel no momento', 'info');
                return;
            }
            showTourStep(0);
        }
        
        function showTourStep(stepIndex) {
            if (stepIndex >= tourSteps.length) {
                endTour();
                return;
            }
            
            const step = tourSteps[stepIndex];
            const element = document.querySelector(step.element);
            
            if (!element) {
                // Skip this step if element not found
                showTourStep(stepIndex + 1);
                return;
            }
            
            // Show overlay
            document.getElementById('tourOverlay').classList.add('active');
            
            // Highlight element
            element.classList.add('tour-highlight');
            
            // Position popup
            const popup = document.getElementById('tourPopup');
            const rect = element.getBoundingClientRect();
            popup.classList.add('active');
            
            document.getElementById('tourTitle').textContent = step.title;
            document.getElementById('tourDescription').textContent = step.description;
            
            // Update button text
            const nextBtn = popup.querySelector('.tour-btn-primary');
            if (stepIndex === tourSteps.length - 1) {
                nextBtn.textContent = 'Finalizar';
            } else {
                nextBtn.textContent = 'Pr√≥ximo';
            }
        }
        
        function nextTourStep() {
            const currentElement = document.querySelector(tourSteps[currentTourStep].element);
            if (currentElement) {
                currentElement.classList.remove('tour-highlight');
            }
            
            currentTourStep++;
            if (currentTourStep < tourSteps.length) {
                showTourStep(currentTourStep);
            } else {
                endTour();
            }
        }
        
        function skipTour() {
            endTour();
            // Save that user skipped tour
            localStorage.setItem('tourSkipped', 'true');
        }
        
        function endTour() {
            document.getElementById('tourOverlay').classList.remove('active');
            document.getElementById('tourPopup').classList.remove('active');
            document.querySelectorAll('.tour-highlight').forEach(el => el.classList.remove('tour-highlight'));
            currentTourStep = 0;
            localStorage.setItem('tourCompleted', 'true');
        }
        
        // Check if tour should auto-start (first visit)
        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            // Load manage airports tab by default
            loadAirports();
            const tourCompleted = localStorage.getItem('tourCompleted');
            const tourSkipped = localStorage.getItem('tourSkipped');
            if (!tourCompleted && !tourSkipped) {
                // Auto-start tour after 2 seconds
                setTimeout(() => {
                    if (confirm('Bem-vindo! Deseja fazer um tour guiado do sistema?')) {
                        startTour();
                    } else {
                        localStorage.setItem('tourSkipped', 'true');
                    }
                }, 2000);
            }
        });
        
        // Batch Edit Mode
        let batchEditMode = false;
        let selectedRecords = new Set();
        
        function toggleBatchEdit() {
            batchEditMode = !batchEditMode;
            const banner = document.getElementById('batchEditBanner');
            const checkboxes = document.querySelectorAll('.batch-checkbox');
            const btn = document.getElementById('batchEditBtn');
            
            if (batchEditMode) {
                banner.style.display = 'block';
                checkboxes.forEach(cb => cb.style.display = 'block');
                if (btn) btn.textContent = '‚úñÔ∏è Sair do Modo Lote';
                selectedRecords.clear();
                updateBatchSelection();
            } else {
                banner.style.display = 'none';
                checkboxes.forEach(cb => cb.style.display = 'none');
                if (btn) btn.textContent = 'üìù Edi√ß√£o em Lote';
                document.querySelectorAll('.compliance-item').forEach(item => {
                    item.classList.remove('batch-selected');
                });
                document.querySelectorAll('input[type="checkbox"][id^="batch-select-"]').forEach(cb => {
                    cb.checked = false;
                });
                selectedRecords.clear();
            }
        }
        
        function selectAllForBatch() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"][id^="batch-select-"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(cb => {
                cb.checked = !allChecked;
                const recordId = parseInt(cb.id.replace('batch-select-', ''));
                if (!allChecked) {
                    selectedRecords.add(recordId);
                } else {
                    selectedRecords.delete(recordId);
                }
            });
            
            updateBatchSelection();
        }
        
        function updateBatchSelection() {
            selectedRecords.clear();
            document.querySelectorAll('input[type="checkbox"][id^="batch-select-"]:checked').forEach(cb => {
                const recordId = parseInt(cb.id.replace('batch-select-', ''));
                selectedRecords.add(recordId);
                const item = document.getElementById(`record-${recordId}`);
                if (item) item.classList.add('batch-selected');
            });
            
            document.querySelectorAll('.compliance-item').forEach(item => {
                const recordId = parseInt(item.dataset.recordId);
                if (!selectedRecords.has(recordId)) {
                    item.classList.remove('batch-selected');
                }
            });
            
            const countDiv = document.getElementById('batchSelectedCount');
            if (countDiv) {
                countDiv.textContent = `${selectedRecords.size} norma(s) selecionada(s)`;
            }
        }
        
        async function batchUpdateStatus(status) {
            if (selectedRecords.size === 0) {
                showToast('Selecione pelo menos uma norma', 'warning');
                return;
            }
            
            const confirmed = confirm(`Tem certeza que deseja marcar ${selectedRecords.size} norma(s) como "${getStatusLabel(status)}"?`);
            if (!confirmed) return;
            
            const updates = Array.from(selectedRecords).map(recordId => 
                fetch(`${API_BASE}/compliance/records/${recordId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: status })
                })
            );
            
            try {
                await Promise.all(updates);
                showToast(`${selectedRecords.size} norma(s) atualizada(s) com sucesso!`, 'success');
                
                // Refresh compliance
                const airportId = document.getElementById('airportSelect').value;
                if (airportId) {
                    await checkCompliance(airportId);
                }
                
                toggleBatchEdit();
            } catch (error) {
                showToast('Erro ao atualizar normas em lote', 'error');
            }
        }
        
        function getStatusLabel(status) {
            const labels = {
                'compliant': 'Conforme',
                'partial': 'Parcial',
                'non_compliant': 'N√£o Conforme',
                'pending_review': 'Pendente'
            };
            return labels[status] || status;
        }
        
        // Export Report
        async function exportReport() {
            const airportId = document.getElementById('airportSelect').value;
            if (!airportId) {
                showToast('Selecione um aeroporto primeiro', 'warning');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/compliance/check`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ airport_id: parseInt(airportId) })
                });
                
                if (!response.ok) throw new Error('Erro ao obter dados');
                
                const data = await response.json();
                const airportResponse = await fetch(`${API_BASE}/airports/${airportId}`);
                const airport = await airportResponse.json();
                
                // Helper functions
                function getFunctionalArea(code) {
                    if (!code || !code.startsWith('RBAC-153')) return null;
                    const areaMap = {
                        'RBAC-153-01': 'Gest√£o da CAT', 'RBAC-153-02': 'Gest√£o da CAT',
                        'RBAC-153-03': 'Gest√£o de Equipamentos', 'RBAC-153-04': 'Gest√£o de Equipamentos',
                        'RBAC-153-05': 'Gest√£o de Equipamentos', 'RBAC-153-09': 'Gest√£o de Equipamentos',
                        'RBAC-153-06': 'Gest√£o de Recursos Humanos', 'RBAC-153-08': 'Gest√£o de Recursos Humanos',
                        'RBAC-153-10': 'Gest√£o de Recursos Humanos',
                        'RBAC-153-07': 'Gest√£o Operacional', 'RBAC-153-11': 'Gest√£o Operacional',
                        'RBAC-153-12': 'Gest√£o de Infraestrutura', 'RBAC-153-13': 'Gest√£o de Infraestrutura',
                        'RBAC-153-14': 'Gest√£o de Documenta√ß√£o'
                    };
                    return areaMap[code] || null;
                }
                
                function getAreaName(safetyCategory) {
                    const categoryMap = {
                        'operational_safety': 'Seguran√ßa Operacional',
                        'fire_safety': 'Seguran√ßa contra Inc√™ndio',
                        'security': 'Seguran√ßa (AVSEC)',
                        'infrastructure': 'Infraestrutura',
                        'emergency_response': 'Resposta a Emerg√™ncias',
                        'environmental': 'Meio Ambiente',
                        'wildlife_management': 'Gerenciamento de Fauna',
                        'maintenance': 'Manuten√ß√£o',
                        'personnel_certification': 'Certifica√ß√£o de Pessoal',
                        'air_traffic_services': 'Servi√ßos de Tr√°fego A√©reo'
                    };
                    let categoryStr = safetyCategory;
                    if (typeof safetyCategory !== 'string' && safetyCategory?.value) {
                        categoryStr = safetyCategory.value;
                    } else if (typeof safetyCategory !== 'string') {
                        categoryStr = String(safetyCategory);
                    }
                    return categoryMap[categoryStr] || 'Outros';
                }
                
                function getRBACNumber(code) {
                    if (!code) return 'RBAC-154';
                    if (code.startsWith('RBAC-153')) return 'RBAC-153';
                    if (code.startsWith('RBAC-154')) return 'RBAC-154';
                    return 'RBAC-154';
                }
                
                // Group records by RBAC and area
                const groupedRecords = {
                    'RBAC-153': {},
                    'RBAC-154': {}
                };
                
                data.compliance_records.forEach(record => {
                    const regulation = record.regulation || {};
                    const code = regulation.code || '';
                    const rbacNumber = getRBACNumber(code);
                    
                    let areaName;
                    if (rbacNumber === 'RBAC-153') {
                        areaName = getFunctionalArea(code) || 'Outros';
                    } else {
                        let safetyCategory = regulation.safety_category;
                        if (typeof safetyCategory !== 'string' && safetyCategory?.value) {
                            safetyCategory = safetyCategory.value;
                        } else if (typeof safetyCategory !== 'string') {
                            safetyCategory = String(safetyCategory);
                        }
                        areaName = getAreaName(safetyCategory);
                    }
                    
                    if (!groupedRecords[rbacNumber][areaName]) {
                        groupedRecords[rbacNumber][areaName] = [];
                    }
                    groupedRecords[rbacNumber][areaName].push(record);
                });
                
                // Generate Excel-like HTML table
                let html = `
                    <html>
                    <head>
                        <meta charset="utf-8">
                        <style>
                            body { font-family: Arial, sans-serif; }
                            table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
                            th { background-color: #1e40af; color: white; padding: 12px; text-align: left; font-weight: bold; border: 1px solid #1e3a8a; }
                            td { padding: 8px; border: 1px solid #d1d5db; }
                            .rbac-header { background-color: #3b82f6; color: white; font-weight: bold; font-size: 14px; }
                            .area-header { background-color: #dbeafe; font-weight: bold; font-size: 13px; }
                            .compliant { background-color: #d4edda; }
                            .non-compliant { background-color: #f8d7da; }
                            .partial { background-color: #fff3cd; }
                            .pending { background-color: #e9ecef; }
                        </style>
                    </head>
                    <body>
                        <h1>Relat√≥rio de Conformidade - ${airport.name} (${airport.code})</h1>
                        <p><strong>Data de Exporta√ß√£o:</strong> ${new Date().toLocaleString('pt-BR')}</p>
                        <p><strong>Total de Normas:</strong> ${data.total_regulations} | 
                           <strong>Conformes:</strong> ${data.compliant_count} | 
                           <strong>N√£o Conformes:</strong> ${data.non_compliant_count} | 
                           <strong>Parciais:</strong> ${data.partial_count} | 
                           <strong>Pendentes:</strong> ${data.pending_count}</p>
                `;
                
                // RBAC-153 Section
                if (groupedRecords['RBAC-153'] && Object.keys(groupedRecords['RBAC-153']).length > 0) {
                    html += '<h2>RBAC-153 - Servi√ßo de Salvamento e Combate a Inc√™ndio (SESCINC)</h2>';
                    
                    const areaOrder = [
                        'Gest√£o da CAT', 'Gest√£o de Equipamentos', 'Gest√£o de Recursos Humanos',
                        'Gest√£o Operacional', 'Gest√£o de Infraestrutura', 'Gest√£o de Documenta√ß√£o'
                    ];
                    
                    areaOrder.forEach(areaName => {
                        const areaRecords = groupedRecords['RBAC-153'][areaName];
                        if (!areaRecords || areaRecords.length === 0) return;
                        
                        html += `<h3>${areaName} (${areaRecords.length} norma${areaRecords.length > 1 ? 's' : ''})</h3>`;
                        html += '<table>';
                        html += '<thead><tr><th>C√≥digo</th><th>Norma</th><th>Status</th><th>Classifica√ß√£o</th><th>Refer√™ncia ANAC</th><th>Itens de A√ß√£o</th><th>Completos</th><th>Notas</th></tr></thead><tbody>';
                        
                        areaRecords.forEach(record => {
                            const reg = record.regulation || {};
                            const status = typeof record.status === 'string' ? record.status : (record.status?.value || 'pending_review');
                            const classification = reg.requirement_classification?.value || reg.requirement_classification || '';
                            const actionItems = record.action_items ? (Array.isArray(record.action_items) ? record.action_items : JSON.parse(record.action_items)) : [];
                            const completed = record.completed_action_items ? (Array.isArray(record.completed_action_items) ? record.completed_action_items : JSON.parse(record.completed_action_items)) : [];
                            
                            const statusClass = {
                                'compliant': 'compliant',
                                'non_compliant': 'non-compliant',
                                'partial': 'partial',
                                'pending_review': 'pending'
                            }[status] || 'pending';
                            
                            html += `<tr class="${statusClass}">`;
                            html += `<td>${reg.code || ''}</td>`;
                            html += `<td>${reg.title || ''}</td>`;
                            html += `<td>${status}</td>`;
                            html += `<td>${classification}</td>`;
                            html += `<td>${reg.anac_reference || ''}</td>`;
                            html += `<td>${actionItems.length}</td>`;
                            html += `<td>${completed.length}</td>`;
                            html += `<td>${(record.notes || '').substring(0, 100)}${(record.notes || '').length > 100 ? '...' : ''}</td>`;
                            html += '</tr>';
                        });
                        
                        html += '</tbody></table>';
                    });
                }
                
                // RBAC-154 Section
                if (groupedRecords['RBAC-154'] && Object.keys(groupedRecords['RBAC-154']).length > 0) {
                    html += '<h2>RBAC-154 - Normas Gerais de Opera√ß√£o de Aer√≥dromos Civis</h2>';
                    
                    Object.keys(groupedRecords['RBAC-154']).forEach(areaName => {
                        const areaRecords = groupedRecords['RBAC-154'][areaName];
                        if (!areaRecords || areaRecords.length === 0) return;
                        
                        html += `<h3>${areaName} (${areaRecords.length} norma${areaRecords.length > 1 ? 's' : ''})</h3>`;
                        html += '<table>';
                        html += '<thead><tr><th>C√≥digo</th><th>Norma</th><th>Status</th><th>Classifica√ß√£o</th><th>Refer√™ncia ANAC</th><th>Itens de A√ß√£o</th><th>Completos</th><th>Notas</th></tr></thead><tbody>';
                        
                        areaRecords.forEach(record => {
                            const reg = record.regulation || {};
                            const status = typeof record.status === 'string' ? record.status : (record.status?.value || 'pending_review');
                            const classification = reg.requirement_classification?.value || reg.requirement_classification || '';
                            const actionItems = record.action_items ? (Array.isArray(record.action_items) ? record.action_items : JSON.parse(record.action_items)) : [];
                            const completed = record.completed_action_items ? (Array.isArray(record.completed_action_items) ? record.completed_action_items : JSON.parse(record.completed_action_items)) : [];
                            
                            const statusClass = {
                                'compliant': 'compliant',
                                'non_compliant': 'non-compliant',
                                'partial': 'partial',
                                'pending_review': 'pending'
                            }[status] || 'pending';
                            
                            html += `<tr class="${statusClass}">`;
                            html += `<td>${reg.code || ''}</td>`;
                            html += `<td>${reg.title || ''}</td>`;
                            html += `<td>${status}</td>`;
                            html += `<td>${classification}</td>`;
                            html += `<td>${reg.anac_reference || ''}</td>`;
                            html += `<td>${actionItems.length}</td>`;
                            html += `<td>${completed.length}</td>`;
                            html += `<td>${(record.notes || '').substring(0, 100)}${(record.notes || '').length > 100 ? '...' : ''}</td>`;
                            html += '</tr>';
                        });
                        
                        html += '</tbody></table>';
                    });
                }
                
                html += '</body></html>';
                
                // Create and download file
                const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `relatorio_conformidade_${airport.code}_${new Date().toISOString().split('T')[0]}.xls`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showToast('Relat√≥rio Excel exportado com sucesso!', 'success');
            } catch (error) {
                showToast('Erro ao exportar relat√≥rio', 'error');
                console.error(error);
            }
        }
        
        // Export area report
        async function exportAreaReport(areaName) {
            const airportId = document.getElementById('airportSelect')?.value;
            if (!airportId) {
                showToast('Selecione um aeroporto primeiro', 'warning');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/compliance/check`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ airport_id: parseInt(airportId) })
                });
                
                if (!response.ok) throw new Error('Erro ao obter dados');
                
                const data = await response.json();
                const airportResponse = await fetch(`${API_BASE}/airports/${airportId}`);
                const airport = await airportResponse.json();
                
                // Filter records by area
                function getFunctionalArea(code) {
                    if (!code || !code.startsWith('RBAC-153')) return null;
                    const areaMap = {
                        'RBAC-153-01': 'Gest√£o da CAT', 'RBAC-153-02': 'Gest√£o da CAT',
                        'RBAC-153-03': 'Gest√£o de Equipamentos', 'RBAC-153-04': 'Gest√£o de Equipamentos',
                        'RBAC-153-05': 'Gest√£o de Equipamentos', 'RBAC-153-09': 'Gest√£o de Equipamentos',
                        'RBAC-153-06': 'Gest√£o de Recursos Humanos', 'RBAC-153-08': 'Gest√£o de Recursos Humanos',
                        'RBAC-153-10': 'Gest√£o de Recursos Humanos',
                        'RBAC-153-07': 'Gest√£o Operacional', 'RBAC-153-11': 'Gest√£o Operacional',
                        'RBAC-153-12': 'Gest√£o de Infraestrutura', 'RBAC-153-13': 'Gest√£o de Infraestrutura',
                        'RBAC-153-14': 'Gest√£o de Documenta√ß√£o'
                    };
                    return areaMap[code] || null;
                }
                
                const areaRecords = data.compliance_records.filter(record => {
                    const code = record.regulation?.code || '';
                    return getFunctionalArea(code) === areaName;
                });
                
                if (areaRecords.length === 0) {
                    showToast(`Nenhuma norma encontrada para a √°rea ${areaName}`, 'warning');
                    return;
                }
                
                // Generate Excel-like HTML table
                let html = `
                    <html>
                    <head>
                        <meta charset="utf-8">
                        <style>
                            body { font-family: Arial, sans-serif; }
                            table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
                            th { background-color: #1e40af; color: white; padding: 12px; text-align: left; font-weight: bold; border: 1px solid #1e3a8a; }
                            td { padding: 8px; border: 1px solid #d1d5db; }
                            .compliant { background-color: #d4edda; }
                            .non-compliant { background-color: #f8d7da; }
                            .partial { background-color: #fff3cd; }
                            .pending { background-color: #e9ecef; }
                        </style>
                    </head>
                    <body>
                        <h1>Relat√≥rio de Conformidade - ${areaName}</h1>
                        <p><strong>Aeroporto:</strong> ${airport.name} (${airport.code})</p>
                        <p><strong>Data de Exporta√ß√£o:</strong> ${new Date().toLocaleString('pt-BR')}</p>
                        <p><strong>Total de Normas na √Årea:</strong> ${areaRecords.length}</p>
                        <table>
                            <thead>
                                <tr>
                                    <th>C√≥digo</th>
                                    <th>Norma</th>
                                    <th>Status</th>
                                    <th>Classifica√ß√£o</th>
                                    <th>Refer√™ncia ANAC</th>
                                    <th>Itens de A√ß√£o</th>
                                    <th>Completos</th>
                                    <th>Notas</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                areaRecords.forEach(record => {
                    const reg = record.regulation || {};
                    const status = typeof record.status === 'string' ? record.status : (record.status?.value || 'pending_review');
                    const classification = reg.requirement_classification?.value || reg.requirement_classification || '';
                    const actionItems = record.action_items ? (Array.isArray(record.action_items) ? record.action_items : JSON.parse(record.action_items)) : [];
                    const completed = record.completed_action_items ? (Array.isArray(record.completed_action_items) ? record.completed_action_items : JSON.parse(record.completed_action_items)) : [];
                    
                    const statusClass = {
                        'compliant': 'compliant',
                        'non_compliant': 'non-compliant',
                        'partial': 'partial',
                        'pending_review': 'pending'
                    }[status] || 'pending';
                    
                    html += `<tr class="${statusClass}">`;
                    html += `<td>${reg.code || ''}</td>`;
                    html += `<td>${reg.title || ''}</td>`;
                    html += `<td>${status}</td>`;
                    html += `<td>${classification}</td>`;
                    html += `<td>${reg.anac_reference || ''}</td>`;
                    html += `<td>${actionItems.length}</td>`;
                    html += `<td>${completed.length}</td>`;
                    html += `<td>${(record.notes || '').substring(0, 100)}${(record.notes || '').length > 100 ? '...' : ''}</td>`;
                    html += '</tr>';
                });
                
                html += '</tbody></table></body></html>';
                
                // Create and download file
                const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `relatorio_${areaName.replace(/\s+/g, '_')}_${airport.code}_${new Date().toISOString().split('T')[0]}.xls`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showToast(`Relat√≥rio da √°rea ${areaName} exportado com sucesso!`, 'success');
            } catch (error) {
                showToast('Erro ao exportar relat√≥rio da √°rea', 'error');
                console.error(error);
            }
        }
        
        // Generate PDF report for area
        async function generateAreaReport(areaName) {
            const airportId = document.getElementById('airportSelect')?.value;
            if (!airportId) {
                showToast('Selecione um aeroporto primeiro', 'warning');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/compliance/check`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ airport_id: parseInt(airportId) })
                });
                
                if (!response.ok) throw new Error('Erro ao obter dados');
                
                const data = await response.json();
                const airportResponse = await fetch(`${API_BASE}/airports/${airportId}`);
                const airport = await airportResponse.json();
                
                // Filter records by area
                function getFunctionalArea(code) {
                    if (!code || !code.startsWith('RBAC-153')) return null;
                    const areaMap = {
                        'RBAC-153-01': 'Gest√£o da CAT', 'RBAC-153-02': 'Gest√£o da CAT',
                        'RBAC-153-03': 'Gest√£o de Equipamentos', 'RBAC-153-04': 'Gest√£o de Equipamentos',
                        'RBAC-153-05': 'Gest√£o de Equipamentos', 'RBAC-153-09': 'Gest√£o de Equipamentos',
                        'RBAC-153-06': 'Gest√£o de Recursos Humanos', 'RBAC-153-08': 'Gest√£o de Recursos Humanos',
                        'RBAC-153-10': 'Gest√£o de Recursos Humanos',
                        'RBAC-153-07': 'Gest√£o Operacional', 'RBAC-153-11': 'Gest√£o Operacional',
                        'RBAC-153-12': 'Gest√£o de Infraestrutura', 'RBAC-153-13': 'Gest√£o de Infraestrutura',
                        'RBAC-153-14': 'Gest√£o de Documenta√ß√£o'
                    };
                    return areaMap[code] || null;
                }
                
                const areaRecords = data.compliance_records.filter(record => {
                    const code = record.regulation?.code || '';
                    return getFunctionalArea(code) === areaName;
                });
                
                if (areaRecords.length === 0) {
                    showToast(`Nenhuma norma encontrada para a √°rea ${areaName}`, 'warning');
                    return;
                }
                
                // Calculate statistics
                const total = areaRecords.length;
                const compliant = areaRecords.filter(r => {
                    const status = typeof r.status === 'string' ? r.status : (r.status?.value || '');
                    return status === 'compliant';
                }).length;
                const nonCompliant = areaRecords.filter(r => {
                    const status = typeof r.status === 'string' ? r.status : (r.status?.value || '');
                    return status === 'non_compliant';
                }).length;
                const partial = areaRecords.filter(r => {
                    const status = typeof r.status === 'string' ? r.status : (r.status?.value || '');
                    return status === 'partial';
                }).length;
                const pending = areaRecords.filter(r => {
                    const status = typeof r.status === 'string' ? r.status : (r.status?.value || '');
                    return status === 'pending_review';
                }).length;
                
                const compliancePercentage = total > 0 ? Math.round((compliant / total) * 100) : 0;
                
                // Generate HTML report
                let html = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="utf-8">
                        <title>Relat√≥rio de Conformidade - ${areaName}</title>
                        <style>
                            @media print {
                                @page { margin: 2cm; }
                                body { margin: 0; }
                            }
                            body {
                                font-family: Arial, sans-serif;
                                margin: 20px;
                                color: #333;
                            }
                            .header {
                                border-bottom: 3px solid #1e40af;
                                padding-bottom: 20px;
                                margin-bottom: 30px;
                            }
                            .header h1 {
                                color: #1e40af;
                                margin: 0 0 10px 0;
                            }
                            .header-info {
                                display: grid;
                                grid-template-columns: repeat(2, 1fr);
                                gap: 20px;
                                margin-top: 15px;
                            }
                            .stats {
                                display: grid;
                                grid-template-columns: repeat(4, 1fr);
                                gap: 15px;
                                margin: 30px 0;
                            }
                            .stat-box {
                                padding: 15px;
                                border-radius: 8px;
                                text-align: center;
                            }
                            .stat-box.compliant { background: #d4edda; border: 2px solid #10b981; }
                            .stat-box.non-compliant { background: #f8d7da; border: 2px solid #ef4444; }
                            .stat-box.partial { background: #fff3cd; border: 2px solid #f59e0b; }
                            .stat-box.pending { background: #e9ecef; border: 2px solid #6b7280; }
                            .stat-number {
                                font-size: 32px;
                                font-weight: bold;
                                margin-bottom: 5px;
                            }
                            .stat-label {
                                font-size: 14px;
                                color: #666;
                            }
                            table {
                                width: 100%;
                                border-collapse: collapse;
                                margin: 20px 0;
                            }
                            th {
                                background: #1e40af;
                                color: white;
                                padding: 12px;
                                text-align: left;
                                font-weight: bold;
                            }
                            td {
                                padding: 10px;
                                border: 1px solid #ddd;
                            }
                            tr:nth-child(even) {
                                background: #f8f9fa;
                            }
                            .status-badge {
                                padding: 4px 12px;
                                border-radius: 12px;
                                font-size: 12px;
                                font-weight: 600;
                            }
                            .status-compliant { background: #d4edda; color: #155724; }
                            .status-non-compliant { background: #f8d7da; color: #721c24; }
                            .status-partial { background: #fff3cd; color: #856404; }
                            .status-pending { background: #e9ecef; color: #495057; }
                            .footer {
                                margin-top: 40px;
                                padding-top: 20px;
                                border-top: 1px solid #ddd;
                                text-align: center;
                                color: #666;
                                font-size: 12px;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>Relat√≥rio de Conformidade - ${areaName}</h1>
                            <div class="header-info">
                                <div>
                                    <strong>Aeroporto:</strong> ${airport.name} (${airport.code})<br>
                                    <strong>Classe por Uso:</strong> ${airport.usage_class ? (airport.usage_class === 'PRIVADO' ? 'Privado' : `Classe ${airport.usage_class}`) : 'N/A'}<br>
                                    <strong>AVSEC:</strong> ${airport.avsec_classification || 'N/A'}<br>
                                    <strong>Porte Aeronave:</strong> ${airport.aircraft_size_category || 'N/A'}<br>
                                    <strong>C√≥digo de Refer√™ncia das Aeronaves:</strong> ${airport.reference_code || 'N/A'}
                                </div>
                                <div>
                                    <strong>Data do Relat√≥rio:</strong> ${new Date().toLocaleString('pt-BR')}<br>
                                    <strong>Total de Normas:</strong> ${total}<br>
                                    <strong>Percentual de Conformidade:</strong> ${compliancePercentage}%
                                </div>
                            </div>
                        </div>
                        
                        <div class="stats">
                            <div class="stat-box compliant">
                                <div class="stat-number">${compliant}</div>
                                <div class="stat-label">Conformes</div>
                            </div>
                            <div class="stat-box non-compliant">
                                <div class="stat-number">${nonCompliant}</div>
                                <div class="stat-label">N√£o Conformes</div>
                            </div>
                            <div class="stat-box partial">
                                <div class="stat-number">${partial}</div>
                                <div class="stat-label">Parciais</div>
                            </div>
                            <div class="stat-box pending">
                                <div class="stat-number">${pending}</div>
                                <div class="stat-label">Pendentes</div>
                            </div>
                        </div>
                        
                        <h2>Detalhamento das Normas</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>C√≥digo</th>
                                    <th>Norma</th>
                                    <th>Status</th>
                                    <th>Classifica√ß√£o</th>
                                    <th>Refer√™ncia ANAC</th>
                                    <th>Itens de A√ß√£o</th>
                                    <th>Completos</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                areaRecords.forEach(record => {
                    const reg = record.regulation || {};
                    const status = typeof record.status === 'string' ? record.status : (record.status?.value || 'pending_review');
                    const classification = reg.requirement_classification?.value || reg.requirement_classification || '';
                    const actionItems = record.action_items ? (Array.isArray(record.action_items) ? record.action_items : JSON.parse(record.action_items)) : [];
                    const completed = record.completed_action_items ? (Array.isArray(record.completed_action_items) ? record.completed_action_items : JSON.parse(record.completed_action_items)) : [];
                    
                    const statusLabels = {
                        'compliant': 'Conforme',
                        'non_compliant': 'N√£o Conforme',
                        'partial': 'Parcial',
                        'pending_review': 'Pendente'
                    };
                    
                    html += `
                        <tr>
                            <td><strong>${reg.code || ''}</strong></td>
                            <td>${reg.title || ''}</td>
                            <td><span class="status-badge status-${status}">${statusLabels[status] || status}</span></td>
                            <td>${classification}</td>
                            <td>${reg.anac_reference || ''}</td>
                            <td>${actionItems.length}</td>
                            <td>${completed.length}</td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                        
                        <div class="footer">
                            <p>Relat√≥rio gerado automaticamente pelo Sistema de Gest√£o de Conformidade ANAC</p>
                            <p>Data: ${new Date().toLocaleString('pt-BR')}</p>
                        </div>
                    </body>
                    </html>
                `;
                
                // Open in new window for printing
                const printWindow = window.open('', '_blank');
                printWindow.document.write(html);
                printWindow.document.close();
                
                // Wait for content to load, then print
                setTimeout(() => {
                    printWindow.print();
                }, 500);
                
                showToast(`Relat√≥rio PDF da √°rea ${areaName} gerado! Use Ctrl+P para imprimir.`, 'success');
            } catch (error) {
                showToast('Erro ao gerar relat√≥rio PDF', 'error');
                console.error(error);
            }
        }
        
        // Auto-save functionality
        let autoSaveTimeout;
        const AUTO_SAVE_DELAY = 2000; // 2 seconds
        
        function setupAutoSave() {
            const form = document.getElementById('airportForm');
            if (!form) return;
            
            const inputs = form.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.addEventListener('input', () => {
                    clearTimeout(autoSaveTimeout);
                    autoSaveTimeout = setTimeout(() => {
                        saveDraft();
                    }, AUTO_SAVE_DELAY);
                });
            });
        }
        
        function saveDraft() {
            const form = document.getElementById('airportForm');
            if (!form) return;
            
            const formData = {
                name: document.getElementById('name')?.value || '',
                code: document.getElementById('code')?.value || '',
                // size ser√° calculado automaticamente
                airport_type: document.getElementById('airport_type')?.value || '',
                usage_class: document.getElementById('usage_class')?.value || '',
                avsec_classification: document.getElementById('avsec_classification')?.value || '',
                aircraft_size_category: document.getElementById('aircraft_size_category')?.value || '',
                reference_code: document.getElementById('reference_code')?.value || '',
                // annual_passengers ser√° calculado automaticamente
                number_of_runways: document.getElementById('number_of_runways')?.value || '',
                max_aircraft_weight: document.getElementById('max_aircraft_weight')?.value || '',
                has_international_operations: document.getElementById('has_international_operations')?.checked || false,
                has_cargo_operations: document.getElementById('has_cargo_operations')?.checked || false,
                has_maintenance_facility: document.getElementById('has_maintenance_facility')?.checked || false
            };
            
            // Only save if there's meaningful data
            if (formData.name || formData.code) {
                localStorage.setItem('airportFormDraft', JSON.stringify(formData));
                showAutoSaveIndicator();
            }
        }
        
        function loadDraft() {
            const draft = localStorage.getItem('airportFormDraft');
            if (!draft) return;
            
            try {
                const formData = JSON.parse(draft);
                if (confirm('Encontramos um rascunho n√£o salvo. Deseja restaurar?')) {
                    if (formData.name) document.getElementById('name').value = formData.name;
                    if (formData.code) document.getElementById('code').value = formData.code;
                    // size √© calculado automaticamente, n√£o precisa ser restaurado
                    if (formData.airport_type) document.getElementById('airport_type').value = formData.airport_type;
                    if (formData.usage_class) document.getElementById('usage_class').value = formData.usage_class;
                    if (formData.avsec_classification) document.getElementById('avsec_classification').value = formData.avsec_classification;
                    if (formData.aircraft_size_category) document.getElementById('aircraft_size_category').value = formData.aircraft_size_category;
                    // Backward compatibility: if old category exists, try to convert
                    if (formData.category && !formData.usage_class) {
                        // Old category format (1C-9C) - can't directly convert, but we'll calculate from passengers
                        // Classifica√ß√µes ser√£o calculadas automaticamente quando usage_class for selecionado
                    }
                    if (formData.reference_code) document.getElementById('reference_code').value = formData.reference_code;
                    // annual_passengers √© calculado automaticamente, n√£o precisa ser restaurado
                    if (formData.number_of_runways) document.getElementById('number_of_runways').value = formData.number_of_runways;
                    if (formData.max_aircraft_weight) document.getElementById('max_aircraft_weight').value = formData.max_aircraft_weight;
                    if (formData.has_international_operations !== undefined) document.getElementById('has_international_operations').checked = formData.has_international_operations;
                    if (formData.has_cargo_operations !== undefined) document.getElementById('has_cargo_operations').checked = formData.has_cargo_operations;
                    if (formData.has_maintenance_facility !== undefined) document.getElementById('has_maintenance_facility').checked = formData.has_maintenance_facility;
                } else {
                    localStorage.removeItem('airportFormDraft');
                }
            } catch (e) {
                console.error('Error loading draft:', e);
            }
        }
        
        function showAutoSaveIndicator() {
            const indicator = document.getElementById('autoSaveIndicator');
            if (indicator) {
                indicator.classList.add('show');
                setTimeout(() => {
                    indicator.classList.remove('show');
                }, 2000);
            }
        }
        
        // Clear draft on successful save
        document.addEventListener('DOMContentLoaded', () => {
            setupAutoSave();
            loadDraft();
            
            // Clear draft when form is successfully submitted
            const form = document.getElementById('airportForm');
            if (form) {
                form.addEventListener('submit', async (e) => {
                    // Wait for successful submission (handled in existing code)
                    setTimeout(() => {
                        if (!document.getElementById('name').value && !document.getElementById('code').value) {
                            localStorage.removeItem('airportFormDraft');
                        }
                    }, 1000);
                });
            }
        });
        
        // Changes History (simple version - stores in localStorage)
        function logChange(recordId, field, oldValue, newValue, changedBy = 'Usu√°rio') {
            const history = JSON.parse(localStorage.getItem('complianceHistory') || '[]');
            history.push({
                recordId,
                field,
                oldValue,
                newValue,
                changedBy,
                timestamp: new Date().toISOString()
            });
            
            // Keep only last 100 changes
            if (history.length > 100) {
                history.shift();
            }
            
            localStorage.setItem('complianceHistory', JSON.stringify(history));
        }
        
        function showChangesHistory(recordId) {
            const history = JSON.parse(localStorage.getItem('complianceHistory') || '[]');
            const recordHistory = history.filter(h => h.recordId === recordId).slice(-10).reverse();
            
            if (recordHistory.length === 0) {
                showToast('Nenhum hist√≥rico encontrado para esta norma', 'info');
                return;
            }
            
            let html = '<div class="changes-log"><h4>Hist√≥rico de Mudan√ßas</h4>';
            recordHistory.forEach(change => {
                const date = new Date(change.timestamp);
                html += `
                    <div class="change-item">
                        <strong>${change.field}</strong>: "${change.oldValue}" ‚Üí "${change.newValue}"
                        <div class="change-time">${date.toLocaleString('pt-BR')} por ${change.changedBy}</div>
                    </div>
                `;
            });
            html += '</div>';
            
            // Show in a modal or append to record
            const recordElement = document.getElementById(`record-${recordId}`);
            if (recordElement) {
                const existingLog = recordElement.querySelector('.changes-log');
                if (existingLog) {
                    existingLog.remove();
                }
                recordElement.insertAdjacentHTML('beforeend', html);
            }
        }
        
        // Wrap updateComplianceStatus to add history logging
        const originalUpdateComplianceStatusFn = window.updateComplianceStatus;
        if (originalUpdateComplianceStatusFn) {
            window.updateComplianceStatus = async function(recordId, status) {
                // Get old status before update
                try {
                    const oldResponse = await fetch(`${API_BASE}/compliance/records/${recordId}`);
                    if (oldResponse.ok) {
                        const oldRecord = await oldResponse.json();
                        const oldStatus = typeof oldRecord.status === 'string' ? oldRecord.status : (oldRecord.status?.value || '');
                        
                        // Call original function
                        await originalUpdateComplianceStatusFn(recordId, status);
                        
                        // Log change if status changed
                        if (oldStatus !== status) {
                            logChange(recordId, 'status', oldStatus, status);
                        }
                    } else {
                        await originalUpdateComplianceStatusFn(recordId, status);
                    }
                } catch (e) {
                    // If error, still call original
                    await originalUpdateComplianceStatusFn(recordId, status);
                }
            };
        }
    </script>
</body>
</html>
